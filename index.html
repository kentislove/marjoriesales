<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“åˆ—è¡¨èˆ‡è³¼ç‰©è»Š</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&family=Noto+Serif+TC:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-font: 'Noto Serif TC', serif;
            --secondary-font: 'Noto Sans TC', sans-serif;
            --text-color: #333;
            --subtle-text-color: #777;
            --background-color: #f8f8f8;
            --card-background: #fff;
            --border-color: #e0e0e0;
            --accent-color: #000;
            --success-color: #4CAF50;
            --error-color: #f44336;
        }

        body {
            font-family: var(--secondary-font);
            margin: 0;
            padding: 30px 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* é é¢æ¨™é¡Œèˆ‡è³¼ç‰©è»Šåœ–ç¤ºå®¹å™¨ */
        #header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto 20px;
        }

        h1 {
            font-family: var(--primary-font);
            color: #1a1a1a;
            font-size: 2.5rem;
            margin: 0;
        }
        
        /* è³¼ç‰©è»Šåœ–ç¤ºæ¨£å¼ */
        #cart-icon {
            position: relative;
            cursor: pointer;
            padding: 10px;
            transition: color 0.3s;
        }

        #cart-icon:hover {
            color: var(--accent-color);
        }

        #cart-count {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--error-color);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            line-height: 1;
        }

        /* ä¸»å…§å®¹å®¹å™¨ */
        #main-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ç”¢å“åˆ—è¡¨èˆ‡ç¯©é¸æ¨£å¼ (ä¸è®Š) */
        #search-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #search-box {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            box-sizing: border-box;
            background-color: var(--card-background);
            color: var(--text-color);
        }

        #filters {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px;
            overflow-x: visible; 
            padding-bottom: 0;
        }
        
        @media (max-width: 768px) {
            #filters {
                justify-content: flex-start;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 5px 0 15px 0;
                margin-left: -20px;
                margin-right: -20px;
                padding-left: 20px;
                padding-right: 20px;
            }
            #filters::-webkit-scrollbar {
                display: none;
            }
            #filters {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            #header-container {
                flex-direction: column;
                align-items: center;
            }
            h1 {
                margin-bottom: 10px;
            }
        }
        
        .filter-tag {
            flex-shrink: 0;
            background-color: #fff;
            color: var(--subtle-text-color);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, color 0.3s;
            font-size: 14px;
        }
        
        .filter-tag:hover {
            background-color: var(--border-color);
        }
        
        .filter-tag.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        #product-list {
            display: grid;
            gap: 40px;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        /* ç”¢å“å¡ç‰‡è¦æ ¼é¸æ“‡å™¨æ¨£å¼ (æ–°å¢) */
        .product-card {
            background-color: var(--card-background);
            border-radius: 5px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.3s ease;
            /* cursor: pointer; */ /* ç§»é™¤ï¼Œå› ç‚ºæœ‰äº’å‹•å…ƒç´  */
        }

        .product-card:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .product-images {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
            cursor: pointer;
        }

        .product-images img {
            width: 100%;
            height: auto;
            object-fit: contain;
            transition: transform 0.5s ease;
        }

        .product-info {
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .product-info h2 {
            font-family: var(--primary-font);
            margin-top: 0;
            color: #1a1a1a;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .product-info p {
            margin: 5px 0;
            line-height: 1.6;
        }
        
        .product-info .price {
            font-size: 1.2rem;
            color: var(--error-color);
            font-weight: 500;
            margin-bottom: 10px;
        }

        .spec-selector {
            margin: 15px 0;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .spec-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .spec-selector select, .spec-selector input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            box-sizing: border-box;
        }

        .spec-selector button {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .spec-selector button:hover {
            background-color: #333;
        }

        .stock-info {
            font-size: 14px;
            color: var(--subtle-text-color);
            margin-top: -5px;
            margin-bottom: 10px;
            min-height: 1.6em; /* é˜²æ­¢å…§å®¹é–ƒçˆ */
        }
        
        .out-of-stock {
            color: var(--error-color);
            font-weight: 500;
        }

        /* å½ˆå‡ºè¦–çª— Lightbox & Modal æ¨£å¼ (æ–°å¢/ä¿®æ”¹) */
        .modal-overlay, .lightbox-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto; /* å…è¨±å‚ç›´æ»¾å‹• */
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            align-items: flex-start; /* è®“æ¨¡æ…‹æ¡†é è¿‘é ‚éƒ¨ */
            padding-top: 5vh;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 5px;
            width: 90%;
            max-width: 700px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 20px;
            color: var(--subtle-text-color);
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--text-color);
        }
        
        /* è³¼ç‰©è»Šåˆ—è¡¨æ¨£å¼ */
        #cart-items-list {
            margin-top: 20px;
            list-style: none;
            padding: 0;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-info h4 {
            margin: 0 0 5px 0;
            font-family: var(--primary-font);
            font-size: 1.2rem;
        }
        
        .cart-item-info p {
            margin: 0;
            font-size: 14px;
            color: var(--subtle-text-color);
        }
        
        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .quantity-control input {
            width: 50px;
            text-align: center;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
        }
        
        .remove-btn {
            background: none;
            border: none;
            color: var(--error-color);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }
        
        #cart-total {
            text-align: right;
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid var(--border-color);
        }

        #checkout-button {
            width: 100%;
            padding: 15px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 18px;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        #checkout-button:hover {
            background-color: #45a049;
        }
        
        /* çµå¸³èªªæ˜é é¢æ¨£å¼ */
        #checkout-page {
            display: none; /* é è¨­éš±è— */
            padding: 40px 20px;
            background-color: var(--card-background);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 50vh;
        }

        #checkout-page h2 {
            font-family: var(--primary-font);
            font-size: 2rem;
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 30px;
        }

        #checkout-page ol {
            max-width: 600px;
            margin: 0 auto;
            padding-left: 20px;
            line-height: 2;
        }
        
        #checkout-page ol li {
            margin-bottom: 15px;
        }
        
        #checkout-page strong {
            color: var(--error-color);
        }
        
        .back-to-cart-btn {
            display: block;
            width: 200px;
            margin: 30px auto 0;
            padding: 12px;
            text-align: center;
            background-color: var(--subtle-text-color);
            color: white;
            border-radius: 3px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .back-to-cart-btn:hover {
            background-color: #555;
        }

        @media (max-width: 768px) {
            .modal-content {
                padding: 20px;
            }
            #checkout-page {
                padding: 20px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="header-container">
        <h1>ç”¢å“åˆ—è¡¨</h1>
        <div id="cart-icon">
            <i class="fas fa-shopping-cart fa-2x"></i>
            <span id="cart-count">0</span>
        </div>
    </div>
    
    <div id="main-content">
        <div id="product-page">
            <div id="search-container">
                <input type="text" id="search-box" placeholder="è¼¸å…¥ç”¢å“åç¨±æœå°‹...">
            </div>
            <div id="filters"></div>
            <div id="product-list">è¼‰å…¥ä¸­...</div>
        </div>
        
        <div id="checkout-page">
            <h2>ğŸ‰ è¨‚å–®ç¢ºèªèˆ‡ä»˜æ¬¾èªªæ˜</h2>
            <p style="text-align: center; font-size: 1.1rem; margin-bottom: 40px;">è«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿå®Œæˆæ‚¨çš„è¨‚å–®ï¼Œæˆ‘å€‘æœƒåœ¨æ”¶åˆ°æ¬¾é …å¾Œç›¡å¿«ç‚ºæ‚¨å‡ºè²¨ã€‚</p>
            <ol>
                <li><strong>ç¢ºèªè³¼ç‰©è»Šæ˜ç´°:</strong> è«‹å†æ¬¡æª¢æŸ¥æ‚¨åœ¨è³¼ç‰©è»Šä¸­æ‰€é¸çš„ç”¢å“ã€è¦æ ¼èˆ‡æ•¸é‡æ˜¯å¦æ­£ç¢ºã€‚</li>
                <li><strong>å¡«å¯«æ”¶ä»¶è³‡è¨Š:</strong> è«‹æ‚¨é€é **LINE**ã€**E-mail** æˆ–æ‚¨å¸¸ç”¨çš„ç¤¾ç¾¤è»Ÿé«” **ç§è¨Š** çµ¦æˆ‘å€‘ï¼Œæä¾›æ‚¨çš„**è¨‚å–®æ˜ç´°æˆªåœ–**ã€**æ”¶ä»¶äººå§“å**ã€**è¯çµ¡é›»è©±**ã€**å®Œæ•´æ”¶ä»¶åœ°å€**ã€‚</li>
                <li><strong>é€²è¡ŒåŒ¯æ¬¾:</strong> è«‹å°‡ç¸½é‡‘é¡åŒ¯æ¬¾è‡³æŒ‡å®šå¸³æˆ¶ï¼š
                    <ul>
                        <li>**éŠ€è¡Œåç¨±:** [æ‚¨çš„éŠ€è¡Œåç¨±]</li>
                        <li>**å¸³è™Ÿ:** [æ‚¨çš„éŠ€è¡Œå¸³è™Ÿï¼Œä¾‹å¦‚ï¼š1234-5678-901234]</li>
                        <li>**æˆ¶å:** [æ‚¨çš„æˆ¶å]</li>
                    </ul>
                    <p style="margin-top: 10px; font-size: 0.9em; color: var(--error-color);">**è«‹æ³¨æ„:** åŒ¯æ¬¾å®Œæˆå¾Œï¼Œè«‹å‹™å¿…æä¾›**å¸³è™Ÿå¾Œäº”ç¢¼**æˆ–**åŒ¯æ¬¾è­‰æ˜æˆªåœ–**çµ¦æˆ‘å€‘ä»¥ä¾›æ ¸å°ã€‚</p>
                </li>
                <li><strong>ç­‰å¾…ç¢ºèª:</strong> æˆ‘å€‘æœƒåœ¨æ”¶åˆ°æ‚¨çš„è³‡æ–™èˆ‡æ¬¾é …å¾Œï¼Œç™¼å‡ºè¨‚å–®ç¢ºèªé€šçŸ¥ï¼Œä¸¦å„˜é€Ÿå®‰æ’å‡ºè²¨ã€‚</li>
            </ol>
            <p style="text-align: center; margin-top: 40px;">æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼è‹¥æœ‰ä»»ä½•ç–‘å•ï¼Œæ­¡è¿éš¨æ™‚è¯ç¹«å®¢æœã€‚</p>
            <button class="back-to-cart-btn" onclick="showCartModal(event)">è¿”å›è³¼ç‰©è»Š</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="cart-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeCartModal()">&times;</span>
            <h2>æˆ‘çš„è³¼ç‰©è»Š</h2>
            <ul id="cart-items-list">
                </ul>
            <div id="cart-summary">
                <div id="cart-total">ç¸½è¨ˆ: NT$ <span id="total-amount">0</span></div>
                <button id="checkout-button">ç¢ºå®šè³¼è²·ï¼Œå‰å¾€çµå¸³</button>
            </div>
        </div>
    </div>

    <div class="lightbox-overlay" id="lightbox">
        <span class="close-btn">&times;</span>
        <span class="prev-btn">&#10094;</span>
        <div class="lightbox-container" id="lightbox-container">
            <div class="lightbox-content" id="lightbox-content">
            </div>
        </div>
        <span class="next-btn">&#10095;</span>
    </div>

    <script>
        const apiUrl = 'https://script.google.com/macros/s/AKfycbzco3oEMAXdl8w4PfhNj9KA1pzLKOkw3uLxTN9tkqlZfm4PV14gHMJ55rppw9jBWoQU/exec';
        const CART_STORAGE_KEY = 'shoppingCart';
        
        // DOM å…ƒç´ 
        const productListDiv = document.getElementById('product-list');
        const filtersDiv = document.getElementById('filters');
        const searchBox = document.getElementById('search-box');
        const cartIcon = document.getElementById('cart-icon');
        const cartCount = document.getElementById('cart-count');
        const cartModal = document.getElementById('cart-modal');
        const cartItemsList = document.getElementById('cart-items-list');
        const totalAmountSpan = document.getElementById('total-amount');
        const checkoutButton = document.getElementById('checkout-button');
        const productPage = document.getElementById('product-page');
        const checkoutPage = document.getElementById('checkout-page');
        const lightbox = document.getElementById('lightbox');
        const lightboxContent = document.getElementById('lightbox-content');
        const closeBtn = lightbox.querySelector('.close-btn');
        const prevBtn = document.querySelector('.prev-btn');
        const nextBtn = document.querySelector('.next-btn');

        // ç‹€æ…‹è®Šæ•¸
        let currentImageIndex = 0;
        let lightboxImages = [];
        let allProductsData = {};
        let activeCategory = 'all';
        let cart = loadCartFromStorage(); // å¾æœ¬åœ°å„²å­˜è¼‰å…¥è³¼ç‰©è»Š

        // --- è³¼ç‰©è»Šèˆ‡é é¢ç®¡ç†é‚è¼¯ ---

        /**
         * å¾ localStorage è¼‰å…¥è³¼ç‰©è»Šè³‡æ–™ã€‚
         * @returns {Array} è³¼ç‰©è»Šé™£åˆ—ã€‚
         */
        function loadCartFromStorage() {
            try {
                const storedCart = localStorage.getItem(CART_STORAGE_KEY);
                return storedCart ? JSON.parse(storedCart) : [];
            } catch (e) {
                console.error("ç„¡æ³•å¾ localStorage è¼‰å…¥è³¼ç‰©è»Š:", e);
                return [];
            }
        }

        /**
         * å°‡è³¼ç‰©è»Šè³‡æ–™å„²å­˜åˆ° localStorageã€‚
         */
        function saveCartToStorage() {
            try {
                localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
            } catch (e) {
                console.error("ç„¡æ³•å°‡è³¼ç‰©è»Šå„²å­˜åˆ° localStorage:", e);
            }
        }

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            cartCount.style.display = totalItems > 0 ? 'block' : 'none';
        }

        function calculateCartTotal() {
            return cart.reduce((total, item) => {
                // ç¢ºä¿åƒ¹æ ¼æ˜¯æœ‰æ•ˆçš„æ•¸å­—ï¼Œç§»é™¤éæ•¸å­—å­—ç¬¦ (å¦‚ NT$)
                const priceMatch = item.price.match(/[\d,.]+/);
                const price = priceMatch ? parseFloat(priceMatch[0].replace(/,/g, '')) : 0;
                return total + (price * item.quantity);
            }, 0);
        }

        function renderCart() {
            cartItemsList.innerHTML = '';
            
            if (cart.length === 0) {
                cartItemsList.innerHTML = '<p style="text-align: center; color: var(--subtle-text-color);">è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼å¿«å»æŒ‘é¸å–œæ­¡çš„ç”¢å“å§ã€‚</p>';
                totalAmountSpan.textContent = '0';
                checkoutButton.disabled = true;
                return;
            }
            
            cart.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'cart-item';
                
                // è¨ˆç®—å–®é …å°è¨ˆ
                const priceMatch = item.price.match(/[\d,.]+/);
                const price = priceMatch ? parseFloat(priceMatch[0].replace(/,/g, '')) : 0;
                const subtotal = (price * item.quantity).toLocaleString('en-US');
                
                // ç”¢ç”Ÿä¸€å€‹ unique key çµ¦ç”¢å“ï¼Œä»¥ä¾¿åœ¨çµå¸³é é¢æ–¹ä¾¿è¤‡è£½
                const uniqueKey = `${item.name} (${item.size}/${item.color}) - æ•¸é‡: ${item.quantity}`;

                li.innerHTML = `
                    <div class="cart-item-info">
                        <h4>${item.name}</h4>
                        <p>è¦æ ¼: ${item.size} / ${item.color}</p>
                        <p>å–®åƒ¹: ${item.price}</p>
                    </div>
                    <div class="cart-item-actions">
                        <span class="price-display">å°è¨ˆ: NT$ ${subtotal}</span>
                        <button class="remove-btn" data-index="${index}"><i class="fas fa-trash-alt"></i> ç§»é™¤</button>
                    </div>
                `;
                
                cartItemsList.appendChild(li);
            });
            
            totalAmountSpan.textContent = calculateCartTotal().toLocaleString('en-US');
            checkoutButton.disabled = false;
            
            // ç¶å®šç§»é™¤æŒ‰éˆ•äº‹ä»¶
            cartItemsList.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    cart.splice(index, 1);
                    renderCart();
                    updateCartCount();
                    saveCartToStorage(); // ç§»é™¤å¾Œå„²å­˜
                });
            });
        }

        function addToCart(productName, selectedSize, selectedColor, quantity, price) {
            const existingItemIndex = cart.findIndex(item => 
                item.name === productName && 
                item.size === selectedSize && 
                item.color === selectedColor
            );

            if (existingItemIndex > -1) {
                // å¦‚æœç”¢å“å·²å­˜åœ¨ï¼Œæ›´æ–°æ•¸é‡
                cart[existingItemIndex].quantity += quantity;
            } else {
                // å¦å‰‡æ–°å¢ç”¢å“
                cart.push({
                    name: productName,
                    size: selectedSize,
                    color: selectedColor,
                    quantity: quantity,
                    price: price
                });
            }

            updateCartCount();
            saveCartToStorage(); // åŠ å…¥å¾Œå„²å­˜
            alert(`${productName} (${selectedSize}/${selectedColor}) x ${quantity} å·²åŠ å…¥è³¼ç‰©è»Šï¼`);
        }

        function showCartModal(event) {
             event.stopPropagation(); // é˜²æ­¢é»æ“Šåœ–ç¤ºæ™‚è§¸ç™¼å…¶ä»–äº‹ä»¶
             // åªæœ‰åœ¨ç”¢å“åˆ—è¡¨é é¢é»æ“Šè³¼ç‰©è»Šåœ–ç¤ºæ™‚æ‰è™•ç†
             if(productPage.style.display !== 'none') {
                cartModal.style.display = 'flex';
                renderCart();
             }
        }
        
        function closeCartModal() {
            cartModal.style.display = 'none';
        }
        
        function showCheckoutPage() {
            productPage.style.display = 'none';
            checkoutPage.style.display = 'block';
            cartModal.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' }); // æ»¾å‹•åˆ°é é¢é ‚éƒ¨
        }
        
        function showProductList() {
             productPage.style.display = 'block';
             checkoutPage.style.display = 'none';
        }
        
        // é é¢ç‹€æ…‹åˆ‡æ›äº‹ä»¶
        cartIcon.addEventListener('click', showCartModal);
        checkoutButton.addEventListener('click', showCheckoutPage);
        cartModal.addEventListener('click', (e) => {
            if (e.target === cartModal) {
                closeCartModal();
            }
        });

        // --- ç”¢å“æ¸²æŸ“èˆ‡ç¯©é¸é‚è¼¯ (ä¿®æ”¹è™•ç†é‚è¼¯) ---
        
        function getAvailableSpecs(productName) {
            const product = allProductsData[productName];
            const details = product ? product.details : {};
            const specs = {
                sizes: new Set(),
                colors: new Set(),
                detailsMap: {} // å„²å­˜ (å°ºå¯¸-é¡è‰²) -> æ•¸é‡ çš„æ˜ å°„
            };
            
            for (const key in details) {
                const detail = details[key];
                // ç¢ºä¿å°ºå¯¸å’Œé¡è‰²ä¸æ˜¯ null æˆ– undefined
                const size = detail['å°ºå¯¸'] || 'ç„¡';
                const color = detail['é¡è‰²'] || 'ç„¡';
                
                specs.sizes.add(size);
                specs.colors.add(color);
                specs.detailsMap[`${size}-${color}`] = detail['æ•¸é‡'];
            }
            
            // ç¢ºä¿ 'ç„¡' è¦æ ¼æ°¸é åœ¨åˆ—è¡¨æœ€å‰é¢
            const sortedSizes = [...specs.sizes].sort((a, b) => {
                if (a === 'ç„¡') return -1;
                if (b === 'ç„¡') return 1;
                return a.localeCompare(b);
            });
            const sortedColors = [...specs.colors].sort((a, b) => {
                if (a === 'ç„¡') return -1;
                if (b === 'ç„¡') return 1;
                return a.localeCompare(b);
            });
            
            return {
                sizes: sortedSizes,
                colors: sortedColors,
                detailsMap: specs.detailsMap
            };
        }
        
        function renderProducts(productsToRender) {
            productListDiv.innerHTML = '';
            showProductList(); 

            if (Object.keys(productsToRender).length === 0) {
                productListDiv.innerHTML = '<p style="text-align: center; width: 100%;">æ²’æœ‰æ‰¾åˆ°ç›¸é—œç”¢å“ã€‚</p>';
                return;
            }

            for (const productName in productsToRender) {
                const productData = productsToRender[productName];
                const specs = getAvailableSpecs(productName);
                const firstPrice = productData.productInfo['å”®åƒ¹'] || 'NT$ åƒ¹æ ¼å¾…å®š';
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºå¤šè¦æ ¼ï¼šå°ºå¯¸æˆ–é¡è‰²é›†åˆä¸­ä»»ä¸€å€‹æ•¸é‡å¤§æ–¼ 1ï¼Œæˆ–åƒ…æœ‰ 'ç„¡' ä»¥å¤–çš„å–®ä¸€è¦æ ¼
                const hasMultipleSpecs = (specs.sizes.length > 1 && !(specs.sizes.length === 2 && specs.sizes.has('ç„¡'))) || 
                                         (specs.colors.length > 1 && !(specs.colors.length === 2 && specs.colors.has('ç„¡')));
                
                // å¦‚æœæ˜¯å–®ä¸€è¦æ ¼ï¼Œéœ€è¦ç¢ºå®šè¦æ ¼åç¨±
                const singleSize = specs.sizes.values().next().value || 'ç„¡';
                const singleColor = specs.colors.values().next().value || 'ç„¡';
                
                const card = document.createElement('div');
                card.className = 'product-card';

                const photos = productData.productInfo['ç…§ç‰‡é€£çµ'] ? productData.productInfo['ç…§ç‰‡é€£çµ'].split(',').map(url => url.trim()).filter(url => url !== '') : [];
                let imagesHtml = '';
                if (photos.length > 0) {
                    // ä½¿ç”¨ encodeURIComponent ç¢ºä¿ JSON æ ¼å¼åœ¨ HTML å±¬æ€§ä¸­å®‰å…¨
                    const photosJson = JSON.stringify(photos).replace(/"/g, '&quot;'); 
                    imagesHtml = `<div class="product-images">
                        <img src="${photos[0]}" alt="${productName}" data-photos='${photosJson}'>
                    </div>`;
                }
                
                // è¦æ ¼é¸æ“‡å™¨
                let specSelectorHtml = '';
                if (hasMultipleSpecs) {
                    specSelectorHtml = `
                        <div class="spec-selector">
                            <label for="size-${productName}">å°ºå¯¸:</label>
                            <select id="size-${productName}" data-spec-type="size">
                                ${specs.sizes.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                            
                            <label for="color-${productName}">é¡è‰²:</label>
                            <select id="color-${productName}" data-spec-type="color">
                                ${specs.colors.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                            
                            <div class="stock-info" id="stock-info-${productName}">è«‹é¸æ“‡è¦æ ¼</div>
                            
                            <label for="qty-${productName}">æ•¸é‡:</label>
                            <input type="number" id="qty-${productName}" value="1" min="1" max="1" disabled>
                            
                            <button class="add-to-cart-btn" data-product-name="${productName}" data-price="${firstPrice}" disabled>åŠ å…¥è³¼ç‰©è»Š</button>
                        </div>
                    `;
                } else {
                    // å–®ä¸€æˆ–ç„¡è¦æ ¼ç”¢å“
                    const stock = specs.detailsMap[`${singleSize}-${singleColor}`] || 0;
                    const stockText = stock > 0 ? `åº«å­˜: ${stock}` : `<span class="out-of-stock">ç¼ºè²¨</span>`;
                    specSelectorHtml = `
                        <div class="spec-selector">
                            ${(singleSize !== 'ç„¡' || singleColor !== 'ç„¡') ? `<p>è¦æ ¼: ${singleSize}/${singleColor}</p>` : ''}
                            <p class="stock-info" id="stock-info-${productName}">${stockText}</p>
                            <label for="qty-${productName}">æ•¸é‡:</label>
                            <input type="number" id="qty-${productName}" value="1" min="1" max="${stock}" ${stock === 0 ? 'disabled' : ''}>
                            <button class="add-to-cart-btn" data-product-name="${productName}" data-price="${firstPrice}" data-size="${singleSize}" data-color="${singleColor}" ${stock === 0 ? 'disabled' : ''}>åŠ å…¥è³¼ç‰©è»Š</button>
                        </div>
                    `;
                }


                const cardContentHtml = `
                    ${imagesHtml}
                    <div class="product-info">
                        <h2>${productName}</h2>
                        <p><strong>åˆ†é¡:</strong> ${productData.productInfo['åˆ†é¡'] || 'ç„¡'}</p>
                        <p class="price"><strong>å”®åƒ¹:</strong> ${firstPrice}</p>
                        <p><strong>ç”¢å“å…§å®¹:</strong> ${productData.productInfo['ç”¢å“å…§å®¹èªªæ˜'] || 'ç„¡'}</p>
                        ${specSelectorHtml}
                    </div>
                `;

                card.innerHTML = cardContentHtml;
                productListDiv.appendChild(card);
                
                // --- è¦æ ¼é¸æ“‡é€£å‹•é‚è¼¯ ---
                if (hasMultipleSpecs) {
                    const sizeSelect = card.querySelector(`#size-${productName}`);
                    const colorSelect = card.querySelector(`#color-${productName}`);
                    const qtyInput = card.querySelector(`#qty-${productName}`);
                    const stockInfoDiv = card.querySelector(`#stock-info-${productName}`);
                    const addToCartBtn = card.querySelector('.add-to-cart-btn');

                    const updateStock = () => {
                        const selectedSize = sizeSelect.value;
                        const selectedColor = colorSelect.value;
                        const stockKey = `${selectedSize}-${selectedColor}`;
                        const maxStock = specs.detailsMap[stockKey] || 0;
                        
                        stockInfoDiv.innerHTML = maxStock > 0 ? `åº«å­˜: ${maxStock}` : `è©²è¦æ ¼ ${selectedSize}/${selectedColor} <span class="out-of-stock">ç¼ºè²¨</span>`;
                        qtyInput.max = maxStock;
                        qtyInput.disabled = maxStock === 0;
                        
                        // ç¢ºä¿æ•¸é‡ä¸è¶…éæ–°åº«å­˜
                        let currentQty = parseInt(qtyInput.value) || 1;
                        if (currentQty > maxStock) currentQty = maxStock > 0 ? maxStock : 1;
                        qtyInput.value = Math.max(1, currentQty); 
                        
                        addToCartBtn.disabled = maxStock === 0;
                        addToCartBtn.dataset.size = selectedSize;
                        addToCartBtn.dataset.color = selectedColor;
                    };

                    sizeSelect.addEventListener('change', updateStock);
                    colorSelect.addEventListener('change', updateStock);
                    qtyInput.addEventListener('input', () => {
                        // ç¢ºä¿è¼¸å…¥æ•¸é‡ä¸è¶…éåº«å­˜ä¸”è‡³å°‘ç‚º 1
                        const max = parseInt(qtyInput.max);
                        if (parseInt(qtyInput.value) > max) {
                            qtyInput.value = max;
                        }
                        if (parseInt(qtyInput.value) < 1 || isNaN(parseInt(qtyInput.value))) {
                            qtyInput.value = 1;
                        }
                    });

                    // åˆå§‹è¼‰å…¥æ™‚æ›´æ–°åº«å­˜è³‡è¨Š
                    updateStock();
                }
                
                // --- åŠ å…¥è³¼ç‰©è»ŠæŒ‰éˆ•äº‹ä»¶ ---
                card.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    const name = btn.dataset.productName;
                    const price = btn.dataset.price;
                    let size = btn.dataset.size;
                    let color = btn.dataset.color;
                    let quantity;
                    
                    if (hasMultipleSpecs) {
                        quantity = parseInt(card.querySelector(`#qty-${name}`).value);
                    } else {
                        quantity = parseInt(card.querySelector(`#qty-${name}`).value);
                        size = singleSize; // å†æ¬¡ç¢ºä¿å–®ä¸€è¦æ ¼çš„å–å€¼
                        color = singleColor;
                    }

                    if (quantity > 0) {
                        addToCart(name, size, color, quantity, price);
                    } else {
                        alert('è«‹é¸æ“‡æœ‰æ•ˆçš„æ•¸é‡ï¼');
                    }
                });

                // --- Lightbox äº‹ä»¶ (ä¸è®Š) ---
                const imagesDiv = card.querySelector('.product-images');
                if (imagesDiv) {
                    const img = imagesDiv.querySelector('img');
                    if (img && photos.length > 0) {
                        // ç”±æ–¼ photosJson å·²ç¶“å®‰å…¨è™•ç†ï¼Œé€™è£¡è¦ç”¨ JSON.parse è®€å–å›ä¾†
                        const photosFromData = JSON.parse(img.getAttribute('data-photos').replace(/&quot;/g, '"'));
                        imagesDiv.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openLightbox(photosFromData);
                        });
                    }
                }
                
                // --- å¤–éƒ¨é€£çµé»æ“Šäº‹ä»¶ (ä¸è®Š) ---
                const productLink = productData.productInfo['é€£çµ'];
                if (productLink && productLink.trim() !== '') {
                    const fullLink = productLink.startsWith('http://') || productLink.startsWith('https://') ? productLink : `https://${productLink}`;
                    card.addEventListener('click', (event) => {
                        // åªæœ‰é»æ“Šå¡ç‰‡å…¶ä»–éƒ¨åˆ†æ‰é–‹å•Ÿé€£çµ
                        if (!event.target.closest('.spec-selector') && !event.target.closest('.product-images')) {
                             window.open(fullLink, '_blank');
                        }
                    });
                }
            }
        }
        
        // --- ç¯©é¸å™¨èˆ‡åˆå§‹åŒ–é‚è¼¯ (ä¸è®Š) ---

        function filterProducts() {
            const searchText = searchBox.value.toLowerCase();
            const filteredProducts = {};
            
            for (const productName in allProductsData) {
                const productData = allProductsData[productName];
                const productCategory = productData.productInfo['åˆ†é¡'] || 'ç„¡';
                
                // ä½¿ç”¨é‚è¼¯æˆ–ï¼Œç¢ºä¿æœå°‹ç¯„åœåŒ…å«ç”¢å“å…§å®¹èªªæ˜
                const matchesCategory = activeCategory === 'all' || productCategory.toLowerCase() === activeCategory;
                const description = productData.productInfo['ç”¢å“å…§å®¹èªªæ˜'] || '';
                const matchesSearch = productName.toLowerCase().includes(searchText) || description.toLowerCase().includes(searchText);

                if (matchesCategory && matchesSearch) {
                    filteredProducts[productName] = productData;
                }
            }
            
            renderProducts(filteredProducts);
        }

        function createFilterTags(categories) {
            filtersDiv.innerHTML = '';
            const allTag = document.createElement('div');
            allTag.className = 'filter-tag active';
            allTag.textContent = 'æ‰€æœ‰ç”¢å“';
            allTag.dataset.category = 'all';
            filtersDiv.appendChild(allTag);

            categories.forEach(category => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.textContent = category;
                tag.dataset.category = category.toLowerCase();
                filtersDiv.appendChild(tag);
            });
            
            filtersDiv.addEventListener('click', (event) => {
                if (event.target.classList.contains('filter-tag')) {
                    document.querySelectorAll('.filter-tag').forEach(tag => tag.classList.remove('active'));
                    event.target.classList.add('active');
                    activeCategory = event.target.dataset.category;
                    filterProducts();
                }
            });
        }
        
        searchBox.addEventListener('input', filterProducts);

        // --- Lightbox é‚è¼¯ (ä¸è®Š) ---

        function openLightbox(images, startIndex = 0) {
            lightboxImages = images;
            lightboxContent.innerHTML = '';
            images.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                lightboxContent.appendChild(img);
            });
            currentImageIndex = startIndex;
            showImage(currentImageIndex);
            lightbox.style.display = 'flex';
        }

        function showImage(index) {
            const images = lightboxContent.querySelectorAll('img');
            images.forEach((img, i) => {
                if (i === index) {
                    img.classList.add('active');
                } else {
                    img.classList.remove('active');
                }
            });
        }

        closeBtn.addEventListener('click', () => {
            lightbox.style.display = 'none';
        });

        prevBtn.addEventListener('click', () => {
            currentImageIndex = (currentImageIndex > 0) ? currentImageIndex - 1 : lightboxImages.length - 1;
            showImage(currentImageIndex);
        });

        nextBtn.addEventListener('click', () => {
            currentImageIndex = (currentImageIndex < lightboxImages.length - 1) ? currentImageIndex + 1 : 0;
            showImage(currentImageIndex);
        });


        // --- è³‡æ–™è¼‰å…¥èˆ‡è™•ç†é‚è¼¯ (ä¿®æ­£è³‡æ–™è™•ç†çš„å¥å£¯æ€§) ---

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                productListDiv.innerHTML = '';

                if (!Array.isArray(data) || data.length === 0) {
                    productListDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰ç”¢å“è³‡æ–™ã€‚</p>';
                    return;
                }
                
                const groupedProducts = data.reduce((acc, currentItem) => {
                    // ç¢ºä¿æ‰€æœ‰é—œéµæ¬„ä½éƒ½æœ‰é è¨­å€¼ï¼Œé˜²æ­¢å–å€¼éŒ¯èª¤
                    const productName = currentItem['ç”¢å“åç¨±'] || 'ç„¡æ¨™é¡Œ';
                    const size = currentItem['å°ºå¯¸'] || 'ç„¡';
                    const color = currentItem['é¡è‰²'] || 'ç„¡';
                    const quantity = parseInt(currentItem['æ•¸é‡']) || 0;
                    const category = currentItem['åˆ†é¡'] || 'ç„¡åˆ†é¡';
                    const price = currentItem['æˆ‘æ–¹å”®åƒ¹'] || 'NT$ åƒ¹æ ¼å¾…å®š';
                    const detailsKey = `${size}-${color}`;

                    if (!acc[productName]) {
                        acc[productName] = {
                            details: {},
                            productInfo: {
                                'å”®åƒ¹': price,
                                'ç”¢å“å…§å®¹èªªæ˜': currentItem['ç”¢å“å…§å®¹èªªæ˜'] || '',
                                'é€£çµ': null,
                                'ç…§ç‰‡é€£çµ': currentItem['ç…§ç‰‡é€£çµ'] || '',
                                'åˆ†é¡': category
                            }
                        };
                    }
                    
                    // ç¢ºä¿åƒ¹æ ¼æ˜¯æœ€æ–°çš„æˆ–éç©º
                    if (price !== 'NT$ åƒ¹æ ¼å¾…å®š') {
                         acc[productName].productInfo['å”®åƒ¹'] = price;
                    }

                    // è™•ç†é€£çµ
                    if (!acc[productName].productInfo['é€£çµ']) {
                        const linkString = currentItem['é€£çµ'] || '';
                        const matches = linkString.match(/https?:\/\/[^\s]+/g);
                        if (matches && matches.length > 0) {
                            acc[productName].productInfo['é€£çµ'] = matches[0];
                        }
                    }

                    if (!acc[productName].details[detailsKey]) {
                        acc[productName].details[detailsKey] = {
                            'å°ºå¯¸': size,
                            'é¡è‰²': color,
                            'æ•¸é‡': 0
                        };
                    }

                    // ç´¯åŠ æ•¸é‡
                    acc[productName].details[detailsKey]['æ•¸é‡'] += quantity;

                    return acc;
                }, {});
                
                allProductsData = groupedProducts;
                
                // è™•ç†åˆ†é¡æ¨™ç±¤
                const categories = [...new Set(data.map(item => item['åˆ†é¡']).filter(Boolean))].sort();
                createFilterTags(categories);
                
                filterProducts(); // åˆæ¬¡æ¸²æŸ“
                updateCartCount(); // åˆå§‹åŒ–è³¼ç‰©è»Šæ•¸é‡
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                productListDiv.innerHTML = '<p>è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API é€£çµæˆ–ç€è¦½å™¨æ§åˆ¶å°éŒ¯èª¤ã€‚</p>';
            });
    </script>

</body>
</html>
