<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>產品列表</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&family=Noto+Serif+TC:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-font: 'Noto Serif TC', serif;
            --secondary-font: 'Noto Sans TC', sans-serif;
            --text-color: #333;
            --subtle-text-color: #777;
            --background-color: #f8f8f8;
            --card-background: #fff;
            --border-color: #e0e0e0;
            --accent-color: #000;
        }

        body {
            font-family: var(--secondary-font);
            margin: 0;
            padding: 30px 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        h1 {
            font-family: var(--primary-font);
            text-align: center;
            color: #1a1a1a;
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        #search-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #search-box {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            box-sizing: border-box;
            background-color: var(--card-background);
            color: var(--text-color);
        }

        /* PC/大螢幕 預設樣式 */
        #filters {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap; /* PC上允許換行，完整呈現 */
            justify-content: center; /* PC上居中對齊 */
            gap: 10px;
            overflow-x: visible; /* PC上不隱藏溢出 */
            padding-bottom: 0;
        }
        
        /* 行動端/小螢幕樣式 - 使用媒體查詢覆蓋 */
        @media (max-width: 768px) {
            #filters {
                justify-content: flex-start; /* 行動端靠左對齊 */
                flex-wrap: nowrap; /* 行動端不換行，實現橫向滾動 */
                overflow-x: auto; /* 允許橫向滾動 */
                -webkit-overflow-scrolling: touch; /* 提升 iOS 上的滾動體驗 */
                padding: 5px 0 15px 0; /* 留出空間給滾動條或陰影 */
                margin-left: -20px; /* 填滿整個螢幕寬度（抵銷 body 左右 padding）*/
                margin-right: -20px;
                padding-left: 20px; /* 讓第一個 tag 對齊內容 */
                padding-right: 20px; /* 讓最後一個 tag 不會貼邊 */
            }
            
            /* 隱藏滾動條 - 只在行動端樣式中保留，以保持介面簡潔 */
            #filters::-webkit-scrollbar {
                display: none;
            }

            #filters {
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
        }
        
        .filter-tag {
            flex-shrink: 0; /* 防止標籤被壓縮 */
            background-color: #fff;
            color: var(--subtle-text-color);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, color 0.3s;
            font-size: 14px;
        }
        
        .filter-tag:hover {
            background-color: var(--border-color);
        }
        
        .filter-tag.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        #product-list {
            display: grid;
            gap: 40px;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            max-width: 1200px;
            margin: auto;
        }

        .product-card {
            background-color: var(--card-background);
            border-radius: 5px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.3s ease;
            cursor: pointer;
        }

        .product-card:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .product-images {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
            cursor: pointer;
        }

        .product-images img {
            width: 100%;
            height: auto;
            object-fit: contain;
            transition: transform 0.5s ease;
        }

        .product-info {
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .product-info h2 {
            font-family: var(--primary-font);
            margin-top: 0;
            color: #1a1a1a;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .product-info h2 a {
            text-decoration: none;
            color: inherit;
        }
        
        .product-info h2 a:hover {
            text-decoration: none;
        }

        .product-info p {
            margin: 5px 0;
            line-height: 1.6;
        }

        .product-info strong {
            color: var(--text-color);
            font-weight: 500;
        }
        
        .product-info table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .product-info th, .product-info td {
            border-bottom: 1px solid var(--border-color);
            padding: 10px 0;
            text-align: left;
            word-break: break-all;
            font-size: 14px;
        }
        
        .product-info th {
            font-family: var(--secondary-font);
            font-weight: 500;
            color: var(--subtle-text-color);
        }

        /* New styles for lightbox */
        .lightbox-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .lightbox-container {
            position: relative;
            width: 90%;
            max-width: 900px;
            height: 80%;
        }

        .lightbox-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }

        .lightbox-content img.active {
            display: block;
        }
        
        .close-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .prev-btn, .next-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #fff;
            font-size: 50px;
            cursor: pointer;
            z-index: 1001;
        }

        .prev-btn {
            left: 20px;
        }

        .next-btn {
            right: 20px;
        }

        @media (max-width: 768px) {
            #product-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <h1>產品列表</h1>
    <div id="search-container">
        <input type="text" id="search-box" placeholder="輸入產品名稱搜尋...">
    </div>
    <div id="filters"></div>
    <div id="product-list">載入中...</div>
    
    <div class="lightbox-overlay" id="lightbox">
        <span class="close-btn">&times;</span>
        <span class="prev-btn">&#10094;</span>
        <div class="lightbox-container" id="lightbox-container">
            <div class="lightbox-content" id="lightbox-content">
            </div>
        </div>
        <span class="next-btn">&#10095;</span>
    </div>

    <script>
        const apiUrl = 'https://script.google.com/macros/s/AKfycbzco3oEMAXdl8w4PfhNj9KA1pzLKOkw3uLxTN9tkqlZfm4PV14gHMJ55rppw9jBWoQU/exec';
        
        const lightbox = document.getElementById('lightbox');
        const lightboxContent = document.getElementById('lightbox-content');
        const closeBtn = document.querySelector('.close-btn');
        const prevBtn = document.querySelector('.prev-btn');
        const nextBtn = document.querySelector('.next-btn');
        const productListDiv = document.getElementById('product-list');
        const filtersDiv = document.getElementById('filters');
        const searchBox = document.getElementById('search-box');
        let currentImageIndex = 0;
        let lightboxImages = [];
        let allProductsData = {};
        let activeCategory = 'all';

        function openLightbox(images, startIndex = 0) {
            lightboxImages = images;
            lightboxContent.innerHTML = '';
            images.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                lightboxContent.appendChild(img);
            });
            currentImageIndex = startIndex;
            showImage(currentImageIndex);
            lightbox.style.display = 'flex';
        }

        function showImage(index) {
            const images = lightboxContent.querySelectorAll('img');
            images.forEach((img, i) => {
                if (i === index) {
                    img.classList.add('active');
                } else {
                    img.classList.remove('active');
                }
            });
        }

        closeBtn.addEventListener('click', () => {
            lightbox.style.display = 'none';
        });

        prevBtn.addEventListener('click', () => {
            currentImageIndex = (currentImageIndex > 0) ? currentImageIndex - 1 : lightboxImages.length - 1;
            showImage(currentImageIndex);
        });

        nextBtn.addEventListener('click', () => {
            currentImageIndex = (currentImageIndex < lightboxImages.length - 1) ? currentImageIndex + 1 : 0;
            showImage(currentImageIndex);
        });

        function renderProducts(productsToRender) {
            productListDiv.innerHTML = '';
            if (Object.keys(productsToRender).length === 0) {
                productListDiv.innerHTML = '<p style="text-align: center; width: 100%;">沒有找到相關產品。</p>';
                return;
            }

            for (const productName in productsToRender) {
                const productData = productsToRender[productName];
                const card = document.createElement('div');
                card.className = 'product-card';

                const photos = productData.productInfo['照片連結'] ? productData.productInfo['照片連結'].split(',').map(url => url.trim()) : [];
                let imagesHtml = '';
                if (photos.length > 0) {
                    imagesHtml = `<div class="product-images">
                        <img src="${photos[0]}" alt="${productName}" data-photos='${JSON.stringify(photos)}'>
                    </div>`;
                }

                let detailsHtml = '<table><thead><tr><th>尺寸</th><th>顏色</th><th>數量</th></tr></thead><tbody>';
                for (const key in productData.details) {
                    const detail = productData.details[key];
                    detailsHtml += `<tr><td>${detail['尺寸']}</td><td>${detail['顏色']}</td><td>${detail['數量']}</td></tr>`;
                }
                detailsHtml += '</tbody></table>';

                const cardContentHtml = `
                    ${imagesHtml}
                    <div class="product-info">
                        <h2>${productName}</h2>
                        <p><strong>分類:</strong> ${productData.productInfo['分類'] || '無'}</p>
                        <p><strong>售價:</strong> ${productData.productInfo['售價'] || '無'}</p>
                        <p><strong>產品內容:</strong> ${productData.productInfo['產品內容說明'] || '無'}</p>
                        <h3>庫存明細</h3>
                        ${detailsHtml}
                    </div>
                `;

                card.innerHTML = cardContentHtml;
                
                // 圖片載入完成後再調整寬度
                const cardImage = card.querySelector('.product-images img');
                if (cardImage) {
                    cardImage.addEventListener('load', () => {
                        cardImage.classList.add('loaded');
                    });
                }

                const productLink = productData.productInfo['連結'];
                if (productLink && productLink.trim() !== '') {
                    const fullLink = productLink.startsWith('http://') || productLink.startsWith('https://') ? productLink : `https://${productLink}`;
                    card.addEventListener('click', (event) => {
                        if (event.target.closest('.product-images')) {
                            return;
                        }
                        window.open(fullLink, '_blank');
                    });
                }

                productListDiv.appendChild(card);
            }

            document.querySelectorAll('.product-images').forEach(imagesDiv => {
                const img = imagesDiv.querySelector('img');
                if (img) {
                    const photos = JSON.parse(img.getAttribute('data-photos'));
                    if (photos.length > 1) {
                        imagesDiv.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openLightbox(photos);
                        });
                    }
                }
            });
        }
        
        function filterProducts() {
            const searchText = searchBox.value.toLowerCase();
            const filteredProducts = {};
            
            for (const productName in allProductsData) {
                const productData = allProductsData[productName];
                const productCategory = productData.productInfo['分類'] || '無';
                
                const matchesCategory = activeCategory === 'all' || productCategory.toLowerCase() === activeCategory;
                const matchesSearch = productName.toLowerCase().includes(searchText);

                if (matchesCategory && matchesSearch) {
                    filteredProducts[productName] = productData;
                }
            }
            
            renderProducts(filteredProducts);
        }

        function createFilterTags(categories) {
            filtersDiv.innerHTML = '';
            const allTag = document.createElement('div');
            allTag.className = 'filter-tag active';
            allTag.textContent = '所有產品';
            allTag.dataset.category = 'all';
            filtersDiv.appendChild(allTag);

            categories.forEach(category => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.textContent = category;
                tag.dataset.category = category.toLowerCase();
                filtersDiv.appendChild(tag);
            });
            
            filtersDiv.addEventListener('click', (event) => {
                if (event.target.classList.contains('filter-tag')) {
                    document.querySelectorAll('.filter-tag').forEach(tag => tag.classList.remove('active'));
                    event.target.classList.add('active');
                    activeCategory = event.target.dataset.category;
                    filterProducts();
                }
            });
        }
        
        searchBox.addEventListener('input', filterProducts);

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                productListDiv.innerHTML = '';

                if (data.length === 0) {
                    productListDiv.innerHTML = '<p>目前沒有產品資料。</p>';
                    return;
                }
                
                const groupedProducts = data.reduce((acc, currentItem) => {
                    const productName = currentItem['產品名稱'] || '無標題';
                    const size = currentItem['尺寸'] || '無';
                    const color = currentItem['顏色'] || '無';
                    const quantity = parseInt(currentItem['數量']) || 0;
                    const category = currentItem['分類'] || '無分類';
                    const detailsKey = `${size}-${color}`;

                    if (!acc[productName]) {
                        acc[productName] = {
                            details: {},
                            productInfo: {
                                '售價': currentItem['我方售價'],
                                '產品內容說明': currentItem['產品內容說明'],
                                '連結': null,
                                '照片連結': currentItem['照片連結'],
                                '分類': category
                            }
                        };
                    }

                    if (!acc[productName].productInfo['連結']) {
                        const linkString = currentItem['連結'] || '';
                        const matches = linkString.match(/https?:\/\/[^\s]+/g);
                        if (matches && matches.length > 0) {
                            acc[productName].productInfo['連結'] = matches[0];
                        }
                    }

                    if (!acc[productName].details[detailsKey]) {
                        acc[productName].details[detailsKey] = {
                            '尺寸': size,
                            '顏色': color,
                            '數量': 0
                        };
                    }

                    acc[productName].details[detailsKey]['數量'] += quantity;

                    return acc;
                }, {});
                
                allProductsData = groupedProducts;
                
                const categories = [...new Set(data.map(item => item['分類']).filter(Boolean))].sort();
                createFilterTags(categories);
                
                filterProducts();
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                const productListDiv = document.getElementById('product-list');
                productListDiv.innerHTML = '<p>載入資料失敗，請稍後再試。</p>';
            });
    </script>

</body>
</html>
