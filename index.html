<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>產品列表與購物車</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&family=Noto+Serif+TC:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-font: 'Noto Serif TC', serif;
            --secondary-font: 'Noto Sans TC', sans-serif;
            --text-color: #333;
            --subtle-text-color: #777;
            --background-color: #f8f8f8;
            --card-background: #fff;
            --border-color: #e0e0e0;
            --accent-color: #000;
            --success-color: #4CAF50;
            --error-color: #f44336;
        }

        body {
            font-family: var(--secondary-font);
            margin: 0;
            padding: 30px 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* 頁面標題與購物車圖示容器 */
        #header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto 20px;
        }

        h1 {
            font-family: var(--primary-font);
            color: #1a1a1a;
            font-size: 2.5rem;
            margin: 0;
        }
        
        /* 購物車圖示樣式 */
        #cart-icon {
            position: relative;
            cursor: pointer;
            padding: 10px;
            transition: color 0.3s;
        }

        #cart-icon:hover {
            color: var(--accent-color);
        }

        #cart-count {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--error-color);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            line-height: 1;
        }

        /* 主內容容器 */
        #main-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* 產品列表與篩選樣式 (不變) */
        #search-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #search-box {
            width: 100%;
            max-width: 400px;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            box-sizing: border-box;
            background-color: var(--card-background);
            color: var(--text-color);
        }

        #filters {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px;
            overflow-x: visible; 
            padding-bottom: 0;
        }
        
        @media (max-width: 768px) {
            #filters {
                justify-content: flex-start;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 5px 0 15px 0;
                margin-left: -20px;
                margin-right: -20px;
                padding-left: 20px;
                padding-right: 20px;
            }
            #filters::-webkit-scrollbar {
                display: none;
            }
            #filters {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            #header-container {
                flex-direction: column;
                align-items: center;
            }
            h1 {
                margin-bottom: 10px;
            }
        }
        
        .filter-tag {
            flex-shrink: 0;
            background-color: #fff;
            color: var(--subtle-text-color);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, color 0.3s;
            font-size: 14px;
        }
        
        .filter-tag:hover {
            background-color: var(--border-color);
        }
        
        .filter-tag.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        #product-list {
            display: grid;
            gap: 40px;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        /* 產品卡片規格選擇器樣式 (新增) */
        .product-card {
            background-color: var(--card-background);
            border-radius: 5px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.3s ease;
            /* cursor: pointer; */ /* 移除，因為有互動元素 */
        }

        .product-card:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .product-images {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
            cursor: pointer;
        }

        .product-images img {
            width: 100%;
            height: auto;
            object-fit: contain;
            transition: transform 0.5s ease;
        }

        .product-info {
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .product-info h2 {
            font-family: var(--primary-font);
            margin-top: 0;
            color: #1a1a1a;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .product-info p {
            margin: 5px 0;
            line-height: 1.6;
        }
        
        .product-info .price {
            font-size: 1.2rem;
            color: var(--error-color);
            font-weight: 500;
            margin-bottom: 10px;
        }

        .spec-selector {
            margin: 15px 0;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .spec-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .spec-selector select, .spec-selector input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            box-sizing: border-box;
        }

        .spec-selector button {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .spec-selector button:hover {
            background-color: #333;
        }

        .stock-info {
            font-size: 14px;
            color: var(--subtle-text-color);
            margin-top: -5px;
            margin-bottom: 10px;
            min-height: 1.6em; /* 防止內容閃爍 */
        }
        
        .out-of-stock {
            color: var(--error-color);
            font-weight: 500;
        }

        /* 彈出視窗 Lightbox & Modal 樣式 (新增/修改) */
        .modal-overlay, .lightbox-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto; /* 允許垂直滾動 */
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            align-items: flex-start; /* 讓模態框靠近頂部 */
            padding-top: 5vh;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 5px;
            width: 90%;
            max-width: 700px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 20px;
            color: var(--subtle-text-color);
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--text-color);
        }
        
        /* 購物車列表樣式 */
        #cart-items-list {
            margin-top: 20px;
            list-style: none;
            padding: 0;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .cart-item-info {
            flex-grow: 1;
        }
        
        .cart-item-info h4 {
            margin: 0 0 5px 0;
            font-family: var(--primary-font);
            font-size: 1.2rem;
        }
        
        .cart-item-info p {
            margin: 0;
            font-size: 14px;
            color: var(--subtle-text-color);
        }
        
        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .quantity-control input {
            width: 50px;
            text-align: center;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
        }
        
        .remove-btn {
            background: none;
            border: none;
            color: var(--error-color);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }
        
        #cart-total {
            text-align: right;
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid var(--border-color);
        }

        #checkout-button {
            width: 100%;
            padding: 15px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 18px;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        #checkout-button:hover {
            background-color: #45a049;
        }
        
        /* 結帳說明頁面樣式 */
        #checkout-page {
            display: none; /* 預設隱藏 */
            padding: 40px 20px;
            background-color: var(--card-background);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 50vh;
        }

        #checkout-page h2 {
            font-family: var(--primary-font);
            font-size: 2rem;
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 30px;
        }

        #checkout-page ol {
            max-width: 600px;
            margin: 0 auto;
            padding-left: 20px;
            line-height: 2;
        }
        
        #checkout-page ol li {
            margin-bottom: 15px;
        }
        
        #checkout-page strong {
            color: var(--error-color);
        }
        
        .back-to-cart-btn {
            display: block;
            width: 200px;
            margin: 30px auto 0;
            padding: 12px;
            text-align: center;
            background-color: var(--subtle-text-color);
            color: white;
            border-radius: 3px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .back-to-cart-btn:hover {
            background-color: #555;
        }

        @media (max-width: 768px) {
            .modal-content {
                padding: 20px;
            }
            #checkout-page {
                padding: 20px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="header-container">
        <h1>產品列表</h1>
        <div id="cart-icon">
            <i class="fas fa-shopping-cart fa-2x"></i>
            <span id="cart-count">0</span>
        </div>
    </div>
    
    <div id="main-content">
        <div id="product-page">
            <div id="search-container">
                <input type="text" id="search-box" placeholder="輸入產品名稱搜尋...">
            </div>
            <div id="filters"></div>
            <div id="product-list">載入中...</div>
        </div>
        
        <div id="checkout-page">
            <h2>🎉 訂單確認與付款說明</h2>
            <p style="text-align: center; font-size: 1.1rem; margin-bottom: 40px;">請依照以下步驟完成您的訂單，我們會在收到款項後盡快為您出貨。</p>
            <ol>
                <li><strong>確認購物車明細:</strong> 請再次檢查您在購物車中所選的產品、規格與數量是否正確。</li>
                <li><strong>填寫收件資訊:</strong> 請您透過 **LINE**、**E-mail** 或您常用的社群軟體 **私訊** 給我們，提供您的**訂單明細截圖**、**收件人姓名**、**聯絡電話**、**完整收件地址**。</li>
                <li><strong>進行匯款:</strong> 請將總金額匯款至指定帳戶：
                    <ul>
                        <li>**銀行名稱:** [您的銀行名稱]</li>
                        <li>**帳號:** [您的銀行帳號，例如：1234-5678-901234]</li>
                        <li>**戶名:** [您的戶名]</li>
                    </ul>
                    <p style="margin-top: 10px; font-size: 0.9em; color: var(--error-color);">**請注意:** 匯款完成後，請務必提供**帳號後五碼**或**匯款證明截圖**給我們以供核對。</p>
                </li>
                <li><strong>等待確認:</strong> 我們會在收到您的資料與款項後，發出訂單確認通知，並儘速安排出貨。</li>
            </ol>
            <p style="text-align: center; margin-top: 40px;">感謝您的訂購！若有任何疑問，歡迎隨時聯繫客服。</p>
            <button class="back-to-cart-btn" onclick="showCartModal(event)">返回購物車</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="cart-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeCartModal()">&times;</span>
            <h2>我的購物車</h2>
            <ul id="cart-items-list">
                </ul>
            <div id="cart-summary">
                <div id="cart-total">總計: NT$ <span id="total-amount">0</span></div>
                <button id="checkout-button">確定購買，前往結帳</button>
            </div>
        </div>
    </div>

    <div class="lightbox-overlay" id="lightbox">
        <span class="close-btn">&times;</span>
        <span class="prev-btn">&#10094;</span>
        <div class="lightbox-container" id="lightbox-container">
            <div class="lightbox-content" id="lightbox-content">
            </div>
        </div>
        <span class="next-btn">&#10095;</span>
    </div>

    <script>
        const apiUrl = 'https://script.google.com/macros/s/AKfycbzco3oEMAXdl8w4PfhNj9KA1pzLKOkw3uLxTN9tkqlZfm4PV14gHMJ55rppw9jBWoQU/exec';
        const CART_STORAGE_KEY = 'shoppingCart';
        
        // DOM 元素
        const productListDiv = document.getElementById('product-list');
        const filtersDiv = document.getElementById('filters');
        const searchBox = document.getElementById('search-box');
        const cartIcon = document.getElementById('cart-icon');
        const cartCount = document.getElementById('cart-count');
        const cartModal = document.getElementById('cart-modal');
        const cartItemsList = document.getElementById('cart-items-list');
        const totalAmountSpan = document.getElementById('total-amount');
        const checkoutButton = document.getElementById('checkout-button');
        const productPage = document.getElementById('product-page');
        const checkoutPage = document.getElementById('checkout-page');
        const lightbox = document.getElementById('lightbox');
        const lightboxContent = document.getElementById('lightbox-content');
        const closeBtn = lightbox.querySelector('.close-btn');
        const prevBtn = document.querySelector('.prev-btn');
        const nextBtn = document.querySelector('.next-btn');

        // 狀態變數
        let currentImageIndex = 0;
        let lightboxImages = [];
        let allProductsData = {};
        let activeCategory = 'all';
        let cart = loadCartFromStorage(); // 從本地儲存載入購物車

        // --- 購物車與頁面管理邏輯 ---

        /**
         * 從 localStorage 載入購物車資料。
         * @returns {Array} 購物車陣列。
         */
        function loadCartFromStorage() {
            try {
                const storedCart = localStorage.getItem(CART_STORAGE_KEY);
                return storedCart ? JSON.parse(storedCart) : [];
            } catch (e) {
                console.error("無法從 localStorage 載入購物車:", e);
                return [];
            }
        }

        /**
         * 將購物車資料儲存到 localStorage。
         */
        function saveCartToStorage() {
            try {
                localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
            } catch (e) {
                console.error("無法將購物車儲存到 localStorage:", e);
            }
        }

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            cartCount.style.display = totalItems > 0 ? 'block' : 'none';
        }

        function calculateCartTotal() {
            return cart.reduce((total, item) => {
                // 確保價格是有效的數字，移除非數字字符 (如 NT$)
                const priceMatch = item.price.match(/[\d,.]+/);
                const price = priceMatch ? parseFloat(priceMatch[0].replace(/,/g, '')) : 0;
                return total + (price * item.quantity);
            }, 0);
        }

        function renderCart() {
            cartItemsList.innerHTML = '';
            
            if (cart.length === 0) {
                cartItemsList.innerHTML = '<p style="text-align: center; color: var(--subtle-text-color);">購物車是空的！快去挑選喜歡的產品吧。</p>';
                totalAmountSpan.textContent = '0';
                checkoutButton.disabled = true;
                return;
            }
            
            cart.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'cart-item';
                
                // 計算單項小計
                const priceMatch = item.price.match(/[\d,.]+/);
                const price = priceMatch ? parseFloat(priceMatch[0].replace(/,/g, '')) : 0;
                const subtotal = (price * item.quantity).toLocaleString('en-US');
                
                // 產生一個 unique key 給產品，以便在結帳頁面方便複製
                const uniqueKey = `${item.name} (${item.size}/${item.color}) - 數量: ${item.quantity}`;

                li.innerHTML = `
                    <div class="cart-item-info">
                        <h4>${item.name}</h4>
                        <p>規格: ${item.size} / ${item.color}</p>
                        <p>單價: ${item.price}</p>
                    </div>
                    <div class="cart-item-actions">
                        <span class="price-display">小計: NT$ ${subtotal}</span>
                        <button class="remove-btn" data-index="${index}"><i class="fas fa-trash-alt"></i> 移除</button>
                    </div>
                `;
                
                cartItemsList.appendChild(li);
            });
            
            totalAmountSpan.textContent = calculateCartTotal().toLocaleString('en-US');
            checkoutButton.disabled = false;
            
            // 綁定移除按鈕事件
            cartItemsList.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    cart.splice(index, 1);
                    renderCart();
                    updateCartCount();
                    saveCartToStorage(); // 移除後儲存
                });
            });
        }

        function addToCart(productName, selectedSize, selectedColor, quantity, price) {
            const existingItemIndex = cart.findIndex(item => 
                item.name === productName && 
                item.size === selectedSize && 
                item.color === selectedColor
            );

            if (existingItemIndex > -1) {
                // 如果產品已存在，更新數量
                cart[existingItemIndex].quantity += quantity;
            } else {
                // 否則新增產品
                cart.push({
                    name: productName,
                    size: selectedSize,
                    color: selectedColor,
                    quantity: quantity,
                    price: price
                });
            }

            updateCartCount();
            saveCartToStorage(); // 加入後儲存
            alert(`${productName} (${selectedSize}/${selectedColor}) x ${quantity} 已加入購物車！`);
        }

        function showCartModal(event) {
             event.stopPropagation(); // 防止點擊圖示時觸發其他事件
             // 只有在產品列表頁面點擊購物車圖示時才處理
             if(productPage.style.display !== 'none') {
                cartModal.style.display = 'flex';
                renderCart();
             }
        }
        
        function closeCartModal() {
            cartModal.style.display = 'none';
        }
        
        function showCheckoutPage() {
            productPage.style.display = 'none';
            checkoutPage.style.display = 'block';
            cartModal.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' }); // 滾動到頁面頂部
        }
        
        function showProductList() {
             productPage.style.display = 'block';
             checkoutPage.style.display = 'none';
        }
        
        // 頁面狀態切換事件
        cartIcon.addEventListener('click', showCartModal);
        checkoutButton.addEventListener('click', showCheckoutPage);
        cartModal.addEventListener('click', (e) => {
            if (e.target === cartModal) {
                closeCartModal();
            }
        });

        // --- 產品渲染與篩選邏輯 (修改處理邏輯) ---
        
        function getAvailableSpecs(productName) {
            const product = allProductsData[productName];
            const details = product ? product.details : {};
            const specs = {
                sizes: new Set(),
                colors: new Set(),
                detailsMap: {} // 儲存 (尺寸-顏色) -> 數量 的映射
            };
            
            for (const key in details) {
                const detail = details[key];
                // 確保尺寸和顏色不是 null 或 undefined
                const size = detail['尺寸'] || '無';
                const color = detail['顏色'] || '無';
                
                specs.sizes.add(size);
                specs.colors.add(color);
                specs.detailsMap[`${size}-${color}`] = detail['數量'];
            }
            
            // 確保 '無' 規格永遠在列表最前面
            const sortedSizes = [...specs.sizes].sort((a, b) => {
                if (a === '無') return -1;
                if (b === '無') return 1;
                return a.localeCompare(b);
            });
            const sortedColors = [...specs.colors].sort((a, b) => {
                if (a === '無') return -1;
                if (b === '無') return 1;
                return a.localeCompare(b);
            });
            
            return {
                sizes: sortedSizes,
                colors: sortedColors,
                detailsMap: specs.detailsMap
            };
        }
        
        function renderProducts(productsToRender) {
            productListDiv.innerHTML = '';
            showProductList(); 

            if (Object.keys(productsToRender).length === 0) {
                productListDiv.innerHTML = '<p style="text-align: center; width: 100%;">沒有找到相關產品。</p>';
                return;
            }

            for (const productName in productsToRender) {
                const productData = productsToRender[productName];
                const specs = getAvailableSpecs(productName);
                const firstPrice = productData.productInfo['售價'] || 'NT$ 價格待定';
                
                // 判斷是否為多規格：尺寸或顏色集合中任一個數量大於 1，或僅有 '無' 以外的單一規格
                const hasMultipleSpecs = (specs.sizes.length > 1 && !(specs.sizes.length === 2 && specs.sizes.has('無'))) || 
                                         (specs.colors.length > 1 && !(specs.colors.length === 2 && specs.colors.has('無')));
                
                // 如果是單一規格，需要確定規格名稱
                const singleSize = specs.sizes.values().next().value || '無';
                const singleColor = specs.colors.values().next().value || '無';
                
                const card = document.createElement('div');
                card.className = 'product-card';

                const photos = productData.productInfo['照片連結'] ? productData.productInfo['照片連結'].split(',').map(url => url.trim()).filter(url => url !== '') : [];
                let imagesHtml = '';
                if (photos.length > 0) {
                    // 使用 encodeURIComponent 確保 JSON 格式在 HTML 屬性中安全
                    const photosJson = JSON.stringify(photos).replace(/"/g, '&quot;'); 
                    imagesHtml = `<div class="product-images">
                        <img src="${photos[0]}" alt="${productName}" data-photos='${photosJson}'>
                    </div>`;
                }
                
                // 規格選擇器
                let specSelectorHtml = '';
                if (hasMultipleSpecs) {
                    specSelectorHtml = `
                        <div class="spec-selector">
                            <label for="size-${productName}">尺寸:</label>
                            <select id="size-${productName}" data-spec-type="size">
                                ${specs.sizes.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                            
                            <label for="color-${productName}">顏色:</label>
                            <select id="color-${productName}" data-spec-type="color">
                                ${specs.colors.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                            
                            <div class="stock-info" id="stock-info-${productName}">請選擇規格</div>
                            
                            <label for="qty-${productName}">數量:</label>
                            <input type="number" id="qty-${productName}" value="1" min="1" max="1" disabled>
                            
                            <button class="add-to-cart-btn" data-product-name="${productName}" data-price="${firstPrice}" disabled>加入購物車</button>
                        </div>
                    `;
                } else {
                    // 單一或無規格產品
                    const stock = specs.detailsMap[`${singleSize}-${singleColor}`] || 0;
                    const stockText = stock > 0 ? `庫存: ${stock}` : `<span class="out-of-stock">缺貨</span>`;
                    specSelectorHtml = `
                        <div class="spec-selector">
                            ${(singleSize !== '無' || singleColor !== '無') ? `<p>規格: ${singleSize}/${singleColor}</p>` : ''}
                            <p class="stock-info" id="stock-info-${productName}">${stockText}</p>
                            <label for="qty-${productName}">數量:</label>
                            <input type="number" id="qty-${productName}" value="1" min="1" max="${stock}" ${stock === 0 ? 'disabled' : ''}>
                            <button class="add-to-cart-btn" data-product-name="${productName}" data-price="${firstPrice}" data-size="${singleSize}" data-color="${singleColor}" ${stock === 0 ? 'disabled' : ''}>加入購物車</button>
                        </div>
                    `;
                }


                const cardContentHtml = `
                    ${imagesHtml}
                    <div class="product-info">
                        <h2>${productName}</h2>
                        <p><strong>分類:</strong> ${productData.productInfo['分類'] || '無'}</p>
                        <p class="price"><strong>售價:</strong> ${firstPrice}</p>
                        <p><strong>產品內容:</strong> ${productData.productInfo['產品內容說明'] || '無'}</p>
                        ${specSelectorHtml}
                    </div>
                `;

                card.innerHTML = cardContentHtml;
                productListDiv.appendChild(card);
                
                // --- 規格選擇連動邏輯 ---
                if (hasMultipleSpecs) {
                    const sizeSelect = card.querySelector(`#size-${productName}`);
                    const colorSelect = card.querySelector(`#color-${productName}`);
                    const qtyInput = card.querySelector(`#qty-${productName}`);
                    const stockInfoDiv = card.querySelector(`#stock-info-${productName}`);
                    const addToCartBtn = card.querySelector('.add-to-cart-btn');

                    const updateStock = () => {
                        const selectedSize = sizeSelect.value;
                        const selectedColor = colorSelect.value;
                        const stockKey = `${selectedSize}-${selectedColor}`;
                        const maxStock = specs.detailsMap[stockKey] || 0;
                        
                        stockInfoDiv.innerHTML = maxStock > 0 ? `庫存: ${maxStock}` : `該規格 ${selectedSize}/${selectedColor} <span class="out-of-stock">缺貨</span>`;
                        qtyInput.max = maxStock;
                        qtyInput.disabled = maxStock === 0;
                        
                        // 確保數量不超過新庫存
                        let currentQty = parseInt(qtyInput.value) || 1;
                        if (currentQty > maxStock) currentQty = maxStock > 0 ? maxStock : 1;
                        qtyInput.value = Math.max(1, currentQty); 
                        
                        addToCartBtn.disabled = maxStock === 0;
                        addToCartBtn.dataset.size = selectedSize;
                        addToCartBtn.dataset.color = selectedColor;
                    };

                    sizeSelect.addEventListener('change', updateStock);
                    colorSelect.addEventListener('change', updateStock);
                    qtyInput.addEventListener('input', () => {
                        // 確保輸入數量不超過庫存且至少為 1
                        const max = parseInt(qtyInput.max);
                        if (parseInt(qtyInput.value) > max) {
                            qtyInput.value = max;
                        }
                        if (parseInt(qtyInput.value) < 1 || isNaN(parseInt(qtyInput.value))) {
                            qtyInput.value = 1;
                        }
                    });

                    // 初始載入時更新庫存資訊
                    updateStock();
                }
                
                // --- 加入購物車按鈕事件 ---
                card.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    const name = btn.dataset.productName;
                    const price = btn.dataset.price;
                    let size = btn.dataset.size;
                    let color = btn.dataset.color;
                    let quantity;
                    
                    if (hasMultipleSpecs) {
                        quantity = parseInt(card.querySelector(`#qty-${name}`).value);
                    } else {
                        quantity = parseInt(card.querySelector(`#qty-${name}`).value);
                        size = singleSize; // 再次確保單一規格的取值
                        color = singleColor;
                    }

                    if (quantity > 0) {
                        addToCart(name, size, color, quantity, price);
                    } else {
                        alert('請選擇有效的數量！');
                    }
                });

                // --- Lightbox 事件 (不變) ---
                const imagesDiv = card.querySelector('.product-images');
                if (imagesDiv) {
                    const img = imagesDiv.querySelector('img');
                    if (img && photos.length > 0) {
                        // 由於 photosJson 已經安全處理，這裡要用 JSON.parse 讀取回來
                        const photosFromData = JSON.parse(img.getAttribute('data-photos').replace(/&quot;/g, '"'));
                        imagesDiv.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openLightbox(photosFromData);
                        });
                    }
                }
                
                // --- 外部連結點擊事件 (不變) ---
                const productLink = productData.productInfo['連結'];
                if (productLink && productLink.trim() !== '') {
                    const fullLink = productLink.startsWith('http://') || productLink.startsWith('https://') ? productLink : `https://${productLink}`;
                    card.addEventListener('click', (event) => {
                        // 只有點擊卡片其他部分才開啟連結
                        if (!event.target.closest('.spec-selector') && !event.target.closest('.product-images')) {
                             window.open(fullLink, '_blank');
                        }
                    });
                }
            }
        }
        
        // --- 篩選器與初始化邏輯 (不變) ---

        function filterProducts() {
            const searchText = searchBox.value.toLowerCase();
            const filteredProducts = {};
            
            for (const productName in allProductsData) {
                const productData = allProductsData[productName];
                const productCategory = productData.productInfo['分類'] || '無';
                
                // 使用邏輯或，確保搜尋範圍包含產品內容說明
                const matchesCategory = activeCategory === 'all' || productCategory.toLowerCase() === activeCategory;
                const description = productData.productInfo['產品內容說明'] || '';
                const matchesSearch = productName.toLowerCase().includes(searchText) || description.toLowerCase().includes(searchText);

                if (matchesCategory && matchesSearch) {
                    filteredProducts[productName] = productData;
                }
            }
            
            renderProducts(filteredProducts);
        }

        function createFilterTags(categories) {
            filtersDiv.innerHTML = '';
            const allTag = document.createElement('div');
            allTag.className = 'filter-tag active';
            allTag.textContent = '所有產品';
            allTag.dataset.category = 'all';
            filtersDiv.appendChild(allTag);

            categories.forEach(category => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.textContent = category;
                tag.dataset.category = category.toLowerCase();
                filtersDiv.appendChild(tag);
            });
            
            filtersDiv.addEventListener('click', (event) => {
                if (event.target.classList.contains('filter-tag')) {
                    document.querySelectorAll('.filter-tag').forEach(tag => tag.classList.remove('active'));
                    event.target.classList.add('active');
                    activeCategory = event.target.dataset.category;
                    filterProducts();
                }
            });
        }
        
        searchBox.addEventListener('input', filterProducts);

        // --- Lightbox 邏輯 (不變) ---

        function openLightbox(images, startIndex = 0) {
            lightboxImages = images;
            lightboxContent.innerHTML = '';
            images.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                lightboxContent.appendChild(img);
            });
            currentImageIndex = startIndex;
            showImage(currentImageIndex);
            lightbox.style.display = 'flex';
        }

        function showImage(index) {
            const images = lightboxContent.querySelectorAll('img');
            images.forEach((img, i) => {
                if (i === index) {
                    img.classList.add('active');
                } else {
                    img.classList.remove('active');
                }
            });
        }

        closeBtn.addEventListener('click', () => {
            lightbox.style.display = 'none';
        });

        prevBtn.addEventListener('click', () => {
            currentImageIndex = (currentImageIndex > 0) ? currentImageIndex - 1 : lightboxImages.length - 1;
            showImage(currentImageIndex);
        });

        nextBtn.addEventListener('click', () => {
            currentImageIndex = (currentImageIndex < lightboxImages.length - 1) ? currentImageIndex + 1 : 0;
            showImage(currentImageIndex);
        });


        // --- 資料載入與處理邏輯 (修正資料處理的健壯性) ---

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                productListDiv.innerHTML = '';

                if (!Array.isArray(data) || data.length === 0) {
                    productListDiv.innerHTML = '<p>目前沒有產品資料。</p>';
                    return;
                }
                
                const groupedProducts = data.reduce((acc, currentItem) => {
                    // 確保所有關鍵欄位都有預設值，防止取值錯誤
                    const productName = currentItem['產品名稱'] || '無標題';
                    const size = currentItem['尺寸'] || '無';
                    const color = currentItem['顏色'] || '無';
                    const quantity = parseInt(currentItem['數量']) || 0;
                    const category = currentItem['分類'] || '無分類';
                    const price = currentItem['我方售價'] || 'NT$ 價格待定';
                    const detailsKey = `${size}-${color}`;

                    if (!acc[productName]) {
                        acc[productName] = {
                            details: {},
                            productInfo: {
                                '售價': price,
                                '產品內容說明': currentItem['產品內容說明'] || '',
                                '連結': null,
                                '照片連結': currentItem['照片連結'] || '',
                                '分類': category
                            }
                        };
                    }
                    
                    // 確保價格是最新的或非空
                    if (price !== 'NT$ 價格待定') {
                         acc[productName].productInfo['售價'] = price;
                    }

                    // 處理連結
                    if (!acc[productName].productInfo['連結']) {
                        const linkString = currentItem['連結'] || '';
                        const matches = linkString.match(/https?:\/\/[^\s]+/g);
                        if (matches && matches.length > 0) {
                            acc[productName].productInfo['連結'] = matches[0];
                        }
                    }

                    if (!acc[productName].details[detailsKey]) {
                        acc[productName].details[detailsKey] = {
                            '尺寸': size,
                            '顏色': color,
                            '數量': 0
                        };
                    }

                    // 累加數量
                    acc[productName].details[detailsKey]['數量'] += quantity;

                    return acc;
                }, {});
                
                allProductsData = groupedProducts;
                
                // 處理分類標籤
                const categories = [...new Set(data.map(item => item['分類']).filter(Boolean))].sort();
                createFilterTags(categories);
                
                filterProducts(); // 初次渲染
                updateCartCount(); // 初始化購物車數量
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                productListDiv.innerHTML = '<p>載入資料失敗，請檢查 API 連結或瀏覽器控制台錯誤。</p>';
            });
    </script>

</body>
</html>
