<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯„è³£å–®å»ºç«‹ (åˆ·å–æ¨™ç±¤)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f4f4f9;
            --text-color: #333;
            --border-color: #ccc;
            --accent-color: #28a745;
            --danger-color: #dc3545;
            --loading-color: #ffc107;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: #fff; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            position: relative;
        }
        h1 { 
            color: var(--primary-color); 
            border-bottom: 2px solid var(--primary-color); 
            padding-bottom: 10px; 
            margin-bottom: 20px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        select, input[type="text"], input[type="number"] { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 15px; 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        .field-group { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .field-group > div { 
            flex: 1; 
            min-width: 0; 
        }
        .product-item { 
            border: 1px dashed var(--primary-color); 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 4px; 
            background-color: #f9f9ff; 
        }
        .product-item h3 { 
            margin-top: 0; 
            color: var(--primary-color); 
        }
        .product-actions { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
            margin-top: 10px; 
        }
        .add-btn, .remove-btn { 
            padding: 8px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            white-space: nowrap; 
        }
        .add-btn { 
            background-color: var(--accent-color); 
            color: white; 
        }
        .remove-btn { 
            background-color: var(--danger-color); 
            color: white; 
        }
        .submit-btn { 
            background-color: var(--primary-color); 
            color: white; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 4px; 
            font-size: 1.1rem; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 20px; 
        }
        
        #summary-container { 
            margin-top: 20px; 
            padding: 15px; 
            background-color: #e9ecef; 
            border-radius: 4px; 
        }
        .summary-row {
            display: flex;
            justify-content: flex-end;
            font-size: 1.2rem; 
            font-weight: bold;
            line-height: 1.5;
            text-align: right;
            gap: 20px;
        }
        .summary-row span:first-child {
            width: 150px;
            text-align: left;
        }
        .summary-row:last-child {
            border-top: 1px solid #ccc;
            padding-top: 5px;
            margin-top: 5px;
        }

        .disabled-ui { 
            opacity: 0.5;
            pointer-events: none;
        }

        /* æ¢ç¢¼è¼¸å…¥å€å¡Šçš„æ¨£å¼ */
        #barcode-input-group {
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #e6ffec;
        }
        #barcode-input-group input {
            border: 1px solid var(--accent-color);
            margin-bottom: 0;
            font-size: 1.1rem;
        }
        #barcode-input-group label {
            color: #000;
        }

        /* è¼‰å…¥æŒ‡ç¤ºå™¨ */
        #loading-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 8px;
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: bold;
        }
        .hidden {
            display: none !important;
        }


        /* ================================================= */
        /* RWD è¡Œå‹•è£ç½®å„ªåŒ– (Max Width: 600px)             */
        /* ================================================= */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            .field-group {
                flex-direction: column;
                gap: 0;
            }
            .field-group > div {
                flex: none; 
            }
            select, input[type="text"], input[type="number"] {
                margin-bottom: 10px; 
            }

            .field-group > div[style] {
                flex: 1 1 100% !important; 
            }
            
            .product-item .field-group {
                flex-direction: row; 
                flex-wrap: wrap; 
            }
            .product-item .field-group > div {
                flex-basis: calc(33.33% - 7px); 
            }
            
            .product-item .field-group:last-of-type {
                flex-direction: column; 
            }
            .product-item .field-group:last-of-type > div {
                flex-basis: 100%;
            }

            .summary-row {
                font-size: 1rem;
            }
            .summary-row span:first-child {
                width: auto;
            }
        }
    </style>
</head>
<body>

<div class="container" id="main-content">
    
    <div id="loading-indicator">
        <i class="fa-solid fa-spinner fa-spin"></i> è³‡æ–™è¼‰å…¥ä¸­... è«‹ç¨å€™
    </div>

    <h1>å¯„è³£å–®å»ºç«‹ (åˆ·å–æ¨™ç±¤)</h1>
    
    <div class="field-group disabled-ui" id="ecom-group">
        <div style="flex: 0 0 50%;"> 
            <label for="ecom-select">é¸æ“‡é›»å•†åç¨±</label>
            <select id="ecom-select">
                <option value="">-- è«‹é¸æ“‡ --</option>
            </select>
        </div>
    </div>
    
    <hr>
    
    <div id="barcode-input-group" class="disabled-ui">
        <label for="barcode-input">
            <i class="fa-solid fa-barcode"></i> æ¢ç¢¼æƒæ
            <span style="font-weight: normal; color: #555; font-size: 0.9em;">(è«‹åˆ·å…¥ç”¢å“æ¢ç¢¼ï¼Œç¨‹å¼ç¢¼åªè®€å–å³é‚Š 12 ä½é€²è¡Œæ¯”å°)</span>
        </label>
        <input type="text" id="barcode-input" placeholder="è«‹åˆ·å…¥ç”¢å“æ¢ç¢¼..." autocomplete="off" disabled>
    </div>

    <h2>ç”¢å“æ¸…å–®</h2>
    <div id="product-list-container">
        </div>

    <button class="add-btn" id="add-product-btn" disabled title="è«‹ä½¿ç”¨æ¢ç¢¼æƒææ–°å¢ç”¢å“">
        <i class="fa-solid fa-plus"></i> æ–°å¢ç”¢å“
    </button>

    <div id="summary-container">
        <div class="summary-row">
            <span>ç¸½æ•¸é‡å°è¨ˆ:</span> <span id="total-qty">0 ä»¶</span>
        </div>
        <div class="summary-row">
            <span>ç¸½é‡‘é¡å°è¨ˆ:</span> NT$ <span id="total-amount">0</span>
        </div>
    </div>

    <button class="submit-btn disabled-ui" id="submit-order-btn" disabled>
        æäº¤å¯„è³£å–®
    </button>
</div>

<script>
    // ã€é‡è¦ã€‘æ›¿æ›æˆæ‚¨çš„ Google Apps Script éƒ¨ç½² URL
    const API_URL = "https://script.google.com/macros/s/AKfycbyKANC6RockaftLdI114N5_OPkqlTZFcU9x5UHFsX7O0nneICwAW4-G0kR0zgu9Gh0iwA/exec"; 
    
    let allProductsData = []; 
    let cart = [];            

    // DOM å…ƒç´ 
    const loadingIndicator = document.getElementById('loading-indicator');
    const ecomGroup = document.getElementById('ecom-group');
    const ecomSelect = document.getElementById('ecom-select');
    const productListContainer = document.getElementById('product-list-container');
    const addProductBtn = document.getElementById('add-product-btn');
    const submitOrderBtn = document.getElementById('submit-order-btn');
    const totalAmountSpan = document.getElementById('total-amount');
    const totalQtySpan = document.getElementById('total-qty'); 
    const barcodeInputGroup = document.getElementById('barcode-input-group');
    const barcodeInput = document.getElementById('barcode-input'); 
    

    // Helper functions for UI state
    function enableUI() {
        loadingIndicator.classList.add('hidden');
        ecomGroup.classList.remove('disabled-ui');
        barcodeInputGroup.classList.remove('disabled-ui');
        submitOrderBtn.classList.remove('disabled-ui');
        
        barcodeInput.disabled = false;
        submitOrderBtn.disabled = false;
        
        // è¼‰å…¥æˆåŠŸå¾Œå°‡ç„¦é»ç§»è‡³æ¢ç¢¼è¼¸å…¥æ¡†
        barcodeInput.focus();
    }

    // ========== åˆå§‹åŒ–è¼‰å…¥è³‡æ–™ (ä¿®æ­£) ==========

    async function loadInitialData() {
        // åˆå§‹ç‹€æ…‹ï¼šé¡¯ç¤ºè¼‰å…¥ä¸­ï¼Œç¦ç”¨åŠŸèƒ½
        loadingIndicator.classList.remove('hidden');
        
        try {
            const response = await fetch(API_URL);
            const data = await response.json(); 

            if (data.status === 'success') {
                allProductsData = data.products;
                const ecomNames = Object.keys(data.ecomMap); 

                ecomNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    ecomSelect.appendChild(option);
                });
                
                // è¼‰å…¥æˆåŠŸï¼Œå•Ÿç”¨ UI
                enableUI();

            } else {
                alert('è¼‰å…¥è³‡æ–™å¤±æ•—ã€‚è«‹æª¢æŸ¥ Apps Script éŒ¯èª¤æ—¥èªŒã€‚éŒ¯èª¤è¨Šæ¯: ' + data.message);
                loadingIndicator.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> è³‡æ–™è¼‰å…¥å¤±æ•—';
                loadingIndicator.style.color = 'var(--danger-color)';
            }
        } catch (error) {
            console.error('API éŒ¯èª¤:', error);
            alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€Apps Script URL æˆ–å¾Œç«¯ CORS/JSON æ ¼å¼ã€‚'); 
            loadingIndicator.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> ç¶²è·¯é€£ç·šéŒ¯èª¤';
            loadingIndicator.style.color = 'var(--danger-color)';
        }
    }

    // ========== æ¢ç¢¼é¸å–é‚è¼¯ (æ ¸å¿ƒåŠŸèƒ½) ==========
    
    function findProductByBarcode(barcode) {
        // 1. æ¸…ç†è¼¸å…¥æ¢ç¢¼ï¼šç§»é™¤æ‰€æœ‰éæ•¸å­—å­—ç¬¦ (å¦‚ç©ºæ ¼ã€é€£å­—ç¬¦ç­‰)
        const cleanedBarcode = barcode.replace(/\D/g, ''); 
        
        // 2. æˆªå–æ¢ç¢¼å³é‚Š 12 ä½æ•¸å­—ä½œç‚ºåŒ¹é…éµ (æ­¤è™•ç¢ºä¿åªè®€å–å³é‚Š12ä½)
        const matchKey = cleanedBarcode.slice(-12);
        
        // 3. å°‹æ‰¾åŒ¹é…ç”¢å“ç·¨è™Ÿçš„ç”¢å“
        const matchedProduct = allProductsData.find(p => 
            // åŒ¹é…é‚è¼¯ï¼šå°‡ Sheet1 ä¸­çš„ç”¢å“ç·¨è™Ÿä¹Ÿæ¸…ç†ä¸¦æˆªå–å³é‚Š12ä½é€²è¡Œæ¯”å°
            ((p['ç”¢å“ç·¨è™Ÿ'] || '').toString().replace(/\D/g, '')).slice(-12) === matchKey && 
            p['æ•¸é‡'] > 0 // å¿…é ˆåœ¨åº«
        );
        
        if (matchedProduct) {
            // æ‰¾åˆ°åŒ¹é…ä¸”æœ‰åº«å­˜çš„ç”¢å“
            return {
                name: matchedProduct['ç”¢å“åç¨±'],
                size: matchedProduct['å°ºå¯¸'] || 'ç„¡å°ºå¯¸',
                color: matchedProduct['é¡è‰²'] || 'ç„¡é¡è‰²',
                itemNo: matchedProduct['ç”¢å“ç·¨è™Ÿ'],
                price: parseInt(matchedProduct['åƒ¹æ ¼'].toString().replace(/\D/g, '')) || 0
            };
        }
        return null;
    }
    
    function addProductByBarcode(barcode) {
        // æª¢æŸ¥ data æ˜¯å¦å·²è¼‰å…¥
        if (allProductsData.length === 0) {
            alert("è³‡æ–™å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™ã€‚");
            return;
        }

        const productInfo = findProductByBarcode(barcode);
        
        if (!productInfo) {
            alert(`æ‰¾ä¸åˆ°æ¢ç¢¼ç‚º ${barcode} ä¸”åœ¨åº«çš„ç”¢å“ã€‚è«‹ç¢ºèªæ¢ç¢¼å’Œåº«å­˜ã€‚`);
            barcodeInput.value = '';
            barcodeInput.focus();
            return;
        }

        // æª¢æŸ¥è©²ç”¢å“æ˜¯å¦å·²åœ¨è³¼ç‰©è»Šä¸­ (é¿å…é‡è¤‡æƒæ)
        const existingItem = cart.find(item => item.itemNo === productInfo.itemNo);
        if (existingItem) {
            alert(`ç”¢å“ ${productInfo.itemNo} å·²åœ¨æ¸…å–®ä¸­ã€‚`);
            barcodeInput.value = '';
            barcodeInput.focus();
            return;
        }

        // å°‡ç”¢å“åŠ å…¥è³¼ç‰©è»Š
        const newItem = {
            name: productInfo.name,
            size: productInfo.size,
            color: productInfo.color,
            itemNo: productInfo.itemNo,
            qty: 1, // æ•¸é‡å›ºå®šç‚º 1
            price: productInfo.price
        };
        cart.push(newItem);
        
        // æ¸²æŸ“æ–°é …ç›®ä¸¦æ›´æ–°ç¸½è¨ˆ
        renderItemAfterRemove(newItem, cart.length - 1); 
        calculateTotal();
        
        // æ¸…ç©ºè¼¸å…¥æ¡†æº–å‚™ä¸‹æ¬¡æƒæ
        barcodeInput.value = '';
        barcodeInput.focus();
    }
    
    // ========== æ ¸å¿ƒé‚è¼¯å‡½å¼ (è¨ˆç®—èˆ‡æ¸²æŸ“) ==========

    function calculateTotal() {
        const validCart = cart.filter(item => item.itemNo && item.qty > 0);
        
        const totalAmount = validCart.reduce((sum, item) => sum + item.price, 0); 
        const totalQty = validCart.length; 
        
        totalAmountSpan.textContent = totalAmount.toLocaleString('zh-TW');
        totalQtySpan.textContent = totalQty.toLocaleString('zh-TW') + ' ä»¶'; 
    }
    
    // ç¨ç«‹çš„æ¸²æŸ“å‡½å¼ï¼Œç”¨æ–¼æ–°å¢å’Œåˆªé™¤å¾Œé‡ç¹ª
    function renderItemAfterRemove(item, index) {
        const productItemDiv = document.createElement('div');
        productItemDiv.className = 'product-item';
        productItemDiv.dataset.index = index;

        productItemDiv.innerHTML = `
            <h3>ç”¢å“é …ç›® #${index + 1}</h3>
            <div class="field-group">
                <div><label>ç”¢å“åç¨±</label><input type="text" value="${item.name}" readonly></div>
                <div><label>å°ºå¯¸ åœ¨åº«</label><input type="text" value="${item.size}" readonly></div>
                <div><label>é¡è‰² åœ¨åº«</label><input type="text" value="${item.color}" readonly></div>
            </div>
            <div class="field-group">
                <div><label>ç”¢å“ç·¨è™Ÿ</label><input type="text" class="item-no-input" readonly value="${item.itemNo}"></div>
                <div><label>æ•¸é‡</label><input type="number" class="qty-input" min="1" max="1" value="1" readonly></div>
                <div><label>åƒ¹æ ¼</label><input type="text" class="price-input" readonly value="${item.price.toLocaleString('zh-TW')}"></div>
            </div>
            <div class="product-actions">
                <button class="remove-btn" data-index="${index}"><i class="fa-solid fa-trash"></i> åˆªé™¤</button>
            </div>
        `;
        
        // å¦‚æœæ˜¯æ–°å¢ï¼Œå°±æ·»åŠ åˆ°åˆ—è¡¨åº•éƒ¨
        if (index === productListContainer.children.length) {
            productListContainer.appendChild(productItemDiv);
        }
        
        const removeBtn = productItemDiv.querySelector('.remove-btn');
        removeBtn.addEventListener('click', () => {
             // é»æ“Šåˆªé™¤æ™‚ï¼Œé‡æ–°æ‰¾å‡ºæ­£ç¢ºçš„ç´¢å¼•
             const targetIndex = Array.from(productListContainer.children).indexOf(productItemDiv);
             if (targetIndex !== -1) {
                 removeProductItem(targetIndex);
             }
        });
    }

    // ========== å‹•ä½œå‡½å¼ ==========
    
    function removeProductItem(index) {
        cart.splice(index, 1);
        
        // åˆªé™¤å¾Œï¼Œæ¸…ç©ºå®¹å™¨ä¸¦é‡æ–°ç¹ªè£½æ‰€æœ‰é …ç›® (ç¢ºä¿ index æ­£ç¢º)
        productListContainer.innerHTML = '';
        cart.forEach((item, i) => {
             renderItemAfterRemove(item, i);
        });
        
        calculateTotal();
        barcodeInput.focus();
    }
    
    async function submitOrder() {
        if (!ecomSelect.value) {
            alert('è«‹é¸æ“‡é›»å•†åç¨±ï¼');
            ecomSelect.focus();
            return;
        }
        
        const validCart = cart.filter(item => item.itemNo && item.price > 0);
        if (validCart.length === 0) {
            alert('è«‹æƒæç”¢å“æ¢ç¢¼ä»¥æ–°å¢ç”¢å“ã€‚');
            return;
        }

        submitOrderBtn.disabled = true;
        submitOrderBtn.textContent = 'æäº¤ä¸­...';

        const totalAmount = validCart.reduce((sum, item) => sum + item.price, 0); 
        
        const payload = {
            ecomName: ecomSelect.value,
            totalAmount: totalAmount,
            cartItems: validCart
        };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain' 
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.status === "success") {
                alert(`ğŸ‰ å¯„è³£å–®æäº¤æˆåŠŸï¼è¨‚å–®ç·¨è™Ÿ: ${result.orderId}ã€‚ç¸½é‡‘é¡: NT$${totalAmount.toLocaleString('zh-TW')}`);
                
                // é‡ç½®è¡¨å–®
                ecomSelect.value = '';
                cart = [];
                productListContainer.innerHTML = ''; 
                calculateTotal();
                barcodeInput.focus();

            } else {
                alert('è¨‚å–®æäº¤å¤±æ•—ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚éŒ¯èª¤: ' + result.message);
            }

        } catch (error) {
            console.error('API å‘¼å«å¤±æ•—:', error);
            alert('ç¶²è·¯é€£ç·šéŒ¯èª¤æˆ–å¾Œå°æœå‹™ç„¡æ³•é€£æ¥ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        } finally {
            submitOrderBtn.disabled = false;
            submitOrderBtn.textContent = 'æäº¤å¯„è³£å–®';
        }
    }

    // ========== ç¶å®šèˆ‡åˆå§‹åŒ– ==========
    
    // ç¶å®šæ¢ç¢¼è¼¸å…¥äº‹ä»¶ï¼šç•¶ä½¿ç”¨è€…æŒ‰ä¸‹ Enter (æ¢ç¢¼æ©Ÿé€šå¸¸æœƒæ¨¡æ“¬ Enter)
    barcodeInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && barcodeInput.value.trim() !== '') {
            e.preventDefault(); 
            addProductByBarcode(barcodeInput.value.trim());
        }
    });

    // ç¦ç”¨æ‰‹å‹•æ–°å¢æŒ‰éˆ• (å¼·åˆ¶ä½¿ç”¨æ¢ç¢¼)
    addProductBtn.removeEventListener('click', () => {}); 
    
    submitOrderBtn.addEventListener('click', submitOrder);

    // åˆå§‹åŒ–è¼‰å…¥
    loadInitialData();

</script>
</body>
</html>