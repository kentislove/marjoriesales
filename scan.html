<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¢ç¢¼æ•¸å­—æƒæå™¨ V3 (æœ€çµ‚ç‰ˆ)</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script> 
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        input[type="file"] { display: none; }
        .upload-btn {
            background-color: #28a745; 
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
            margin-top: 10px;
        }
        #preview-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-top: 20px; 
            justify-content: center;
        }
        .preview-item { margin: 5px; border: 1px solid #ddd; padding: 5px; width: 150px; }
        .preview-img { max-width: 100%; height: auto; display: block; }
        .result-box { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ“± æ¢ç¢¼æ•¸å­—æƒæ (æœ¬åœ°è¾¨è­˜)</h2>
        <p>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå¯**ä¸€æ¬¡é¸å–å¤šå¼µ**æ¨™ç±¤åœ–ç‰‡æˆ–**æ‹ç…§**ï¼š</p>
        
        <label for="imageUpload" class="upload-btn">
            ğŸ“¸ é»æ“Šæ‹ç…§/é¸å–å¤šå¼µåœ–ç‰‡
        </label>
        <input type="file" id="imageUpload" accept="image/*" multiple>

        <div id="preview-container">
            </div>

        <button id="scanButton" onclick="scanAndUploadResults()" style="display:none; margin-top: 20px; padding: 10px 20px;" disabled>
            ğŸ’¾ å¯«å…¥ Sheets (<span id="fileCount">0</span> ç­†çµæœ)
        </button>
        
        <p id="statusMessage" style="color: blue; margin-top: 15px;">ç­‰å¾…ä¸Šå‚³...</p>

        <div class="result-box" id="result">
            <strong>æœ€æ–°çµæœï¼š</strong><br>
            <pre id="dataOutput">æ¢ç¢¼è¾¨è­˜çµæœå°‡é¡¯ç¤ºåœ¨æ­¤è™•ã€‚</pre>
        </div>
    </div>

    <script>
        // ã€â—é‡è¦ã€‘å°‡æ­¥é©Ÿ 1 è¤‡è£½çš„ Apps Script URL è²¼åœ¨é€™è£¡
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwZqRM3Gyb3KGYy1z8mplSc-a5LLP_1_Q80STbCthjvdkx3d5xOnUkUXCktuHx0sRoy/exec"; 
        
        const imageUpload = document.getElementById('imageUpload');
        const previewContainer = document.getElementById('preview-container');
        const scanButton = document.getElementById('scanButton');
        const fileCountSpan = document.getElementById('fileCount');
        const statusMessage = document.getElementById('statusMessage');
        const dataOutput = document.getElementById('dataOutput');
        
        let barcodeResults = []; // å„²å­˜æ‰€æœ‰åœ–ç‰‡çš„æ¢ç¢¼çµæœ
        
        // --- zxing-js åƒæ•¸èª¿æ•´ ---
        const hints = new Map();
        hints.set(ZXing.DecodeHintType.TRY_HARDER, true); 
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
            ZXing.BarcodeFormat.CODE_128, 
            ZXing.BarcodeFormat.EAN_13, 
            ZXing.BarcodeFormat.EAN_8,
            ZXing.BarcodeFormat.QR_CODE
        ]); 
        const codeReader = new ZXing.BrowserMultiFormatReader(hints);
        
        
        // 1. ç•¶ä½¿ç”¨è€…é¸å–åœ–ç‰‡æ™‚è§¸ç™¼
        imageUpload.onchange = async function(event) {
            const files = Array.from(event.target.files);
            
            if (files.length === 0) {
                statusMessage.textContent = "è«‹è‡³å°‘é¸å–ä¸€å¼µåœ–ç‰‡ã€‚";
                scanButton.style.display = 'none';
                return;
            }

            statusMessage.textContent = `å·²é¸å– ${files.length} å¼µåœ–ç‰‡ï¼Œæ­£åœ¨æœ¬åœ°è¾¨è­˜æ¢ç¢¼...`;
            scanButton.disabled = true;
            previewContainer.innerHTML = '';
            barcodeResults = []; 

            for (const file of files) {
                const imgElement = await readAndPreviewImage(file);
                await decodeBarcode(imgElement, file.name);
            }
            
            const foundCount = barcodeResults.length;
            if (foundCount > 0) {
                statusMessage.textContent = `âœ… æœ¬åœ°è¾¨è­˜å®Œæˆï¼æ‰¾åˆ° ${foundCount} çµ„æ¢ç¢¼çµæœã€‚`;
                scanButton.style.display = 'block';
                scanButton.disabled = false;
                fileCountSpan.textContent = foundCount;
                dataOutput.textContent = JSON.stringify(barcodeResults, null, 2);
            } else {
                statusMessage.textContent = "âŒ æœ¬åœ°è¾¨è­˜å¤±æ•—ï¼è«‹é‡æ–°æ‹æ”æ¸…æ™°åœ–ç‰‡ã€‚";
                scanButton.style.display = 'none';
            }
        };

        // è®€å–åœ–ç‰‡ä¸¦ç”¢ç”Ÿé è¦½åœ–
        function readAndPreviewImage(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-img';
                    itemDiv.appendChild(img);
                    
                    const p = document.createElement('p');
                    p.textContent = 'è¾¨è­˜ä¸­...';
                    p.style.fontSize = '0.8em';
                    itemDiv.appendChild(p);
                    
                    previewContainer.appendChild(itemDiv);
                    resolve(img);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // ä½¿ç”¨ zxing é€²è¡Œæ¢ç¢¼è¾¨è­˜
        async function decodeBarcode(imgElement, fileName) {
            const resultDisplay = imgElement.nextElementSibling;
            try {
                const result = await codeReader.decodeFromImage(imgElement);
                
                if (result) {
                    const barcodeData = result.getText();
                    const barcodeFormat = result.getBarcodeFormat().toString();
                    
                    resultDisplay.textContent = `æ¢ç¢¼: ${barcodeData}`;
                    resultDisplay.style.color = 'green';
                    
                    barcodeResults.push({
                        fileName: fileName,
                        barcodeData: barcodeData,
                        barcodeFormat: barcodeFormat
                    });
                } else {
                    resultDisplay.textContent = 'æœªæ‰¾åˆ°æ¢ç¢¼';
                    resultDisplay.style.color = 'red';
                }
            } catch (err) {
                resultDisplay.textContent = `è¾¨è­˜å¤±æ•—`;
                resultDisplay.style.color = 'red';
            }
        }

        // 2. æŒ‰ä¸‹å¯«å…¥ Sheets æŒ‰éˆ•å¾ŒåŸ·è¡Œ
        async function scanAndUploadResults() {
            if (barcodeResults.length === 0) {
                statusMessage.textContent = "æ²’æœ‰å¯å¯«å…¥çš„æ¢ç¢¼çµæœã€‚";
                return;
            }

            const count = barcodeResults.length;
            statusMessage.textContent = `æ­£åœ¨å°‡ ${count} ç­†çµæœå‚³è¼¸åˆ° Google Sheets...`;
            scanButton.disabled = true;
            dataOutput.textContent = 'å‚³è¼¸ä¸­...';

            try {
                // ç™¼å‡º Fetch è«‹æ±‚
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    // ä¿æŒ mode: 'no-cors'ï¼Œé€™æ˜¯è§£æ±ºç€è¦½å™¨è·¨åŸŸéŒ¯èª¤çš„é—œéµ
                    mode: 'no-cors', 
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ results: barcodeResults }) 
                });

                // â— å®¹éŒ¯æ©Ÿåˆ¶ï¼šå› ç‚º Sheets å¯«å…¥æˆåŠŸï¼Œä½†å‰ç«¯ç„¡æ³•è®€å–åˆ° Apps Script çš„æˆåŠŸ JSON
                //    æˆ‘å€‘å‡è¨­åªè¦è«‹æ±‚æˆåŠŸé€å‡ºï¼Œä¸”æ²’æœ‰é‡åˆ°ç¶²è·¯ç´šåˆ¥çš„éŒ¯èª¤ï¼Œå³ç‚ºæˆåŠŸã€‚
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                statusMessage.textContent = `âœ… æˆåŠŸå‚³è¼¸ ${count} ç­†è³‡æ–™åˆ° Google Sheetsã€‚`;
                dataOutput.textContent = `æˆåŠŸå‚³è¼¸ ${count} ç­†è³‡æ–™ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Google Sheetsã€‚`;
                
                // æˆåŠŸå¾Œæ¸…ç©ºä»‹é¢
                barcodeResults = [];
                imageUpload.value = null; 
                previewContainer.innerHTML = '';
                scanButton.style.display = 'none';
                fileCountSpan.textContent = '0';

            } catch (error) {
                // é€™è£¡åªæ•æ‰ç¶²è·¯é€£ç·šå¤±æ•—ã€URL éŒ¯èª¤ç­‰ç€è¦½å™¨ç´šåˆ¥çš„éŒ¯èª¤
                statusMessage.textContent = `âŒ é€£ç·šéŒ¯èª¤: ${error.message} (è«‹æª¢æŸ¥ç¶²è·¯æˆ– Apps Script URL)ï¼`;
                dataOutput.textContent = 'é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯æˆ– Apps Script URL æ˜¯å¦æ­£ç¢ºã€‚';
            } finally {
                scanButton.disabled = false;
            }
        }
    </script>
</body>
</html>
