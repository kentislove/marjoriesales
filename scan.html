<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¢ç¢¼æ•¸å­—æƒæå™¨ V2</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script> 
    <style>
        /* (æ¨£å¼éƒ¨åˆ†ä¿æŒä¸è®Š) */
        body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        input[type="file"] { display: none; }
        .upload-btn {
            background-color: #28a745; 
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
            margin-top: 10px;
        }
        #preview-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
            margin-top: 20px; 
            justify-content: center;
        }
        .preview-item { margin: 5px; border: 1px solid #ddd; padding: 5px; width: 150px; }
        .preview-img { max-width: 100%; height: auto; display: block; }
        .result-box { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ“± æ¢ç¢¼æ•¸å­—æƒæ (ç´”æœ¬åœ°è™•ç†)</h2>
        <p>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå¯**ä¸€æ¬¡é¸å–å¤šå¼µ**æ¨™ç±¤åœ–ç‰‡æˆ–**æ‹ç…§**ï¼š</p>
        
        <label for="imageUpload" class="upload-btn">
            ğŸ“¸ é»æ“Šæ‹ç…§/é¸å–å¤šå¼µåœ–ç‰‡
        </label>
        <input type="file" id="imageUpload" accept="image/*" multiple>

        <div id="preview-container">
            </div>

        <button id="scanButton" onclick="scanAndUploadResults()" style="display:none; margin-top: 20px; padding: 10px 20px;" disabled>
            ğŸ’¾ å¯«å…¥ Sheets (<span id="fileCount">0</span> ç­†çµæœ)
        </button>
        
        <p id="statusMessage" style="color: blue; margin-top: 15px;">ç­‰å¾…ä¸Šå‚³...</p>

        <div class="result-box" id="result">
            <strong>æœ€æ–°çµæœï¼š</strong><br>
            <pre id="dataOutput">æ¢ç¢¼è¾¨è­˜çµæœå°‡é¡¯ç¤ºåœ¨æ­¤è™•ã€‚</pre>
        </div>
    </div>

    <script>
        // ã€â—é‡è¦ã€‘å°‡æ‚¨çš„ Apps Script URL è²¼åœ¨é€™è£¡
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwZqRM3Gyb3KGYy1z8mplSc-a5LLP_1_Q80STbCthjvdkx3d5xOnUkUXCktuHx0sRoy/exec"; 
        
        const imageUpload = document.getElementById('imageUpload');
        const previewContainer = document.getElementById('preview-container');
        const scanButton = document.getElementById('scanButton');
        const fileCountSpan = document.getElementById('fileCount');
        const statusMessage = document.getElementById('statusMessage');
        const dataOutput = document.getElementById('dataOutput');
        
        let barcodeResults = []; // å„²å­˜æ‰€æœ‰åœ–ç‰‡çš„æ¢ç¢¼çµæœ
        
        // --- èª¿æ•´ zxing-js åƒæ•¸ä»¥å„ªåŒ–è¾¨è­˜ç‡ ---
        const hints = new Map();
        // å˜—è©¦æ›´ç©æ¥µåœ°å°‹æ‰¾æ¢ç¢¼
        hints.set(ZXing.DecodeHintType.TRY_HARDER, true); 
        // æŒ‡å®šåªå°‹æ‰¾å¸¸è¦‹çš„æ¢ç¢¼é¡å‹ (å¯é¸ï¼Œæœ‰åŠ©æ–¼æ’é™¤å¹²æ“¾)
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
            ZXing.BarcodeFormat.CODE_128, 
            ZXing.BarcodeFormat.EAN_13, 
            ZXing.BarcodeFormat.EAN_8,
            ZXing.BarcodeFormat.QR_CODE // å¦‚æœæ¨™ç±¤ä¸Šæœ‰ QR code
        ]); 
        
        const codeReader = new ZXing.BrowserMultiFormatReader(hints);
        
        
        // ç•¶ä½¿ç”¨è€…é¸å–åœ–ç‰‡æˆ–æ‹ç…§å®Œæˆæ™‚è§¸ç™¼
        imageUpload.onchange = async function(event) {
            const files = Array.from(event.target.files);
            
            if (files.length === 0) {
                statusMessage.textContent = "è«‹è‡³å°‘é¸å–ä¸€å¼µåœ–ç‰‡ã€‚";
                scanButton.style.display = 'none';
                return;
            }

            statusMessage.textContent = `å·²é¸å– ${files.length} å¼µåœ–ç‰‡ï¼Œæ­£åœ¨æœ¬åœ°è¾¨è­˜æ¢ç¢¼...`;
            scanButton.disabled = true;
            previewContainer.innerHTML = '';
            barcodeResults = []; 

            for (const file of files) {
                const imgElement = await readAndPreviewImage(file);
                // é€²è¡Œæ¢ç¢¼è¾¨è­˜
                await decodeBarcode(imgElement, file.name);
            }
            
            if (barcodeResults.length > 0) {
                statusMessage.textContent = `âœ… æœ¬åœ°è¾¨è­˜å®Œæˆï¼æ‰¾åˆ° ${barcodeResults.length} çµ„æ¢ç¢¼çµæœã€‚`;
                scanButton.style.display = 'block';
                scanButton.disabled = false;
                fileCountSpan.textContent = barcodeResults.length;
                dataOutput.textContent = JSON.stringify(barcodeResults, null, 2);
            } else {
                statusMessage.textContent = "âŒ æœ¬åœ°è¾¨è­˜å¤±æ•—ï¼è«‹é‡æ–°æ‹æ”æ¸…æ™°åœ–ç‰‡ã€‚";
                scanButton.style.display = 'none';
            }
        };

        // è®€å–åœ–ç‰‡ä¸¦ç”¢ç”Ÿé è¦½åœ–
        function readAndPreviewImage(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-img';
                    img.style.marginBottom = '5px';
                    itemDiv.appendChild(img);
                    
                    const p = document.createElement('p');
                    p.textContent = 'è¾¨è­˜ä¸­...';
                    p.style.fontSize = '0.8em';
                    itemDiv.appendChild(p);
                    
                    previewContainer.appendChild(itemDiv);
                    resolve(img);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // ä½¿ç”¨ zxing é€²è¡Œæ¢ç¢¼è¾¨è­˜
        async function decodeBarcode(imgElement, fileName) {
            const resultDisplay = imgElement.nextElementSibling;
            try {
                // ä½¿ç”¨ decodeFromImage æ­é…æˆ‘å€‘è¨­å®šçš„ hints
                const result = await codeReader.decodeFromImage(imgElement);
                
                if (result) {
                    const barcodeData = result.getText();
                    const barcodeFormat = result.getBarcodeFormat().toString();
                    
                    resultDisplay.textContent = `æ¢ç¢¼: ${barcodeData}`;
                    resultDisplay.style.color = 'green';
                    
                    barcodeResults.push({
                        fileName: fileName,
                        barcodeData: barcodeData,
                        barcodeFormat: barcodeFormat
                    });
                } else {
                    resultDisplay.textContent = 'æœªæ‰¾åˆ°æ¢ç¢¼';
                    resultDisplay.style.color = 'red';
                }
            } catch (err) {
                // é€™è£¡æ•æ‰çš„æ˜¯ç¨‹å¼ç¢¼åŸ·è¡ŒéŒ¯èª¤ï¼Œéè¾¨è­˜å¤±æ•—
                resultDisplay.textContent = `è¾¨è­˜å¤±æ•—`;
                resultDisplay.style.color = 'red';
            }
        }

        // æŒ‰ä¸‹å¯«å…¥ Sheets æŒ‰éˆ•å¾ŒåŸ·è¡Œ
        async function scanAndUploadResults() {
            if (barcodeResults.length === 0) {
                statusMessage.textContent = "æ²’æœ‰å¯å¯«å…¥çš„æ¢ç¢¼çµæœã€‚";
                return;
            }

            statusMessage.textContent = `æ­£åœ¨å°‡ ${barcodeResults.length} ç­†çµæœå‚³è¼¸åˆ° Google Sheets...`;
            scanButton.disabled = true;

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ results: barcodeResults }) 
                });

                const text = await response.text();
                
                let resultData;
                try {
                    resultData = JSON.parse(text); 
                } catch (e) {
                    resultData = {
                        status: 'error', 
                        message: 'å›å‚³éJSONæ ¼å¼ï¼Œè«‹æª¢æŸ¥ Apps Script Logã€‚', 
                    };
                }

                if (resultData.status === 'success') {
                    statusMessage.textContent = `âœ… æˆåŠŸå¯«å…¥ ${resultData.count} ç­†è³‡æ–™åˆ° Google Sheetsã€‚`;
                    dataOutput.textContent = `æˆåŠŸå¯«å…¥ ${resultData.count} ç­†è³‡æ–™ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Google Sheetsã€‚`;
                    
                    // æ¸…ç©ºå·²è™•ç†çš„çµæœ
                    barcodeResults = [];
                    imageUpload.value = null; 
                    previewContainer.innerHTML = '';
                    scanButton.style.display = 'none';
                    fileCountSpan.textContent = '0';

                } else {
                    statusMessage.textContent = `âŒ å¯«å…¥ Sheets å¤±æ•—ï¼éŒ¯èª¤è¨Šæ¯ï¼š${resultData.message}`;
                    dataOutput.textContent = JSON.stringify(resultData, null, 2);
                }

            } catch (error) {
                statusMessage.textContent = `âŒ é€£ç·šæˆ–è™•ç†éŒ¯èª¤: ${error.message}`;
                dataOutput.textContent = 'è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ– Apps Script URL æ˜¯å¦æ­£ç¢ºã€‚';
            } finally {
                scanButton.disabled = false;
            }
        }
    </script>
</body>
</html>
