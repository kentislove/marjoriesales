<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ Marjorieå¹´çµ‚æ¸…å€‰ï¼šé™æ™‚å…é‹ï¼Œå”®å®Œä¸è£œï¼æ¶è³¼æœ€å¾Œç¾è²¨</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600&family=Noto+Serif+TC:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-font: 'Noto Serif TC', serif;
            --secondary-font: 'Noto Sans TC', sans-serif;
            --text-color: #333;
            --subtle-text-color: #777;
            --border-color: #e0e0e0;
            --bg-color: #fafafa;
            --badge-bg: #333;
            --badge-text: #fff;
            --accent-color: #222;
            --button-bg: #000;
            --button-text: #fff;
            --button-hover-bg: #444;
            --header-bg: #fff;
            --cart-bg: #fff;
            --cart-shadow: rgba(0, 0, 0, 0.08);
            --overlay-bg: rgba(0, 0, 0, 0.65);
            --out-of-stock-color: #b00020;
            --error-color: #c40000;
            --tag-bg: #f4f4f4;
            --tag-text: #333;
            --tag-border: #ddd;
            --highlight-bg: #fffbe6;
            --float-btn-bg: #000;
            --float-btn-text: #fff;
        }

        body {
            font-family: var(--secondary-font);
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
        }

        header {
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        #header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 0;
        }

        .title-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        h1 {
            font-family: var(--primary-font);
            font-size: 2rem;
            font-weight: 500;
            color: var(--accent-color);
            margin: 0;
            line-height: 1.3;
            word-break: break-word;
        }

        .free-ship-badge {
            background-color: #e60012;
            color: #fff;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            line-height: 1.2;
        }

        .desc-row {
            font-size: 0.9rem;
            color: var(--subtle-text-color);
            line-height: 1.6;
        }

        main {
            max-width: 1200px;
            margin: 15px auto 80px auto;
            padding: 0 15px 50px 15px;
            position: relative;
        }

        .list-filter-bar {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--text-color);
        }

        .filter-group select {
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
            background-color: #fff;
            cursor: pointer;
        }

        .filter-group input[type="text"] {
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
            width: 180px;
        }

        .clear-filters-btn {
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 0.8rem;
            text-decoration: underline;
            cursor: pointer;
            padding: 0;
        }

        #product-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }

        .product-card {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            min-height: 100%;
            position: relative;
        }

        .product-images {
            width: 100%;
            aspect-ratio: 4 / 5;
            border-radius: 6px;
            overflow: hidden;
            background-color: #f8f8f8;
            border: 1px solid var(--border-color);
            margin-bottom: 12px;
            position: relative;
        }

        .product-images img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .image-indicator {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background-color: rgba(0,0,0,0.6);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            line-height: 1.2;
        }

        .product-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .product-info h2 {
            font-family: var(--primary-font);
            font-size: 1.5rem;
            margin-bottom: 5px;
            margin-top: 0;
            color: #1a1a1a;
        }

        .product-info p {
            line-height: 1.6;
            margin: 5px 0;
        }
        
        .product-info .price {
            font-size: 1.2rem;
            color: var(--error-color);
            font-weight: 500;
            margin-bottom: 10px;
        }
        .product-info .original-price {
            color: var(--subtle-text-color);
            font-size: 0.9rem;
            text-decoration: line-through;
            margin: 5px 0;
        }

        .spec-selector {
            border-top: 1px solid var(--border-color);
            margin: 15px 0;
            padding-top: 15px;
        }

        .spec-selector label {
            display: inline-block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-right: 5px;
        }

        .spec-selector select,
        .spec-selector input[type="number"] {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
            margin-right: 8px;
            min-width: 60px;
            padding: 5px 8px;
        }

        .spec-selector .stock-info {
            color: var(--subtle-text-color);
            font-size: 0.85rem;
            margin: 8px 0;
        }

        .spec-selector .out-of-stock {
            color: var(--out-of-stock-color);
            font-weight: 500;
        }

        .spec-selector .add-to-cart-btn {
            background-color: var(--button-bg);
            border: none;
            border-radius: 4px;
            color: var(--button-text);
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            padding: 8px 10px;
        }

        .spec-selector .add-to-cart-btn[disabled] {
            background-color: #aaa;
            cursor: not-allowed;
        }

        .to-top-btn {
            background-color: var(--float-btn-bg);
            border: none;
            border-radius: 20px;
            bottom: 70px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            color: var(--float-btn-text);
            cursor: pointer;
            font-size: 1.2rem;
            height: 40px;
            line-height: 40px;
            position: fixed;
            right: 15px;
            text-align: center;
            width: 40px;
            z-index: 999;
        }

        /* --- æµ®å‹•å´é‚Šæ¬„æ¨£å¼ --- */
        #float-actions {
            position: fixed;
            top: 20px; /* è·é›¢é ‚éƒ¨ */
            right: 0;
            z-index: 1010; /* é«˜æ–¼ header */
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .float-action-item {
            display: flex;
            align-items: center;
            justify-content: flex-end; 
            background-color: transparent; 
            border: 1px solid var(--border-color); 
            color: var(--button-bg); 
            padding: 6px; 
            border-radius: 4px 0 0 4px; 
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1.2;
            cursor: pointer;
            text-decoration: none;
            overflow: hidden;
            position: relative; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 

            /* çµ±ä¸€åˆå§‹å°ºå¯¸ï¼š44px x 44px */
            width: 44px; 
            height: 44px;
            
            background-color: #fff; 
            
            transition: width 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }
        
        /* æ‡¸åœæ™‚ï¼šå¯¬åº¦å¢åŠ ï¼Œä¿æŒå¾½ç« ç©ºé–“ */
        .float-action-item:hover {
            width: 134px; /* ä¿æŒå±•é–‹å¾Œå¯¬åº¦ (130px + 4px å¢é‡) */
            background-color: var(--button-bg); 
            color: var(--button-text); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .float-action-item i {
            /* åœ–ç¤ºå°ºå¯¸ç¶­æŒåŸå§‹ 1.2rem */
            font-size: 1.2rem; 
            position: absolute; 
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--button-bg); 
            transition: color 0.3s ease;
        }
        
        /* æ‡¸åœæ™‚ï¼Œåœ–ç¤ºé¡è‰²è®Šç‚ºç™½è‰² */
        .float-action-item:hover i {
            color: var(--button-text);
        }

        /* æ–‡å­—å…§å®¹ */
        .float-action-item .button-text {
            white-space: nowrap;
            overflow: hidden;
            opacity: 0;
            pointer-events: none; 
            transition: opacity 0.3s ease;
            text-align: left;
            padding-left: 8px; 
            flex-grow: 1;
        }
        
        /* æ‡¸åœæ™‚ï¼Œæ–‡å­—é¡¯ç¤ºå‡ºä¾† */
        .float-action-item:hover .button-text {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* --- è³¼ç‰©è»Šæ•¸é‡å¾½ç« èª¿æ•´ (ç¢ºä¿ä¸è¢«é®æ“‹) --- */
        #float-cart-count {
            /* åˆå§‹ä½ç½®ï¼šä¿æŒåœ¨æœªå±•é–‹æŒ‰éˆ•çš„å³ä¸Šè§’ (top:-5px; right:-5px) */
            position: absolute;
            top: -5px;
            right: -5px; 
            
            background-color: #e60012; 
            color: #fff;
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            border-radius: 9px;
            padding: 0 5px;
            z-index: 10;
            
            transition: right 0.3s ease, top 0.3s ease;
        }
        
        /* æ‡¸åœæ™‚ï¼šå°‡å¾½ç« ä½ç½®ç§»åˆ°å±•é–‹å¾ŒæŒ‰éˆ•çš„æ–°å³ä¸Šè§’é‚Šç·£ (ç¶­æŒ top/right: 4px çš„è¦–è¦ºé‚Šè·) */
        .float-action-item:hover #float-cart-count {
            right: 4px; /* è²¼åˆå±•é–‹å¾Œçš„å³é‚Šæ¡† */
            top: 4px;   /* è²¼åˆå±•é–‹å¾Œçš„ä¸Šé‚Šæ¡† */
        }


        /* --- Cart Drawer --- (ä»¥ä¸‹ä¿æŒä¸è®Š) */
        #cart-overlay {
            position: fixed;
            inset: 0;
            background-color: var(--overlay-bg);
            display: none;
            z-index: 2000;
        }

        #cart-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 360px;
            max-width: 90%;
            height: 100vh;
            background-color: var(--cart-bg);
            box-shadow: -4px 0 20px var(--cart-shadow);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 2001;
            transform: translateX(100%);
            transition: transform 0.25s ease;
        }

        #cart-drawer.open {
            transform: translateX(0);
        }

        #cart-header {
            border-bottom: 1px solid var(--border-color);
            padding: 15px;
            background-color: #fff;
        }

        #cart-header-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

        #cart-title-block {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 0;
        }

        #cart-title-row {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 8px;
        }

        #cart-title-row h2 {
            font-size: 1.2rem;
            margin: 0;
            font-weight: 600;
        }

        #cart-count-inline {
            background-color: #000;
            color: #fff;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            line-height: 1.2;
        }

        #cart-sub {
            font-size: 0.8rem;
            line-height: 1.4;
            color: var(--subtle-text-color);
        }

        #cart-close-btn {
            background: none;
            border: none;
            font-size: 1rem;
            line-height: 1;
            cursor: pointer;
            color: var(--subtle-text-color);
        }

        #cart-items {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .cart-item {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .cart-item-header {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            line-height: 1.4;
        }

        .cart-item-title {
            font-weight: 600;
        }

        .cart-item-remove {
            background: none;
            border: none;
            color: var(--error-color);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .cart-item-detail {
            font-size: 0.8rem;
            color: var(--subtle-text-color);
        }

        .cart-item-qty-row {
            margin-top: 8px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .cart-item-qty-row input[type="number"] {
            width: 60px;
            padding: 4px 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .line-total {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--accent-color);
            margin-left: auto;
        }

        #cart-summary {
            border-top: 1px solid var(--border-color);
            padding: 15px;
            background-color: #fff;
        }

        #subtotal-row, #shipping-row, #total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        #total-row {
            font-weight: 600;
            font-size: 1rem;
        }

        #free-ship-hint {
            font-size: 0.8rem;
            color: var(--subtle-text-color);
            line-height: 1.4;
        }

        #checkout-section {
            border-top: 1px solid var(--border-color);
            padding: 15px;
            background-color: #fff;
        }

        #checkout-btn {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            padding: 10px 12px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
        }
        /* --- Checkout Overlay (å•å·æ”¶ä»¶è³‡è¨Š) --- */
        #checkout-overlay {
            position: fixed;
            inset: 0;
            background-color: var(--overlay-bg);
            display: none;
            z-index: 3000;
        }

        #checkout-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 1px solid var(--border-color);
            z-index: 3001;
        }

        #checkout-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            background-color: #fff;
        }

        #checkout-header h2 {
            margin: 0;
            font-size: 1.2rem;
            line-height: 1.4;
        }

        #checkout-subtext {
            font-size: 0.8rem;
            color: var(--subtle-text-color);
            margin-top: 4px;
            line-height: 1.4;
        }

        #checkout-form {
            padding: 15px;
            font-size: 0.9rem;
        }

        .checkout-field-group {
            margin-bottom: 12px;
        }

        .checkout-field-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .checkout-field-group input,
        .checkout-field-group select,
        .checkout-field-group textarea {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
            box-sizing: border-box;
        }

        .checkout-inline-row {
            display: flex;
            gap: 8px;
        }

        .checkout-inline-row .checkout-field-group {
            flex: 1;
            margin-bottom: 0;
        }

        #cod-warning,
        #shipping-warning,
        #extra-hints {
            background-color: var(--highlight-bg);
            border-left: 4px solid var(--accent-color);
            padding: 8px 10px;
            font-size: 0.8rem;
            line-height: 1.5;
            color: var(--accent-color);
            border-radius: 4px;
            margin-bottom: 12px;
        }

        #recipient-store-group {
            display: none;
        }

        #checkout-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: #fff;
        }

        #submit-order-btn {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            padding: 10px 12px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
        }

        #submit-order-btn[disabled] {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #close-checkout-btn {
            background: none;
            border: none;
            color: var(--subtle-text-color);
            font-size: 0.8rem;
            cursor: pointer;
            padding-top: 8px;
            text-decoration: underline;
            display: block;
            margin: 0 auto;
        }

        /* åº—åˆ°åº—ä»˜æ¬¾èªªæ˜å€å¡Š */
        .line-contact-box {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            font-size: 0.8rem;
        }
        .line-contact-box img {
            max-width: 140px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 8px;
        }
        .line-contact-box p {
            margin: 4px 0;
            line-height: 1.4;
            font-size: 0.8rem;
        }
        .bank-box {
            background: #fffbe6;
            border-left: 4px solid #000;
            border-radius: 4px;
            padding: 10px;
            font-size: 0.8rem;
            line-height: 1.5;
            margin-top: 10px;
        }
        .bank-box strong {
            font-weight: 600;
        }

        /* Mobile responsive tweaks */
        @media (max-width: 768px) {
            header {
                padding: 12px;
            }

            #header-container {
                flex-direction: column;
                align-items: stretch;
                gap: 8px; 
            }

            .header-left {
                order: 1; 
            }

            .header-actions {
                display: none; 
            }

            .status-row {
                text-align: left;
                font-size: 0.75rem; 
                line-height: 1.2;
                display: flex;
            }

            main {
                /* ç¸®å°ä¸»å…§å®¹å€å·¦å³é‚Šè· */
                margin-top: 10px;
                padding: 0 8px 50px 8px; /* å·¦å³é‚Šè·å¾ 15px ç¸®å°åˆ° 8px */
            }

            .list-filter-bar {
                align-items: flex-start;
                flex-direction: column;
            }

            .filter-group {
                flex-wrap: nowrap;
                justify-content: space-between;
                width: 100%;
            }

            .filter-group select,
            .filter-group input[type="text"] {
                flex-grow: 1;
            }

            #product-list {
                /* ç¸®å°å¡ç‰‡é–“è· */
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 10px; /* ç¶²æ ¼é–“è·å¾ 20px ç¸®å°åˆ° 10px */
            }

            .product-card {
                /* ç¸®å°å¡ç‰‡å…§éƒ¨é‚Šè· */
                padding: 10px; /* å¡ç‰‡å…§éƒ¨é‚Šè·å¾ 15px ç¸®å°åˆ° 10px */
            }

            .product-info h2 {
                font-size: 1.2rem;
            }

            .spec-selector .add-to-cart-btn {
                text-align: center;
                width: 100%;
            }

            h1 {
                font-size: 1.8rem; 
                margin-bottom: 0;
            }

            .desc-row {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>

<div id="float-actions">
    <button id="cart-float-btn" class="float-action-item">
        <span class="button-text">è³¼ç‰©è»Š</span>
        <i class="fa-solid fa-cart-shopping"></i> 
        <span id="float-cart-count">0</span>
    </button>
    
    <a id="line-btn" class="float-action-item" href="https://lin.ee/E6oixVD" target="_blank">
        <span class="button-text">LINE@å®¢æœ</span>
        <i class="fa-brands fa-line"></i> 
    </a>
</div>

<header>
    <div id="header-container">
        <div class="header-left">
            <div class="title-row">
                <h1>å¹´çµ‚ç¾è²¨æ¸…å€‰</h1>
                <span class="free-ship-badge">æ»¿ 1000 / 2000 äº«å…é‹ğŸ”¥</span>
            </div>
            <div class="desc-row">
                âš ï¸ ç¾è²¨å”®å®Œä¸è£œï¼è«‹å…ˆä¸‹å–®ï¼Œä¸¦ç”¨ LINE@ å®¢æœçµå–®ã€‚
            </div>
        </div>

        <div class="status-row">
            <div>æœ€å¾Œç¾è²¨ ğŸ“¦ å…¨å®¶/å®…é…/é¢äº¤</div>
        </div>
    </div>
</header>

<main>

    <div class="list-filter-bar">
        <div class="filter-group">
            <label for="category-filter">åˆ†é¡</label>
            <select id="category-filter">
                <option value="">å…¨éƒ¨</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="search-input">æœå°‹</label>
            <input type="text" id="search-input" placeholder="è¼¸å…¥å•†å“åç¨±é—œéµå­—">
        </div>

        <div class="filter-group">
            <label for="stock-filter">åº«å­˜</label>
            <select id="stock-filter">
                <option value="">ä¸é™</option>
                <option value="in_stock">æœ‰è²¨</option>
                <option value="out_of_stock">ç¼ºè²¨</option>
            </select>
        </div>

        <button class="clear-filters-btn" id="clear-filters-btn">æ¸…é™¤ç¯©é¸</button>
    </div>

    <div id="product-list">
        </div>
</main>

<button class="to-top-btn" id="to-top-btn" title="å›é ‚éƒ¨">
    <i class="fa-solid fa-arrow-up"></i>
</button>

<div id="cart-overlay"></div>
<div id="cart-drawer">
    <div id="cart-header">
        <div id="cart-header-row">
            <div id="cart-title-block">
                <div id="cart-title-row">
                    <h2>è³¼ç‰©è»Š</h2>
                    <span id="cart-count-inline">0 ä»¶</span>
                </div>
                <div id="cart-sub">
                    ç¢ºèªå“é …èˆ‡æ•¸é‡å¾Œï¼ŒæŒ‰ã€Œæˆ‘è¦ä¸‹å–®ã€å¡«å¯«æ”¶ä»¶è³‡è¨Šçµ¦å°ç·¨
                </div>
            </div>

            <button id="cart-close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>

    <div id="cart-items">
        <p style="text-align:center; color:#777; font-size:0.9rem;">è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„</p>
    </div>

    <div id="cart-summary">
        <div id="subtotal-row">
            <span>å•†å“å°è¨ˆ</span>
            <strong id="subtotal-amount">NT$0</strong>
        </div>
        <div id="shipping-row">
            <span>é‹è²»</span>
            <strong id="shipping-amount">å°šæœªé¸æ“‡é…é€</strong>
        </div>
        <div id="total-row">
            <span>åˆè¨ˆ</span>
            <strong id="total-amount">NT$0</strong>
        </div>
        <div id="free-ship-hint">
            åŒ¯æ¬¾+å…¨å®¶åº—åˆ°åº—ï¼šæ»¿1000å…é‹<br>
            å–è²¨ä»˜æ¬¾ï¼šæ»¿2000å…é‹<br>
            å®…é…145å›ºå®š
        </div>
    </div>

    <div id="checkout-section">
        <button id="checkout-btn">æˆ‘è¦ä¸‹å–® âœ</button>
    </div>
</div>

<div id="checkout-overlay"></div>
<div id="checkout-modal">
    <div id="checkout-header">
        <h2>å¡«å¯«æ”¶ä»¶è³‡è¨Š</h2>
        <div id="checkout-subtext">
            æˆ‘å€‘æœƒç”¨é€™ä»½è³‡è¨Šå¹«ä½ ä¿ç•™åº«å­˜ï¼Œä¸¦å›å‚³ä»˜æ¬¾ / å¯„ä»¶è³‡è¨Šçµ¦ä½ 
        </div>
    </div>

    <form id="checkout-form">
        <div id="cod-warning" style="display:none;"></div>
        <div id="shipping-warning" style="display:none;"></div>

        <div class="checkout-field-group">
            <label>ä½ çš„ LINE ID / è¯çµ¡æ–¹å¼ï¼ˆå¿…å¡«ï¼‰</label>
            <input type="text" id="contact" placeholder="LINE ID æˆ–é›»è©±" required>
        </div>

        <div class="checkout-field-group">
            <label>æ”¶ä»¶äººå§“åï¼ˆå¿…å¡«ï¼‰</label>
            <input type="text" id="recipient-name" required>
        </div>

        <div class="checkout-field-group">
            <label>é¸æ“‡é…é€æ–¹å¼ï¼ˆå¿…å¡«ï¼‰</label>
            <select id="shipping-method" required>
                <option value="">--è«‹é¸æ“‡--</option>
                <option value="cvs_payfirst">åŒ¯æ¬¾ + å…¨å®¶åº—åˆ°åº—ï¼ˆæ»¿1000å…é‹ï¼‰</option>
                <option value="cvs_cod">è¶…å•†å–è²¨ä»˜æ¬¾ + å…¨å®¶åº—åˆ°åº—ï¼ˆæ»¿2000å…é‹ï¼‰</option>
                <option value="home_delivery">å®…é…åˆ°åºœï¼ˆé‹è²»145ï¼ŒåŒ¯æ¬¾å¾Œå‡ºè²¨ï¼‰</option>
                <option value="self_pickup">é¢äº¤è‡ªå–ï¼ˆå°åŒ—å¸‚ï¼ŒåŒ¯æ¬¾å¾Œä¿ç•™ï¼‰</option>
            </select>
        </div>

        <div class="checkout-field-group" id="recipient-store-group">
            <label>å…¨å®¶é–€å¸‚åç¨± / åº—è™Ÿï¼ˆè¶…å•†æ”¶è²¨å¿…å¡«ï¼‰</label>
            <input type="text" id="recipient-store" placeholder="ä¾‹å¦‚ï¼šå…¨å®¶ å¤§å®‰æ¨‚é–€å¸‚ / åº—è™Ÿ123456">
        </div>

        <div class="checkout-field-group">
            <label>æ”¶ä»¶åœ°å€ï¼ˆå®…é…/é¢äº¤è€…å¿…å¡«ï¼‰</label>
            <input type="text" id="recipient-address" placeholder="ç¸£å¸‚/å€ + è©³ç´°åœ°å€ æˆ– å¸Œæœ›é¢äº¤åœ°é»/æ™‚æ®µ">
        </div>

        <div class="checkout-field-group">
            <label>å‚™è¨»ï¼ˆå°ºå¯¸ã€é¡è‰²æ²’è²¨å¯æ¥å—æ›¿ä»£ï¼Ÿæ™‚é–“é™åˆ¶ï¼Ÿï¼‰</label>
            <textarea id="extra-note" rows="3" placeholder="ä¾‹å¦‚ï¼šå¦‚æœç±³ç™½Sç¼ºè²¨å¯ä»¥æ”¹æ‹¿ç±³ç™½Mï¼›12/30å‰è¦æ”¶åˆ°ç•¶ç¦®ç‰©ï½"></textarea>
        </div>

        <div id="extra-hints" style="display:none;"></div>
    </form>

    <div id="checkout-footer">
        <button id="submit-order-btn">é€å‡ºè¨‚å–®éœ€æ±‚</button>
        <button id="close-checkout-btn" type="button">å…ˆä¸è¦ï¼Œæˆ‘å†é€›é€›</button>
    </div>
</div>

<script>
(function() {
    // ========== å¸¸æ•¸è¨­å®š ==========
    // ğŸš¨ é€™æ˜¯æ‚¨æŒ‡å®šçš„éƒ¨ç½²ç¶²å€ ğŸš¨
    const apiUrl = "https://script.google.com/macros/s/AKfycbz_Fp1fKjKOpbgfPlmZNKWXEG16-ZjquU48PXkNYKVDByfDXZpBLqjLsuTQPw_0_yJz/exec";

    // ğŸšš æ–°ç‰©æµè¦å‰‡
    const COST_CVS = 60;           // å…¨å®¶åº—åˆ°åº—åŸºæœ¬é‹è²»
    const THRESHOLD_PAYFIRST = 1000; // åŒ¯æ¬¾+å…¨å®¶ å…é‹é–€æª»
    const THRESHOLD_COD = 2000;      // å–è²¨ä»˜æ¬¾+å…¨å®¶ å…é‹é–€æª»
    const COST_HOME = 145;         // å®…é…å›ºå®š
    const COST_SELF = 0;           // é¢äº¤å›ºå®š0

    // localStorage key
    const CART_STORAGE_KEY = "flashsale_cart_v1";

    // ========== DOM ==========
    const productListDiv = document.getElementById('product-list');
    const categoryFilter = document.getElementById('category-filter');
    const stockFilter = document.getElementById('stock-filter');
    const searchInput = document.getElementById('search-input');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');

    const toTopBtn = document.getElementById('to-top-btn');

    // ä¿®æ­£ DOM è®Šæ•¸æŒ‡å‘æ–°çš„æµ®å‹•æŒ‰éˆ• ID
    const cartBtn = document.getElementById('cart-float-btn'); 
    const cartCount = document.getElementById('float-cart-count'); 

    const cartCountInline = document.getElementById('cart-count-inline');
    const cartOverlay = document.getElementById('cart-overlay');
    const cartDrawer = document.getElementById('cart-drawer');
    const cartItemsDiv = document.getElementById('cart-items');
    const cartCloseBtn = document.getElementById('cart-close-btn');

    const subtotalAmountSpan = document.getElementById('subtotal-amount');
    const shippingAmountSpan = document.getElementById('shipping-amount');
    const totalAmountSpan = document.getElementById('total-amount');
    const freeShipHintDiv = document.getElementById('free-ship-hint');

    const checkoutBtn = document.getElementById('checkout-btn');
    const checkoutOverlay = document.getElementById('checkout-overlay');
    const checkoutModal = document.getElementById('checkout-modal');
    const submitOrderBtn = document.getElementById('submit-order-btn');
    const closeCheckoutBtn = document.getElementById('close-checkout-btn');
    const checkoutForm = document.getElementById('checkout-form');

    const shippingMethodSelect = document.getElementById('shipping-method');
    const codWarningDiv = document.getElementById('cod-warning');
    const shippingWarningDiv = document.getElementById('shipping-warning');
    const extraHintsDiv = document.getElementById('extra-hints');
    const recipientStoreGroup = document.getElementById('recipient-store-group');
    const recipientStoreInput = document.getElementById('recipient-store');
    const recipientAddressInput = document.getElementById('recipient-address');

    // ========== ç‹€æ…‹ ==========
    let allProductsData = {}; // { ç”¢å“åç¨±: { productInfo: {...}, details: {...} } }
    let cart = []; // [{ name, size, color, qty, price }, ...]
    // ç”¨ä¾†é¡¯ç¤ºç›®å‰åœ¨è©¦ç®—å“ªå€‹é‹é€æ–¹å¼ï¼ˆå½±éŸ¿è³¼ç‰©è»Šå³å´å°è¨ˆå€ï¼‰
    let currentShippingModeForSummary = "";

    // ========== localStorage å·¥å…· ==========
    function loadCartFromStorage() {
        try {
            const raw = localStorage.getItem(CART_STORAGE_KEY);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
                return parsed;
            }
        } catch(e){}
        return [];
    }

    function saveCartToStorage() {
        localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
    }

    function clearCartStorage() {
        localStorage.removeItem(CART_STORAGE_KEY);
    }

    // ========== å·¥å…·å‡½å¼ ==========
    function getSafeId(name) {
        return name.replace(/[^a-zA-Z0-9_-]/g, '_');
    }

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function openCart() {
        cartOverlay.style.display = 'block';
        cartDrawer.classList.add('open');
        renderCart();
    }

    function closeCart() {
        cartOverlay.style.display = 'none';
        cartDrawer.classList.remove('open');
    }

    function openCheckout() {
        if (cart.length === 0) {
            alert('è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„å”·ï¼');
            return;
        }

        checkoutOverlay.style.display = 'block';
        checkoutModal.style.display = 'block';

        codWarningDiv.style.display = 'none';
        codWarningDiv.innerHTML = '';

        shippingWarningDiv.style.display = 'none';
        shippingWarningDiv.innerHTML = '';

        extraHintsDiv.style.display = 'none';
        extraHintsDiv.innerHTML = '';
        
        // ç¢ºä¿é‡æ–°é–‹å•Ÿæ™‚ï¼Œé‹è²» summary ä½¿ç”¨ä¸Šæ¬¡çš„é¸æ“‡
        currentShippingModeForSummary = shippingMethodSelect.value;
        renderCart(); 
    }

    function closeCheckout() {
        checkoutOverlay.style.display = 'none';
        checkoutModal.style.display = 'none';
        // å¯é¸ï¼šé‡ç½®è¡¨å–®å’Œæç¤ºè¨Šæ¯
        checkoutForm.reset();
        shippingMethodSelect.dispatchEvent(new Event('change'));
    }

    function getCartSubtotal() {
        return cart.reduce((sum, item) => {
            // ç§»é™¤åƒ¹æ ¼ä¸­çš„éæ•¸å­—å­—å…ƒ (ä¾‹å¦‚ 'NT$' æˆ–ç©ºæ ¼)
            const unitPrice = parseInt(String(item.price).replace(/\D/g, '')) || 0; 
            return sum + unitPrice * item.qty;
        }, 0);
    }

    // é‹è²»è¨ˆç®—ï¼šä¾ç…§ä½¿ç”¨è€…åœ¨ checkout é¸çš„ shipping-method
    function getShippingCostForCurrentSelection(subtotal) {
        const mode = shippingMethodSelect.value || currentShippingModeForSummary;

        if (!mode) {
            return {cost: null, note:"å°šæœªé¸æ“‡é…é€"};
        }

        // åŒ¯æ¬¾ + å…¨å®¶åº—åˆ°åº—
        if (mode === "cvs_payfirst") {
            if (subtotal >= THRESHOLD_PAYFIRST) {
                return {cost: 0, note:`æ»¿ NT$${THRESHOLD_PAYFIRST} å…é‹ï¼ˆåŒ¯æ¬¾+å…¨å®¶åº—åˆ°åº—ï¼‰`};
            }
            return {cost: COST_CVS, note:`æœªæ»¿ NT$${THRESHOLD_PAYFIRST} é‹è²» NT$${COST_CVS}`};
        }

        // å–è²¨ä»˜æ¬¾ + å…¨å®¶åº—åˆ°åº—
        if (mode === "cvs_cod") {
            if (subtotal >= THRESHOLD_COD) {
                return {cost: 0, note:`æ»¿ NT$${THRESHOLD_COD} å…é‹ï¼ˆå–è²¨ä»˜æ¬¾ï¼‰`};
            }
            return {cost: COST_CVS, note:`æœªæ»¿ NT$${THRESHOLD_COD} é‹è²» NT$${COST_CVS}`};
        }

        // å®…é…
        if (mode === "home_delivery") {
            return {cost: COST_HOME, note:`å®…é…å›ºå®šé‹è²» NT$${COST_HOME}`};
        }

        // é¢äº¤
        if (mode === "self_pickup") {
            return {cost: COST_SELF, note:`é¢äº¤è‡ªå– 0 å…ƒï¼ˆå°åŒ—å¸‚ï¼‰`};
        }

        return {cost:null, note:"å°šæœªé¸æ“‡é…é€"};
    }

    function calculateCartSummary() {
        const subtotal = getCartSubtotal();
        const {cost, note} = getShippingCostForCurrentSelection(subtotal);

        let shippingCostDisplay;
        let total;
        if (cost === null) {
            shippingCostDisplay = "å°šæœªé¸æ“‡é…é€";
            total = subtotal;
        } else {
            shippingCostDisplay = cost === 0 ? "å…é‹" : `NT$${cost}`;
            total = subtotal + cost;
        }

        return {
            subtotal,
            shippingCost: shippingCostDisplay,
            total,
            costRaw: cost, // æ–°å¢ï¼šå‚³å›åŸå§‹é‹è²»é‡‘é¡
            note
        };
    }

    function renderCart() {
        // æ›´æ–°è³¼ç‰©è»Šæ•¸é‡
        const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
        
        // æ›´æ–°æµ®å‹•æŒ‰éˆ•å’Œè³¼ç‰©è»ŠæŠ½å±œå…§çš„æ•¸é‡
        cartCount.textContent = totalQty; 
        cartCountInline.textContent = totalQty + ' ä»¶';

        // æ¸…å–®
        if (cart.length === 0) {
            cartItemsDiv.innerHTML = '<p style="text-align:center; color:#777; font-size:0.9rem;">è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„</p>';
        } else {
            cartItemsDiv.innerHTML = '';
            cart.forEach((item, index) => {
                const unitPriceNumber = parseInt(String(item.price).replace(/\D/g, '')) || 0;
                const lineTotal = unitPriceNumber * item.qty;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';

                itemDiv.innerHTML = `
                    <div class="cart-item-header">
                        <div>
                            <div class="cart-item-title">${item.name}</div>
                            <div class="cart-item-detail">
                                è¦æ ¼ï¼š${item.size}/${item.color}<br>
                                å–®åƒ¹ï¼š${item.price}
                            </div>
                        </div>
                        <button class="cart-item-remove" data-index="${index}">åˆªé™¤</button>
                    </div>
                    <div class="cart-item-qty-row">
                        <label>æ•¸é‡</label>
                        <input type="number" class="cart-qty-input" data-index="${index}" value="${item.qty}" min="1">
                        <div class="line-total">å°è¨ˆ NT$${lineTotal}</div>
                    </div>
                `;

                cartItemsDiv.appendChild(itemDiv);
            });
        }

        // é‡‘é¡ï¼†é‹è²»æç¤º
        const {subtotal, shippingCost, total, note} = calculateCartSummary();

        subtotalAmountSpan.textContent = 'NT$' + subtotal;
        shippingAmountSpan.textContent = shippingCost;
        totalAmountSpan.textContent = 'NT$' + total;
        freeShipHintDiv.innerHTML = note || '';
    }

    function addToCart(name, size, color, qty, price) {
        qty = parseInt(qty) || 1;
        if (qty < 1) qty = 1;

        const existingIndex = cart.findIndex(item =>
            item.name === name &&
            item.size === size &&
            item.color === color &&
            item.price === price
        );

        if (existingIndex >= 0) {
            cart[existingIndex].qty += qty;
        } else {
            cart.push({ name, size, color, qty, price });
        }

        saveCartToStorage();
        renderCart();
        openCart();
    }

    function updateCartItemQty(index, newQty) {
        newQty = parseInt(newQty) || 1;
        if (newQty < 1) newQty = 1;

        if (cart[index]) {
            cart[index].qty = newQty;
        }
        saveCartToStorage();
        renderCart();
    }

    function removeCartItem(index) {
        cart.splice(index, 1);
        saveCartToStorage();
        renderCart();
    }

    function showProductList() {
        productListDiv.style.display = 'grid';
    }

    function hideProductList() {
        productListDiv.style.display = 'none';
    }

    // æŠŠè³¼ç‰©è»Šå…§å®¹æ•´ç†æˆåº—å“¡è¦çœ‹çš„æ–‡å­—
    function buildCheckoutSummaryText() {
        if (cart.length === 0) {
            return '(è³¼ç‰©è»Šç‚ºç©º)';
        }
        let lines = [];
        cart.forEach(item => {
            lines.push(
                `ã€${item.name}ã€‘ è¦æ ¼:${item.size}/${item.color} æ•¸é‡:${item.qty} å–®åƒ¹:${item.price}`
            );
        });

        const sub = getCartSubtotal();
        const {cost} = getShippingCostForCurrentSelection(sub);
        const finalShip = (cost === 0 ? 'å…é‹' : (cost == null ? 'å°šæœªé¸æ“‡' : `NT$${cost}`));
        const finalTotal = (cost == null ? sub : sub + cost);

        lines.push(`-- è¨‚å–®ç¸½çµ --`);
        lines.push(`å•†å“å°è¨ˆ: NT$ ${sub}`);
        lines.push(`é‹è²»: ${finalShip}`);
        lines.push(`ç¸½ä»˜æ¬¾é‡‘é¡: NT$ ${finalTotal}`);

        return lines.join('\n');
    }

    // â¬‡ï¸â¬‡ï¸â¬‡ï¸ æäº¤è¨‚å–®æ ¸å¿ƒå‡½å¼ â¬‡ï¸â¬‡ï¸â¬‡ï¸
    async function submitOrder() {
        // 1. åŸºæœ¬é©—è­‰
        const contactVal = document.getElementById('contact').value.trim();
        const recipientNameVal = document.getElementById('recipient-name').value.trim();
        const shippingMethodKey = document.getElementById('shipping-method').value;
        const storeVal = document.getElementById('recipient-store').value.trim();
        const addressVal = document.getElementById('recipient-address').value.trim();
        const noteVal = document.getElementById('extra-note').value.trim();

        if (!contactVal || !recipientNameVal || !shippingMethodKey) {
             alert('è«‹å¡«å¯«å®Œæ•´å¿…å¡«è³‡è¨Šï¼');
             return;
        }

        // è¶…å•†æ”¶è²¨éƒ½éœ€è¦é–€å¸‚
        if ((shippingMethodKey === 'cvs_cod' || shippingMethodKey === 'cvs_payfirst') && !storeVal) {
             alert('è«‹æä¾›å…¨å®¶é–€å¸‚åç¨±/åº—è™Ÿå–”ï¼ˆæˆ‘å€‘æ‰èƒ½å¹«ä½ å¯„å‡ºï¼‰');
             return;
        }

        // å®…é… / é¢äº¤ è¦åœ°å€æˆ–é¢äº¤åœ°é»
        if ((shippingMethodKey === 'home_delivery' || shippingMethodKey === 'self_pickup') && !addressVal) {
             alert('è«‹å¡«å¯«å®…é…åœ°å€æˆ–é¢äº¤å¸Œæœ›åœ°é»/æ™‚æ®µ');
             return;
        }
        
        // 2. æº–å‚™æäº¤çš„è³‡æ–™
        const orderSummaryText = buildCheckoutSummaryText();
        const {total} = calculateCartSummary(); // å–å¾—æœ€çµ‚ç¸½é‡‘é¡
        const shippingMethodText = shippingMethodSelect.options[shippingMethodSelect.selectedIndex].text;
        
        const payload = {
            contact: contactVal,
            recipientName: recipientNameVal,
            shippingMethod: shippingMethodText, // å‚³é€é¡¯ç¤ºåç¨±
            totalAmount: `NT$${total}`,
            store: storeVal,
            address: addressVal,
            note: noteVal,
            // è®“ Apps Script è¨˜éŒ„æ›´è©³ç´°çš„è¨‚å–®è³‡è¨Š
            orderSummary: orderSummaryText, 
            cartItems: cart, // å‚³é€å®Œæ•´çš„è³¼ç‰©è»Šé™£åˆ—
        };

        // 3. ç¦ç”¨æŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡æäº¤
        submitOrderBtn.disabled = true;
        submitOrderBtn.textContent = 'è¨‚å–®è™•ç†ä¸­...';
        
        // 4. ç™¼é€ POST è«‹æ±‚åˆ° Apps Script
        try {
            // ä¿®æ­£ CORS æ”¿ç­–çš„é—œéµï¼šå°‡ Content-Type è¨­ç‚º text/plain (ç€è¦½å™¨æœƒè¦–ç‚ºç°¡å–®è«‹æ±‚ï¼Œä¸è§¸ç™¼ Preflight)
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain' 
                },
                body: JSON.stringify(payload) // æ•¸æ“šä»ä»¥ JSON å­—ä¸²æ ¼å¼å‚³è¼¸
            });

            const result = await response.json();

            if (result.status === "success") {
                // 5. æˆåŠŸå¾Œçš„è™•ç†
                const finalMsg =`ğŸ‰ è¨‚å–®éœ€æ±‚å·²æˆåŠŸé€å‡ºä¸¦åŒæ­¥åˆ°å¾Œå°ï¼\n\nã€è¨‚å–®ç¢ºèªèˆ‡ä»˜æ¬¾èªªæ˜ã€‘\n\nè«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿå®Œæˆæ‚¨çš„è¨‚å–®ï¼Œæˆ‘å€‘æœƒåœ¨æ”¶åˆ°æ¬¾é …å¾Œç›¡å¿«ç‚ºæ‚¨å‡ºè²¨ã€‚\næ‚¨é¸æ“‡çš„æ–¹æ¡ˆ: ${shippingMethodText}\n\n${orderSummaryText}\n\nè«‹åˆ° LINE@ æä¾›æ”¶ä»¶è³‡è¨Šï¼š(æƒæQRæˆ–åŠ å…¥ LINE ID: @318latbk)\néœ€è¦æä¾›ï¼š\nâœ… è¨‚å–®æ˜ç´°æˆªåœ–ï¼ˆåŒ…å«ç¸½é‡‘é¡èˆ‡é‹é€æ–¹å¼ï¼‰\nâœ… æ”¶ä»¶äººå§“å\nâœ… è¯çµ¡é›»è©±\n${(shippingMethodKey === 'home_delivery' || shippingMethodKey === 'self_pickup') ? "âœ… æ”¶ä»¶åœ°å€ / é¢äº¤åœ°é»æ™‚æ®µ" : "âœ… å…¨å®¶é–€å¸‚åç¨±/åº—è™Ÿ"}\n${noteVal ? "âœ… å‚™è¨»ï¼š" + noteVal : ""}\n\nâ€” ä»˜æ¬¾å¸³æˆ¶ (åŒ¯æ¬¾é©ç”¨) â€”\néŠ€è¡Œåç¨±: ç‹é“éŠ€è¡Œ (éŠ€è¡Œä»£ç¢¼: 048)\néŠ€è¡Œå¸³è™Ÿ: 01000191591188\n\næé†’ï¼šåŒ¯æ¬¾å®Œæˆå¾Œï¼Œè«‹åœ¨ LINE å‘ŠçŸ¥ã€Œå¸³è™Ÿå¾Œäº”ç¢¼ã€æˆ–ä¸Šå‚³åŒ¯æ¬¾è­‰æ˜ï¼Œæˆ‘å€‘å°±æœƒæ ¸å°ä¸¦æ’ä»¶ã€‚`;
                
                alert(finalMsg);

                // 6. æ¸…ç©ºè³¼ç‰©è»Š & é—œé–‰è¦–çª—
                cart = [];
                saveCartToStorage();
                clearCartStorage();
                renderCart();
                closeCheckout();
                closeCart();

            } else {
                alert('è¨‚å–®é€å‡ºå¤±æ•—ï¼Œè«‹æˆªåœ–æ­¤è¨Šæ¯çµ¦å®¢æœï¼š' + result.message);
            }

        } catch (error) {
            console.error('API å‘¼å«å¤±æ•—:', error);
            alert('ç¶²è·¯é€£ç·šéŒ¯èª¤æˆ–å¾Œå°æœå‹™ç„¡æ³•é€£æ¥ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚éŒ¯èª¤ç´°ç¯€å·²è¨˜éŒ„åˆ° Consoleã€‚');
        } finally {
            // 7. æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            submitOrderBtn.disabled = false;
            submitOrderBtn.textContent = 'é€å‡ºè¨‚å–®éœ€æ±‚';
        }
    }
    // â¬†ï¸â¬†ï¸â¬†ï¸ æäº¤è¨‚å–®æ ¸å¿ƒå‡½å¼çµæŸ â¬†ï¸â¬†â¬†


    function handleShippingChange() {
        const method = shippingMethodSelect.value;

        codWarningDiv.style.display = 'none';
        codWarningDiv.innerHTML = '';

        shippingWarningDiv.style.display = 'none';
        shippingWarningDiv.innerHTML = '';

        extraHintsDiv.style.display = 'none';
        extraHintsDiv.innerHTML = '';

        recipientStoreGroup.style.display = 'none';
        recipientStoreInput.required = false;

        recipientAddressInput.required = false;

        let alertHtml = '';
        let extraHtml = '';

        // ä¾é…é€æ–¹å¼é¡¯ç¤ºä¸åŒéœ€æ±‚ï¼‹å…é‹é–€æª»æç¤º
        if (method === 'cvs_payfirst') {
            // åŒ¯æ¬¾ + å…¨å®¶åº—åˆ°åº—
            alertHtml = `
                ğŸšš <strong>è¶…å•†å–è²¨ - åŒ¯æ¬¾å¾Œå‡ºè²¨</strong><br>
                å…¨å®¶åº—åˆ°åº—ã€‚<br>
                æ»¿ NT$${THRESHOLD_PAYFIRST} å…é‹ï¼Œæœªæ»¿å‰‡é‹è²» NT$${COST_CVS}ã€‚<br>
                è«‹æä¾›ã€Œå…¨å®¶é–€å¸‚åç¨± / åº—è™Ÿã€ï¼ŒåŒ¯æ¬¾å¾Œå‡ºè²¨ã€‚
            `;
            extraHtml = `
                <div class="line-contact-box">
                    <img src="https://qr-official.line.me/gs/M_318latbk_GW.png?oat_content=qr" alt="LINE QR Code">
                    <p>è«‹æƒæ QR Code æˆ–åŠ å…¥ LINE ID: <strong>@318latbk</strong> ç•™è¨€ã€‚</p>
                </div>
                <p style="margin-top:8px; font-size:0.8rem; line-height:1.5;">
                    è«‹å‹™å¿…æä¾›ä»¥ä¸‹å®Œæ•´è³‡è¨Šï¼š<br>
                    âœ… è¨‚å–®æ˜ç´°æˆªåœ–ï¼ˆåŒ…å«ç¸½é‡‘é¡èˆ‡é‹é€æ–¹å¼ï¼‰<br>
                    âœ… æ”¶ä»¶äººå§“å<br>
                    âœ… è¯çµ¡é›»è©±<br>
                    âœ… å…¨å®¶é–€å¸‚åç¨± / åº—è™Ÿ<br>
                    âœ… åŒ¯æ¬¾å¾Œäº”ç¢¼æˆ–åŒ¯æ¬¾æˆªåœ–
                </p>
                <div class="bank-box">
                    <strong>éŠ€è¡Œåç¨±ï¼š</strong> ç‹é“éŠ€è¡Œ (éŠ€è¡Œä»£ç¢¼: 048)<br>
                    <strong>å¸³è™Ÿï¼š</strong> 01000191591188<br>
                    <strong>æé†’ï¼š</strong> åŒ¯æ¬¾å®Œæˆå¾Œï¼Œè«‹åœ¨ LINE å›å ±å¸³è™Ÿå¾Œäº”ç¢¼ï¼Œæˆ‘å€‘æœƒç›¡å¿«å®‰æ’å‡ºè²¨ã€‚
                </div>
            `;
            recipientStoreGroup.style.display = 'block';
            recipientStoreInput.required = true;
        }
        else if (method === 'cvs_cod') {
            // è¶…å•†å–è²¨ä»˜æ¬¾
            alertHtml = `
                ğŸ’¸ <strong>è¶…å•†å–è²¨ä»˜æ¬¾</strong><br>
                å…¨å®¶åº—åˆ°åº—ï¼Œå–è²¨æ™‚ä»˜æ¬¾ã€‚<br>
                æ»¿ NT$${THRESHOLD_COD} å…é‹ï¼Œæœªæ»¿å‰‡é‹è²» NT$${COST_CVS}ã€‚<br>
                æˆ‘å€‘æœƒé–‹å–®çµ¦ä½ ï¼Œè«‹åœ¨æ™‚é™å…§å®Œæˆé–€å¸‚ç¢ºèªï¼Œæ‰èƒ½ä¿ç•™è²¨ã€‚
            `;
            extraHtml = `
                <div class="line-contact-box">
                    <img src="https://qr-official.line.me/gs/M_318latbk_GW.png?oat_content=qr" alt="LINE QR Code">
                    <p>è«‹æƒæ QR Code æˆ–åŠ å…¥ LINE ID: <strong>@318latbk</strong> ç•™è¨€ã€‚</p>
                </div>
                <p style="margin-top:8px; font-size:0.8rem; line-height:1.5;">
                    ä¸‹å–®æ™‚è«‹æä¾›ï¼š<br>
                    âœ… è¨‚å–®æ˜ç´°æˆªåœ–ï¼ˆåŒ…å«ç¸½é‡‘é¡èˆ‡é‹é€æ–¹å¼ï¼‰<br>
                    âœ… æ”¶ä»¶äººå§“å<br>
                    âœ… è¯çµ¡é›»è©±<br>
                    âœ… å…¨å®¶é–€å¸‚åç¨± / åº—è™Ÿ
                </p>
                <p style="font-size:0.8rem; line-height:1.5;">
                    âš  è‹¥é€¾æœŸæœªå®Œæˆé–€å¸‚ç¢ºèªæˆ–å–è²¨ï¼Œåº«å­˜å°‡é‡‹å‡ºçµ¦ä¸‹ä¸€ä½ã€‚
                </p>
            `;
            recipientStoreGroup.style.display = 'block';
            recipientStoreInput.required = true;
        }
        else if (method === 'home_delivery') {
            alertHtml = `
                ğŸ  <strong>å®…é…åˆ°åºœ</strong><br>
                å®…é…å›ºå®šé‹è²» NT$${COST_HOME}ï¼ŒåŒ¯æ¬¾å¾Œå‡ºè²¨ã€‚<br>
                è«‹å¡«å®Œæ•´æ”¶ä»¶åœ°å€ä¾›å¯„ä»¶ã€‚
            `;
            extraHtml = `
                <div class="line-contact-box">
                    <img src="https://qr-official.line.me/gs/M_318latbk_GW.png?oat_content=qr" alt="LINE QR Code">
                    <p>è«‹æƒæ QR Code æˆ–åŠ å…¥ LINE ID: <strong>@318latbk</strong> ç•™è¨€ã€‚</p>
                </div>
                <div class="bank-box">
                    <strong>éŠ€è¡Œåç¨±ï¼š</strong> ç‹é“éŠ€è¡Œ (éŠ€è¡Œä»£ç¢¼: 048)<br>
                    <strong>å¸³è™Ÿï¼š</strong> 01000191591188<br>
                    <strong>æé†’ï¼š</strong> åŒ¯æ¬¾å®Œæˆå¾Œï¼Œè«‹åœ¨ LINE å›å ±å¸³è™Ÿå¾Œäº”ç¢¼ï¼Œæˆ‘å€‘æœƒç›¡å¿«å®‰æ’å‡ºè²¨ã€‚
                </div>
                <p style="margin-top:8px; font-size:0.8rem; line-height:1.5;">
                    è«‹æä¾›ï¼š<br>
                    âœ… è¨‚å–®æ˜ç´°æˆªåœ–ï¼ˆåŒ…å«ç¸½é‡‘é¡èˆ‡é‹é€æ–¹å¼ï¼‰<br>
                    âœ… æ”¶ä»¶äººå§“å<br>
                    âœ… è¯çµ¡é›»è©±<br>
                    âœ… é€è²¨åœ°å€<br>
                    âœ… åŒ¯æ¬¾å¾Œäº”ç¢¼æˆ–åŒ¯æ¬¾æˆªåœ–
                </p>
            `;
            recipientAddressInput.required = true;
        }
        else if (method === 'self_pickup') {
            alertHtml = `
                ğŸ¤ <strong>å°åŒ—é¢äº¤ / è‡ªå–</strong><br>
                0 å…ƒé‹è²»ã€‚åŒ¯æ¬¾å¾Œä¿ç•™ã€‚<br>
                æˆ‘å€‘æœƒç”¨ LINE@ è·Ÿä½ ç´„åœ°é»ï¼ˆé€šå¸¸æ·é‹ç«™é™„è¿‘ï¼‰ã€‚<br>
                è«‹å¡«å¯é¢äº¤çš„æ™‚æ®µï¼åœ°å€ï¼ˆä¾‹å¦‚ï¼šå¹³æ—¥ä¸‹ç­å¾Œä¿¡ç¾©å€å¯ç´„ï¼‰ã€‚
            `;
            extraHtml = `
                <div class="line-contact-box">
                    <img src="https://qr-official.line.me/gs/M_318latbk_GW.png?oat_content=qr" alt="LINE QR Code">
                    <p>è«‹æƒæ QR Code æˆ–åŠ å…¥ LINE ID: <strong>@318latbk</strong> ç•™è¨€ã€‚</p>
                </div>
                <div class="bank-box">
                    <strong>éŠ€è¡Œåç¨±ï¼š</strong> ç‹é“éŠ€è¡Œ (éŠ€è¡Œä»£ç¢¼: 048)<br>
                    <strong>å¸³è™Ÿï¼š</strong> 01000191591188<br>
                    <strong>æé†’ï¼š</strong> åŒ¯æ¬¾å®Œæˆå¾Œè«‹ç§è¨Šï¼Œæˆ‘å€‘å°±æœƒä¿ç•™ä½ çš„è²¨åˆ°é¢äº¤æ—¥ã€‚
                </div>
                <p style="margin-top:8px; font-size:0.8rem; line-height:1.5;">
                    è«‹æä¾›ï¼š<br>
                    âœ… è¨‚å–®æ˜ç´°æˆªåœ–ï¼ˆåŒ…å«ç¸½é‡‘é¡èˆ‡é‹é€æ–¹å¼ï¼‰<br>
                    âœ… æ”¶ä»¶äººå§“åï¼ˆé¢äº¤å–è²¨äººï¼‰<br>
                    âœ… è¯çµ¡é›»è©± / LINE ID<br>
                    âœ… å¸Œæœ›é¢äº¤åœ°é»/æ™‚æ®µ<br>
                    âœ… åŒ¯æ¬¾å¾Œäº”ç¢¼æˆ–åŒ¯æ¬¾æˆªåœ–
                </p>
                <p style="font-size:0.8rem; line-height:1.5;">
                    âš  å› ç‚ºç¾è²¨é‡å¾ˆå°‘ï¼Œè‹¥ç´„å®šæ™‚é–“æœªå–è²¨ï¼Œæœƒé‡‹å‡ºçµ¦ä¸‹ä¸€ä½å”·
                </p>
            `;
            recipientAddressInput.required = true;
        }

        if (alertHtml) {
            shippingWarningDiv.style.display = 'block';
            shippingWarningDiv.innerHTML = alertHtml;
        }

        if (extraHtml) {
            extraHintsDiv.style.display = 'block';
            extraHintsDiv.innerHTML = extraHtml;
        }

        // é‹è²»æç¤ºæ›´æ–°è³¼ç‰©è»Š summary
        currentShippingModeForSummary = method;
        renderCart();

        // å…é‹æé†’æ¢ï¼ˆæœ€ä¸Šæ–¹é»ƒæ¢ï¼‰
        const subtotal = getCartSubtotal();
        const {cost} = getShippingCostForCurrentSelection(subtotal);
        if (cost === 0) {
            codWarningDiv.style.display = 'block';
            codWarningDiv.innerHTML = `
                ğŸ‰ æœ¬æ¬¡äº«å…é‹å„ªæƒ ï¼
            `;
        } else {
            codWarningDiv.style.display = 'none';
            codWarningDiv.innerHTML = '';
        }
    }

    // ---------- è¦æ ¼ ----------
    function getAvailableSpecs(productName) {
        const productData = allProductsData[productName];
        if (!productData) {
            return {
                sizes: ['ç„¡'],
                colors: ['ç„¡'],
                detailsMap: { 'ç„¡-ç„¡': 0 }
            };
        }

        const specs = {
            sizes: new Set(),
            colors: new Set(),
            detailsMap: {}
        };

        for (const detailKey in productData.details) {
            const detail = productData.details[detailKey];
            const size = detail['å°ºå¯¸'] || 'ç„¡';
            const color = detail['é¡è‰²'] || 'ç„¡';
            const qty = detail['æ•¸é‡'] || 0;

            specs.sizes.add(size);
            specs.colors.add(color);
            specs.detailsMap[`${size}-${color}`] = detail['æ•¸é‡'];
        }
        
        const sortedSizes = [...specs.sizes].sort((a, b) => {
            const strA = String(a);
            const strB = String(b);
            if (strA === 'ç„¡') return -1;
            if (strB === 'ç„¡') return 1;
            return strA.localeCompare(strB);
        });

        const sortedColors = [...specs.colors].sort((a, b) => {
            const strA = String(a);
            const strB = String(b);
            if (strA === 'ç„¡') return -1;
            if (strB === 'ç„¡') return 1;
            return strA.localeCompare(strB);
        });
        
        return {
            sizes: sortedSizes,
            colors: sortedColors,
            detailsMap: specs.detailsMap
        };
    }
    
    function renderProducts(productsToRender) {
        productListDiv.innerHTML = '';
        showProductList(); 

        if (Object.keys(productsToRender).length === 0) {
            productListDiv.innerHTML = '<p style="text-align: center; width: 100%;">æ²’æœ‰æ‰¾åˆ°ç›¸é—œç”¢å“ã€‚</p>';
            return;
        }

        for (const productName in productsToRender) {
            const productData = productsToRender[productName];
            const safeProductId = getSafeId(productName);
            const specs = getAvailableSpecs(productName);
            const firstPrice = productData.productInfo['å”®åƒ¹'] || 'NT$ åƒ¹æ ¼å¾…å®š';
            const originalPrice = productData.productInfo['åŸåƒ¹'] || '';
            
            const hasMultipleSpecs = (specs.sizes.length > 1 && !(specs.sizes.length === 2 && specs.sizes.includes('ç„¡'))) ||
                                     (specs.colors.length > 1 && !(specs.colors.length === 2 && specs.colors.includes('ç„¡')));
            
            const singleSize = specs.sizes[0] || 'ç„¡';
            const singleColor = specs.colors[0] || 'ç„¡';
            
            const card = document.createElement('div');
            card.className = 'product-card';

            const photos = productData.productInfo['ç…§ç‰‡é€£çµ']
                ? productData.productInfo['ç…§ç‰‡é€£çµ'].split(',').map(url => url.trim()).filter(url => url !== '')
                : [];
            let imagesHtml = '';
            if (photos.length > 0) {
                const photosJson = JSON.stringify(photos).replace(/"/g, '&quot;'); 
                imagesHtml = `<div class="product-images">
                    <img src="${photos[0]}" alt="${productName}" data-photos='${photosJson}'>
                </div>`;
            }
            
            let specSelectorHtml = '';
            if (hasMultipleSpecs) {
                specSelectorHtml = `
                    <div class="spec-selector">
                        <label for="size-${safeProductId}">å°ºå¯¸:</label>
                        <select id="size-${safeProductId}" data-spec-type="size">
                            ${specs.sizes.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                        
                        <label for="color-${safeProductId}">é¡è‰²:</label>
                        <select id="color-${safeProductId}" data-spec-type="color">
                            ${specs.colors.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                        
                        <div class="stock-info" id="stock-info-${safeProductId}">è«‹é¸æ“‡è¦æ ¼</div>
                        
                        <label for="qty-${safeProductId}">æ•¸é‡:</label>
                        <input type="number" id="qty-${safeProductId}" value="1" min="1" max="1" disabled>
                        
                        <button class="add-to-cart-btn" data-product="${productName}" data-size="" data-color="" data-price="${firstPrice}" disabled>åŠ å…¥è³¼ç‰©è»Š</button>
                    </div>
                `;
            } else {
                const stock = specs.detailsMap[`${singleSize}-${singleColor}`] || 0;
                const stockText = stock > 0 ? `åº«å­˜: ${stock}` : `<span class="out-of-stock">ç¼ºè²¨</span>`;
                specSelectorHtml = `
                    <div class="spec-selector">
                        ${(singleSize !== 'ç„¡' || singleColor !== 'ç„¡') ? `<p>è¦æ ¼: ${singleSize}/${singleColor}</p>` : ''}
                        <p class="stock-info" id="stock-info-${safeProductId}">${stockText}</p>
                        <label for="qty-${safeProductId}">æ•¸é‡:</label>
                        <input type="number" id="qty-${safeProductId}" value="1" min="1" max="${stock}" ${stock === 0 ? 'disabled' : ''}>
                        <button class="add-to-cart-btn" data-product="${productName}" data-size="${singleSize}" data-color="${singleColor}" data-price="${firstPrice}" ${stock === 0 ? 'disabled' : ''}>åŠ å…¥è³¼ç‰©è»Š</button>
                    </div>
                `;
            }

            const cardContentHtml = `
                ${imagesHtml}
                <div class="product-info">
                    <h2>${productName}</h2>
                    <p><strong>åˆ†é¡:</strong> ${productData.productInfo['åˆ†é¡'] || 'ç„¡'}</p>
                    ${originalPrice ? `<p class="original-price">åŸåƒ¹: ${originalPrice}</p>` : ""}
                    <p class="price"><strong>å”®åƒ¹:</strong> ${firstPrice}</p>
                    <p><strong>ç”¢å“å…§å®¹:</strong> ${productData.productInfo['ç”¢å“å…§å®¹èªªæ˜'] || 'ç„¡'}</p>
                    ${specSelectorHtml}
                </div>
            `;

            card.innerHTML = cardContentHtml;
            productListDiv.appendChild(card);

            // åœ–ç‰‡è¼ªæ’­
            const imgEl = card.querySelector('.product-images img');
            if (imgEl) {
                const photosData = imgEl.getAttribute('data-photos');
                let photoList = [];
                try {
                    photoList = JSON.parse(photosData.replace(/&quot;/g, '"'));
                } catch(e) {}

                if (photoList.length > 1) {
                    let currentIndex = 0;
                    imgEl.addEventListener('click', () => {
                        currentIndex = (currentIndex + 1) % photoList.length;
                        imgEl.src = photoList[currentIndex];
                    });

                    const indicator = document.createElement('div');
                    indicator.className = 'image-indicator';
                    indicator.textContent = `1 / ${photoList.length}`;
                    imgEl.parentNode.appendChild(indicator);

                    imgEl.addEventListener('click', () => {
                        const idxDisplay = (currentIndex + 1) + ' / ' + photoList.length;
                        indicator.textContent = idxDisplay;
                    });
                }
            }

            // å¤šè¦æ ¼äº’å‹•
            if (hasMultipleSpecs) {
                const sizeSelect = card.querySelector(`#size-${safeProductId}`);
                const colorSelect = card.querySelector(`#color-${safeProductId}`);
                const stockInfoDiv = card.querySelector(`#stock-info-${safeProductId}`);
                const qtyInput = card.querySelector(`#qty-${safeProductId}`);
                const addToCartBtn = card.querySelector('.add-to-cart-btn');

                function updateStock() {
                    const selectedSize = sizeSelect.value;
                    const selectedColor = colorSelect.value;
                    const stockKey = `${selectedSize}-${selectedColor}`;
                    const maxStock = specs.detailsMap[stockKey] || 0;

                    stockInfoDiv.innerHTML = maxStock > 0
                        ? `åº«å­˜: ${maxStock}`
                        : `è©²è¦æ ¼ ${selectedSize}/${selectedColor} <span class="out-of-stock">ç¼ºè²¨</span>`;

                    qtyInput.max = maxStock;
                    qtyInput.disabled = maxStock === 0;

                    let currentQty = parseInt(qtyInput.value) || 1;
                    if (currentQty > maxStock) currentQty = maxStock > 0 ? maxStock : 1;
                    qtyInput.value = Math.max(1, currentQty);

                    addToCartBtn.disabled = maxStock === 0;
                    addToCartBtn.dataset.size = selectedSize;
                    addToCartBtn.dataset.color = selectedColor;
                }

                sizeSelect.addEventListener('change', updateStock);
                colorSelect.addEventListener('change', updateStock);

                addToCartBtn.addEventListener('click', () => {
                    const selectedSize = addToCartBtn.dataset.size || 'ç„¡';
                    const selectedColor = addToCartBtn.dataset.color || 'ç„¡';
                    const qtyVal = qtyInput.value || 1;
                    const priceVal = addToCartBtn.dataset.price || firstPrice;
                    addToCart(productName, selectedSize, selectedColor, qtyVal, priceVal);
                });

                updateStock();
            } else {
                // å–®è¦æ ¼
                const addToCartBtnSingle = card.querySelector('.add-to-cart-btn');
                const qtyInputSingle = card.querySelector(`#qty-${safeProductId}`);

                if (addToCartBtnSingle) {
                    addToCartBtnSingle.addEventListener('click', () => {
                        const qtyVal = qtyInputSingle.value || 1;
                        addToCart(
                            productName,
                            singleSize || 'ç„¡',
                            singleColor || 'ç„¡',
                            qtyVal,
                            firstPrice
                        );
                    });
                }
            }
        }
    }

    function filterProducts() {
        const categoryVal = categoryFilter.value.trim();
        const stockVal = stockFilter.value.trim();
        const keywordVal = searchInput.value.trim().toLowerCase();

        const filteredProducts = {};

        for (const productName in allProductsData) {
            const productData = allProductsData[productName];

            if (categoryVal && productData.productInfo['åˆ†é¡'] !== categoryVal) continue;

            const lowerName = productName.toLowerCase();
            const lowerDesc = (productData.productInfo['ç”¢å“å…§å®¹èªªæ˜'] || '').toLowerCase();
            if (keywordVal && !(lowerName.includes(keywordVal) || lowerDesc.includes(keywordVal))) continue;

            if (stockVal) {
                const hasStock = Object.values(productData.details).some(detail => {
                    return (detail['æ•¸é‡'] || 0) > 0;
                });

                if (stockVal === 'in_stock' && !hasStock) continue;
                if (stockVal === 'out_of_stock' && hasStock) continue;
            }

            filteredProducts[productName] = productData;
        }

        renderProducts(filteredProducts);
    }

    // ========== äº‹ä»¶ç¶å®š ==========
    toTopBtn.addEventListener('click', scrollToTop);

    // ç¶å®šäº‹ä»¶åˆ°æ–°çš„æµ®å‹•è³¼ç‰©è»ŠæŒ‰éˆ•
    cartBtn.addEventListener('click', openCart); 
    
    cartCloseBtn.addEventListener('click', closeCart);
    cartOverlay.addEventListener('click', closeCart);

    checkoutBtn.addEventListener('click', openCheckout);
    closeCheckoutBtn.addEventListener('click', closeCheckout);
    checkoutOverlay.addEventListener('click', closeCheckout);

    // é—œéµä¿®æ­£ï¼šå°‡ submitOrderBtn çš„äº‹ä»¶è™•ç†å™¨æ”¹ç‚ºä½¿ç”¨ async/await ä¸”ä¸é˜»æ­¢è¡¨å–®é è¨­è¡Œç‚º 
    submitOrderBtn.addEventListener('click', (e) => {
        e.preventDefault(); // é˜»æ­¢è¡¨å–®çš„é è¨­æäº¤è¡Œç‚º
        submitOrder();
    });

    cartItemsDiv.addEventListener('click', (e) => {
        if (e.target.classList.contains('cart-item-remove')) {
            const idx = parseInt(e.target.dataset.index);
            removeCartItem(idx);
        }
    });

    cartItemsDiv.addEventListener('change', (e) => {
        if (e.target.classList.contains('cart-qty-input')) {
            const idx = parseInt(e.target.dataset.index);
            const newQty = e.target.value;
            updateCartItemQty(idx, newQty);
        }
    });

    categoryFilter.addEventListener('change', filterProducts);
    stockFilter.addEventListener('change', filterProducts);
    searchInput.addEventListener('input', filterProducts);
    clearFiltersBtn.addEventListener('click', () => {
        categoryFilter.value = '';
        stockFilter.value = '';
        searchInput.value = '';
        filterProducts();
    });

    shippingMethodSelect.addEventListener('change', handleShippingChange);

    // ========= åˆå§‹åŒ–ï¼šè¼‰å…¥è³¼ç‰©è»Š + æŠ“è³‡æ–™ =========
    // å…ˆè¼‰å…¥è³¼ç‰©è»Šï¼Œç¢ºä¿ç•«é¢ä¸€é–‹å§‹å°±åæ˜  localStorage
    cart = loadCartFromStorage();
    renderCart();
    
    // ç¶²é è¼‰å…¥æ™‚å¼·åˆ¶è§¸ç™¼ä¸€æ¬¡é‹è²»è®Šå‹•ï¼Œç¢ºä¿å…é‹æç¤ºç­‰æ­£ç¢ºé¡¯ç¤º
    shippingMethodSelect.dispatchEvent(new Event('change'));

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (!Array.isArray(data) || data.length === 0) {
                productListDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰ç”¢å“è³‡æ–™ã€‚</p>';
                return;
            }
            
            const groupedProducts = data.reduce((acc, currentItem) => {
                const productName = currentItem['ç”¢å“åç¨±'] || 'ç„¡æ¨™é¡Œ';
                const size = String(currentItem['å°ºå¯¸'] || 'ç„¡');
                const color = String(currentItem['é¡è‰²'] || 'ç„¡');
                const quantity = parseInt(currentItem['æ•¸é‡']) || 0;
                const category = currentItem['åˆ†é¡'] || 'ç„¡åˆ†é¡';
                const salePrice = currentItem['æˆ‘æ–¹å”®åƒ¹'] || 'NT$ åƒ¹æ ¼å¾…å®š'; // å”®åƒ¹
                const originalPrice = currentItem['åƒ¹æ ¼'] || '';            // åŸåƒ¹
                const detailsKey = `${size}-${color}`;

                if (!acc[productName]) {
                    acc[productName] = {
                        details: {},
                        productInfo: {
                            'å”®åƒ¹': salePrice,
                            'åŸåƒ¹': originalPrice,
                            'ç”¢å“å…§å®¹èªªæ˜': currentItem['ç”¢å“å…§å®¹èªªæ˜'] || '',
                            'é€£çµ': null,
                            'ç…§ç‰‡é€£çµ': currentItem['ç…§ç‰‡é€£çµ'] || '',
                            'åˆ†é¡': category
                        }
                    };
                }

                if (salePrice !== 'NT$ åƒ¹æ ¼å¾…å®š') {
                    acc[productName].productInfo['å”®åƒ¹'] = salePrice;
                }

                if (originalPrice && originalPrice.trim() !== '') {
                    acc[productName].productInfo['åŸåƒ¹'] = originalPrice;
                }

                if (!acc[productName].productInfo['é€£çµ']) {
                    const linkString = currentItem['é€£çµ'] || '';
                    const matches = linkString.match(/https?:\/\/[^\s]+/g);
                    if (matches && matches.length > 0) {
                        acc[productName].productInfo['é€£çµ'] = matches[0];
                    }
                }

                if (!acc[productName].details[detailsKey]) {
                    acc[productName].details[detailsKey] = {
                        'å°ºå¯¸': size,
                        'é¡è‰²': color,
                        'æ•¸é‡': 0
                    };
                }

                acc[productName].details[detailsKey]['æ•¸é‡'] += quantity;

                return acc;
            }, {});
            
            allProductsData = groupedProducts;

            const categoriesSet = new Set();
            for (const pName in allProductsData) {
                categoriesSet.add(allProductsData[pName].productInfo['åˆ†é¡'] || 'ç„¡åˆ†é¡');
            }
            const categoryOptions = ['<option value="">å…¨éƒ¨</option>']
                .concat([...categoriesSet].map(cat => `<option value="${cat}">${cat}</option>`));
            categoryFilter.innerHTML = categoryOptions.join('');

            renderProducts(allProductsData);
        })
        .catch(err => {
            console.error('è³‡æ–™è¼‰å…¥å¤±æ•—', err);
            productListDiv.innerHTML = '<p>è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
        });
    
    // ç¶²é è¼‰å…¥å®Œæˆå¾Œæª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºå›é ‚éƒ¨æŒ‰éˆ•
    window.addEventListener('scroll', () => {
        if (window.scrollY > 200) {
            toTopBtn.style.display = 'block';
        } else {
            toTopBtn.style.display = 'none';
        }
    });

})();
</script>

</body>
</html>
