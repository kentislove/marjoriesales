<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯„è³£ä½œæ¥­</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f4f4f9;
            --text-color: #333;
            --border-color: #ccc;
            --accent-color: #28a745;
            --danger-color: #dc3545;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background-color: #fff; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: var(--primary-color); 
            border-bottom: 2px solid var(--primary-color); 
            padding-bottom: 10px; 
            margin-bottom: 20px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        select, input[type="text"], input[type="number"] { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 15px; 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        /* RWD æ ¸å¿ƒï¼šå°‡ field-group èª¿æ•´ç‚ºåœ¨å°è¢å¹•ä¸Šå‚ç›´å †ç–Š */
        .field-group { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .field-group > div { 
            flex: 1; 
            min-width: 0; /* ç¢ºä¿å…§å®¹ä¸æœƒæº¢å‡º */
        }
        .product-item { 
            border: 1px dashed var(--primary-color); 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 4px; 
            background-color: #f9f9ff; 
        }
        .product-item h3 { 
            margin-top: 0; 
            color: var(--primary-color); 
        }
        .product-actions { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
            margin-top: 10px; 
        }
        .add-btn, .remove-btn { 
            padding: 8px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            white-space: nowrap; /* é˜²æ­¢æŒ‰éˆ•æ–‡å­—æ›è¡Œ */
        }
        .add-btn { 
            background-color: var(--accent-color); 
            color: white; 
        }
        .remove-btn { 
            background-color: var(--danger-color); 
            color: white; 
        }
        .submit-btn { 
            background-color: var(--primary-color); 
            color: white; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 4px; 
            font-size: 1.1rem; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 20px; 
        }
        
        #summary-container { 
            margin-top: 20px; 
            padding: 15px; 
            background-color: #e9ecef; 
            border-radius: 4px; 
        }
        .summary-row {
            display: flex;
            justify-content: flex-end;
            font-size: 1.2rem; 
            font-weight: bold;
            line-height: 1.5;
            text-align: right;
            gap: 20px;
        }
        .summary-row span:first-child {
            width: 150px;
            text-align: left;
        }
        .summary-row:last-child {
            border-top: 1px solid #ccc;
            padding-top: 5px;
            margin-top: 5px;
        }

        .disabled { opacity: 0.6; pointer-events: none; }

        /* ================================================= */
        /* RWD è¡Œå‹•è£ç½®å„ªåŒ– (Max Width: 600px)     */
        /* ================================================= */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            /* è®“å¤šæ¬„ä½çµ„ä»¶åœ¨å°è¢å¹•ä¸Šå‚ç›´å †ç–Š */
            .field-group {
                flex-direction: column;
                gap: 0;
            }
            .field-group > div {
                flex: none; /* è®“å®ƒå€‘ä½”æ»¿æ•´è¡Œ */
            }
            select, input[type="text"], input[type="number"] {
                margin-bottom: 10px; /* ç¸®å°æ¬„ä½é–“è· */
            }

            /* ç¢ºä¿è¨‚å–®åŸºæœ¬è³‡è¨Šçš„é›»å•†é¸æ“‡æ¬„ä½å…¨å¯¬ */
            .field-group > div[style] {
                flex: 1 1 100% !important; 
            }
            
            /* èª¿æ•´ç”¢å“æ¸…å–®ä¸­çš„æ¬„ä½ä½”æ¯” */
            .product-item .field-group {
                flex-direction: row; /* ç”¢å“è¦æ ¼ (åç¨±/å°ºå¯¸/é¡è‰²) ä¿æŒä¸‰æ¬„ä½ˆå±€ */
                flex-wrap: wrap; 
            }
            .product-item .field-group > div {
                flex-basis: calc(33.33% - 7px); /* ä¸‰å€‹æ¬„ä½å¹³å‡åˆ†ä½ˆ (10px gap / 3) */
            }
            
            /* æ•¸é‡/ç·¨è™Ÿ/åƒ¹æ ¼æ¬„ä½åœ¨æ‰‹æ©Ÿä¸Šå‚ç›´å †ç–Š */
            .product-item .field-group:last-of-type {
                flex-direction: column; 
            }
            .product-item .field-group:last-of-type > div {
                flex-basis: 100%;
            }

            /* ç¸½è¨ˆå€å¡Š */
            .summary-row {
                font-size: 1rem;
            }
            .summary-row span:first-child {
                width: auto;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>å¯„è³£å–®å»ºç«‹</h1>

    <div class="field-group">
        <div style="flex: 0 0 50%;"> 
            <label for="ecom-select">é¸æ“‡é›»å•†åç¨±</label>
            <select id="ecom-select">
                <option value="">-- è«‹é¸æ“‡ --</option>
            </select>
        </div>
    </div>

    <hr>
    <h2>ç”¢å“æ¸…å–®</h2>
    <div id="product-list-container">
    </div>

    <button class="add-btn" id="add-product-btn">
        <i class="fa-solid fa-plus"></i> æ–°å¢ç”¢å“
    </button>

    <div id="summary-container">
        <div class="summary-row">
            <span>ç¸½æ•¸é‡å°è¨ˆ:</span> <span id="total-qty">0 ä»¶</span>
        </div>
        <div class="summary-row">
            <span>ç¸½é‡‘é¡å°è¨ˆ:</span> NT$ <span id="total-amount">0</span>
        </div>
    </div>

    <button class="submit-btn" id="submit-order-btn">
        æäº¤å¯„è³£å–®
    </button>
</div>

<script>
    // ã€é‡è¦ã€‘æ›¿æ›æˆæ‚¨çš„ Google Apps Script éƒ¨ç½² URL
    const API_URL = "https://script.google.com/macros/s/AKfycbyKANC6RockaftLdI114N5_OPkqlTZFcU9x5UHFsX7O0nneICwAW4-G0kR0zgu9Gh0iwA/exec"; 
    
    let allProductsData = []; 
    let cart = [];            

    // DOM å…ƒç´ 
    const ecomSelect = document.getElementById('ecom-select');
    const productListContainer = document.getElementById('product-list-container');
    const addProductBtn = document.getElementById('add-product-btn');
    const submitOrderBtn = document.getElementById('submit-order-btn');
    const totalAmountSpan = document.getElementById('total-amount');
    const totalQtySpan = document.getElementById('total-qty'); 

    // ========== åˆå§‹åŒ–è¼‰å…¥è³‡æ–™ ==========

    async function loadInitialData() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();

            if (data.status === 'success') {
                allProductsData = data.products;
                const ecomNames = Object.keys(data.ecomMap); 

                ecomNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    ecomSelect.appendChild(option);
                });

                addProductItem();
            } else {
                alert('è¼‰å…¥è³‡æ–™å¤±æ•—: ' + data.message);
            }
        } catch (error) {
            console.error('API éŒ¯èª¤:', error);
            alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Apps Script URLã€‚');
        }
    }

    // ========== æ ¸å¿ƒé‚è¼¯å‡½å¼ ==========

    function calculateTotal() {
        // åªè¨ˆç®—æœ‰æ•ˆçš„ (item.price > 0) é …ç›®
        const validCart = cart.filter(item => item.price > 0);
        
        const totalAmount = validCart.reduce((sum, item) => sum + item.price, 0); 
        const totalQty = validCart.length; // æ•¸é‡å°±æ˜¯æœ‰æ•ˆç”¢å“çš„æ•¸é‡ (å› ç‚ºæ¯å€‹æ•¸é‡éƒ½æ˜¯ 1)
        
        totalAmountSpan.textContent = totalAmount.toLocaleString('zh-TW');
        totalQtySpan.textContent = totalQty.toLocaleString('zh-TW') + ' ä»¶'; 
    }
    
    // æ¸²æŸ“å–®ä¸€ç”¢å“é …ç›®
    function renderProductItem(index) {
        const item = cart[index];
        const productItemDiv = document.createElement('div');
        productItemDiv.className = 'product-item';
        productItemDiv.dataset.index = index;

        // å–å¾—æ‰€æœ‰å”¯ä¸€çš„ç”¢å“åç¨±ï¼Œä¸¦éæ¿¾æ‰æ•¸é‡=0çš„å“é …
        const availableProducts = [...new Set(
            allProductsData
                .filter(p => p['æ•¸é‡'] > 0) 
                .map(p => p['ç”¢å“åç¨±'])
        )].sort();

        // ç”¢å“åç¨±ä¸‹æ‹‰é¸å–®
        const productOptions = availableProducts.map(name => 
            `<option value="${name}" ${item.name === name ? 'selected' : ''}>${name}</option>`
        ).join('');
        
        // ç¯©é¸å‡ºç›®å‰é¸å®šç”¢å“çš„å¯ç”¨è¦æ ¼
        const filteredSpecs = allProductsData.filter(p => 
            p['ç”¢å“åç¨±'] === item.name && p['æ•¸é‡'] > 0
        );

        // å–å¾—è©²ç”¢å“çš„å”¯ä¸€å°ºå¯¸å’Œé¡è‰²
        const sizes = [...new Set(filteredSpecs.map(p => p['å°ºå¯¸'] || 'ç„¡å°ºå¯¸'))].sort();
        const colors = [...new Set(filteredSpecs.map(p => p['é¡è‰²'] || 'ç„¡é¡è‰²'))].sort();

        // å°ºå¯¸ä¸‹æ‹‰é¸å–®
        const sizeOptions = sizes.map(size => 
            `<option value="${size}" ${item.size === size ? 'selected' : ''}>${size}</option>`
        ).join('');

        // é¡è‰²ä¸‹æ‹‰é¸å–®
        const colorOptions = colors.map(color => 
            `<option value="${color}" ${item.color === color ? 'selected' : ''}>${color}</option>`
        ).join('');


        productItemDiv.innerHTML = `
            <h3>ç”¢å“é …ç›® #${index + 1}</h3>
            <div class="field-group">
                <div>
                    <label>ç”¢å“åç¨±</label>
                    <select class="product-name-select">
                        <option value="">-- è«‹é¸æ“‡ç”¢å“ --</option>
                        ${productOptions}
                    </select>
                </div>
                <div>
                    <label>å°ºå¯¸ (åº«å­˜ > 0)</label>
                    <select class="size-select" ${!item.name ? 'disabled' : ''}>
                        <option value="">-- è«‹é¸æ“‡å°ºå¯¸ --</option>
                        ${sizeOptions}
                    </select>
                </div>
                <div>
                    <label>é¡è‰² (åº«å­˜ > 0)</label>
                    <select class="color-select" ${!item.size ? 'disabled' : ''}>
                        <option value="">-- è«‹é¸æ“‡é¡è‰² --</option>
                        ${colorOptions}
                    </select>
                </div>
            </div>
            
            <div class="field-group">
                <div>
                    <label>ç”¢å“ç·¨è™Ÿ</label>
                    <input type="text" class="item-no-input" readonly value="${item.itemNo || ''}" placeholder="é¸å®šè¦æ ¼å¾Œè‡ªå‹•å¸¶å…¥">
                </div>
                <div>
                    <label>æ•¸é‡</label> 
                    <input type="number" class="qty-input" min="1" max="1" value="1" readonly>
                </div>
                <div>
                    <label>åƒ¹æ ¼</label>
                    <input type="text" class="price-input" readonly value="${item.price.toLocaleString('zh-TW')}" placeholder="é¸å®šè¦æ ¼å¾Œè‡ªå‹•å¸¶å…¥">
                </div>
            </div>

            <div class="product-actions">
                <button class="remove-btn" data-index="${index}">
                    <i class="fa-solid fa-trash"></i> åˆªé™¤
                </button>
            </div>
        `;
        
        // æ›¿æ›ç¾æœ‰çš„å…ƒç´ æˆ–æ–°å¢åˆ°å®¹å™¨
        const existingDiv = productListContainer.querySelector(`[data-index="${index}"]`);
        if (existingDiv) {
            productListContainer.replaceChild(productItemDiv, existingDiv);
        } else {
            productListContainer.appendChild(productItemDiv);
        }
        
        // ç¶å®šäº‹ä»¶ç›£è½å™¨
        bindProductItemEvents(productItemDiv);
    }

    function bindProductItemEvents(productItemDiv) {
        const index = parseInt(productItemDiv.dataset.index);
        const nameSelect = productItemDiv.querySelector('.product-name-select');
        const sizeSelect = productItemDiv.querySelector('.size-select');
        const colorSelect = productItemDiv.querySelector('.color-select');
        const removeBtn = productItemDiv.querySelector('.remove-btn');

        // ç”¢å“åç¨±è®Šæ›´
        nameSelect.addEventListener('change', () => {
            cart[index].name = nameSelect.value;
            cart[index].size = '';
            cart[index].color = '';
            cart[index].itemNo = '';
            cart[index].price = 0;
            cart[index].qty = 1; 
            renderProductItem(index); 
            calculateTotal();
        });

        // å°ºå¯¸è®Šæ›´
        sizeSelect.addEventListener('change', () => {
            cart[index].size = sizeSelect.value;
            cart[index].color = ''; 
            updateItemDetails(index);
        });

        // é¡è‰²è®Šæ›´
        colorSelect.addEventListener('change', () => {
            cart[index].color = colorSelect.value;
            updateItemDetails(index);
        });
        
        // åˆªé™¤æŒ‰éˆ•
        removeBtn.addEventListener('click', () => {
            removeProductItem(index);
        });
    }

    function updateItemDetails(index) {
        const item = cart[index];
        
        const matchedItem = allProductsData.find(p => 
            p['ç”¢å“åç¨±'] === item.name &&
            (p['å°ºå¯¸'] || 'ç„¡å°ºå¯¸') === item.size &&
            (p['é¡è‰²'] || 'ç„¡é¡è‰²') === item.color
        );
        
        const itemDiv = productListContainer.querySelector(`[data-index="${index}"]`);
        const itemNoInput = itemDiv.querySelector('.item-no-input');
        const priceInput = itemDiv.querySelector('.price-input');
        
        if (matchedItem) {
            item.itemNo = matchedItem['ç”¢å“ç·¨è™Ÿ'];
            item.price = parseInt(matchedItem['åƒ¹æ ¼'].toString().replace(/\D/g, '')) || 0; 
            
            itemNoInput.value = item.itemNo;
            priceInput.value = item.price.toLocaleString('zh-TW');
            item.qty = 1; 
        } else {
            item.itemNo = '';
            item.price = 0;
            itemNoInput.value = '';
            priceInput.value = '';
            item.qty = 0; 
        }
        
        renderProductItem(index);
        calculateTotal();
    }
    
    // ========== å‹•ä½œå‡½å¼ ==========

    function addProductItem() {
        const newItem = {
            name: '',
            size: '',
            color: '',
            itemNo: '',
            qty: 0, 
            price: 0
        };
        cart.push(newItem);
        renderProductItem(cart.length - 1);
        calculateTotal();
    }

    function removeProductItem(index) {
        cart.splice(index, 1);
        
        productListContainer.innerHTML = '';
        cart.forEach((_, i) => renderProductItem(i));
        calculateTotal();
        
        if (cart.length === 0) {
            addProductItem();
        }
    }
    
    async function submitOrder() {
        if (!ecomSelect.value) {
            alert('è«‹é¸æ“‡é›»å•†åç¨±ï¼');
            ecomSelect.focus();
            return;
        }
        
        const validCart = cart.filter(item => item.itemNo && item.price > 0);
        if (validCart.length === 0) {
            alert('è³¼ç‰©è»Šä¸­æ²’æœ‰æœ‰æ•ˆçš„ç”¢å“é …ç›®ï¼è«‹é¸æ“‡å®Œæ•´çš„ç”¢å“è¦æ ¼ã€‚');
            return;
        }

        submitOrderBtn.disabled = true;
        submitOrderBtn.textContent = 'æäº¤ä¸­...';

        const totalAmount = validCart.reduce((sum, item) => sum + item.price, 0); 
        
        const payload = {
            ecomName: ecomSelect.value,
            totalAmount: totalAmount,
            cartItems: validCart
        };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain' 
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.status === "success") {
                alert(`ğŸ‰ å¯„è³£å–®æäº¤æˆåŠŸï¼è¨‚å–®ç·¨è™Ÿ: ${result.orderId}ã€‚ç¸½é‡‘é¡: NT$${totalAmount.toLocaleString('zh-TW')}`);
                
                // é‡ç½®è¡¨å–®
                ecomSelect.value = '';
                cart = [];
                productListContainer.innerHTML = '';
                addProductItem(); 
                calculateTotal();

            } else {
                alert('è¨‚å–®æäº¤å¤±æ•—ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚éŒ¯èª¤: ' + result.message);
            }

        } catch (error) {
            console.error('API å‘¼å«å¤±æ•—:', error);
            alert('ç¶²è·¯é€£ç·šéŒ¯èª¤æˆ–å¾Œå°æœå‹™ç„¡æ³•é€£æ¥ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        } finally {
            submitOrderBtn.disabled = false;
            submitOrderBtn.textContent = 'æäº¤å¯„è³£å–®';
        }
    }

    // ========== ç¶å®šèˆ‡åˆå§‹åŒ– ==========
    
    addProductBtn.addEventListener('click', addProductItem);
    submitOrderBtn.addEventListener('click', submitOrder);

    // åˆå§‹åŒ–è¼‰å…¥
    loadInitialData();

</script>
</body>
</html>
