<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“æ•¸é‡å°è¨ˆå ±è¡¨ (å·²ä¿®æ­£JSONæ ¼å¼)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .quantity-total { text-align: right; font-weight: bold; }
        .grand-total { background-color: #e0e0e0; font-weight: bold; }
        #controls { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; }
    </style>
</head>
<body>

    <div id="loading-message">
        <h1>ç”¢å“æ•¸é‡å°è¨ˆå ±è¡¨</h1>
        <p>æ­£åœ¨å¾ Google Apps Script è¼‰å…¥è³‡æ–™...</p>
    </div>
    
    <div id="controls" style="display: none;">
        <label for="productSearch">ç”¢å“åç¨±é—œéµå­—æœå°‹:</label>
        <input type="text" id="productSearch" placeholder="ç•™ç©ºå‰‡é¡¯ç¤ºå…¨éƒ¨ç”¢å“..." style="width: 300px; padding: 5px;">
        <button onclick="handleSearch()" style="padding: 5px 10px;">åŸ·è¡Œæœå°‹/é‡æ–°è¨ˆç®—</button>
        <p id="filter-status" style="margin-top: 10px; font-weight: bold;"></p>
        <hr>
    </div>

    <div id="report-container">
        </div>

    <script>
        // ğŸš¨ Apps Script åŸ·è¡Œç¶²å€
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKANC6RockaftLdI114N5_OPkqlTZFcU9x5UHFsX7O0nneICwAW4-G0kR0zgu9Gh0iwA/exec';

        // ğŸš¨ ä¿®æ­£ï¼šä½¿ç”¨æ¬„ä½åç¨± (JSON Key) ä¾†å­˜å–è³‡æ–™
        const KEY_PRODUCT_NAME = 'ç”¢å“åç¨±';
        const KEY_SIZE = 'å°ºå¯¸';
        const KEY_COLOR = 'é¡è‰²';
        const KEY_QUANTITY = 'æ•¸é‡'; 
        
        // å…¨åŸŸè®Šæ•¸
        let allDataRows = []; // å„²å­˜æ‰€æœ‰è³‡æ–™ç‰©ä»¶
        let headers = {};     // å„²å­˜æ¬„ä½æ¨™é ­ (ç”¨æ–¼å ±è¡¨æ¨™é¡Œé¡¯ç¤º)

        // --- è³‡æ–™è™•ç†å‡½å¼ ---

        /** ä¾æ“šæŒ‡å®šçš„æ¬„ä½åç¨± (KEY) å°è³‡æ–™é€²è¡Œåˆ†çµ„åŠ ç¸½ã€‚
         * @param {Array<Object>} dataRows - è³‡æ–™ç‰©ä»¶é™£åˆ—ã€‚
         * @param {Array<string>} groupingKeys - ç”¨æ–¼åˆ†çµ„çš„æ¬„ä½åç¨± (e.g., ['ç”¢å“åç¨±', 'é¡è‰²'])ã€‚
         * @returns {Object} - ä»¥ 'åˆ†çµ„éµ' ç‚ºéµï¼Œ'å°è¨ˆæ•¸é‡' ç‚ºå€¼çš„ç‰©ä»¶ã€‚
         */
        function aggregateData(dataRows, groupingKeys) {
            const summary = {};
            for (let i = 0; i < dataRows.length; i++) {
                const row = dataRows[i];
                
                // ä¿®æ­£ï¼šå¾ç‰©ä»¶ä¸­å–å¾—æ•¸é‡
                const quantity = parseInt(row[KEY_QUANTITY]) || 0;
                if (quantity === 0) continue; 

                // ä¿®æ­£ï¼šå¾ç‰©ä»¶ä¸­å–å¾—åˆ†çµ„å€¼ï¼Œä¸¦å»ºç«‹åˆ†çµ„ç”¨çš„å”¯ä¸€éµå€¼
                const keyParts = groupingKeys.map(key => String(row[key] || ''));
                const key = keyParts.join(' | ');

                summary[key] = (summary[key] || 0) + quantity;
            }
            return summary;
        }

        /** ç”¢ç”Ÿå ±è¡¨è¡¨æ ¼çš„ HTML å…§å®¹ã€‚ (é‚è¼¯ä¸è®Šï¼Œä½†å‚³å…¥çš„ headerLabels ç¾åœ¨æ˜¯å­—ä¸²é™£åˆ—)*/
        function createReportTable(title, summaryData, headerLabels) {
            let html = `<h2>${title}</h2>`;
            html += '<table><thead><tr>';
            
            // åŠ å…¥åˆ†çµ„æ¬„ä½æ¨™é ­
            headerLabels.forEach(label => {
                html += `<th>${label}</th>`;
            });
            html += '<th>æ•¸é‡å°è¨ˆ</th></tr></thead><tbody>';

            // ä¾éµå€¼æ’åº
            const sortedKeys = Object.keys(summaryData).sort();
            let grandTotal = 0;

            sortedKeys.forEach(key => {
                const keyParts = key.split(' | ');
                const total = summaryData[key];
                grandTotal += total;
                
                html += '<tr>';
                // åŠ å…¥åˆ†çµ„å€¼
                keyParts.forEach(part => {
                     html += `<td>${part}</td>`;
                });
                // åŠ å…¥æ•¸é‡å°è¨ˆ
                html += `<td class="quantity-total">${total}</td>`;
                html += '</tr>';
            });
            
            // åŠ å…¥ç¸½è¨ˆåˆ—
            html += '<tr>';
            html += `<td colspan="${headerLabels.length}" style="text-align: right;" class="grand-total">ç¸½è¨ˆ (Grand Total):</td>`;
            html += `<td class="quantity-total grand-total">${grandTotal}</td>`;
            html += '</tr>';

            html += '</tbody></table><br>';
            return html;
        }

        // --- å ±è¡¨ç”Ÿæˆèˆ‡æ§åˆ¶å‡½å¼ ---

        /**
         * æ ¹æ“šæœå°‹é—œéµå­—ç”Ÿæˆå ±è¡¨ã€‚
         * @param {string} searchTerm - ç”¢å“åç¨±çš„é—œéµå­—ã€‚
         */
        function generateReport(searchTerm) {
            const reportContainer = document.getElementById('report-container');
            const filterStatus = document.getElementById('filter-status');
            
            if (allDataRows.length === 0) {
                reportContainer.innerHTML = '<p style="color: red;">éŒ¯èª¤ï¼šè³‡æ–™å°šæœªè¼‰å…¥æˆ–ç‚ºç©ºã€‚</p>';
                return;
            }

            // 1. ç¯©é¸è³‡æ–™
            const lowerCaseSearchTerm = searchTerm.trim().toLowerCase();
            let filteredDataRows = allDataRows;

            if (lowerCaseSearchTerm) {
                filteredDataRows = allDataRows.filter(row => {
                    // ä¿®æ­£ï¼šå¾ç‰©ä»¶ä¸­å–å¾—ç”¢å“åç¨±
                    const productName = String(row[KEY_PRODUCT_NAME] || '').toLowerCase(); 
                    return productName.includes(lowerCaseSearchTerm);
                });
                filterStatus.innerHTML = `ç¯©é¸çµæœ: æ‰¾åˆ° ${filteredDataRows.length} ç­†ç¬¦åˆé—œéµå­— **"${searchTerm}"** çš„è¨˜éŒ„ã€‚`;
            } else {
                filterStatus.innerHTML = `ç›®å‰é¡¯ç¤ºæ‰€æœ‰ **${allDataRows.length}** ç­†è¨˜éŒ„çš„å°è¨ˆã€‚`;
            }
            
            if (filteredDataRows.length === 0) {
                 reportContainer.innerHTML = `<h2>ç„¡çµæœ</h2><p>æ‰¾ä¸åˆ°ç¬¦åˆé—œéµå­— **"${searchTerm}"** çš„ç”¢å“åç¨±è¨˜éŒ„ã€‚</p>`;
                 return;
            }

            // 2. ç”Ÿæˆå ±è¡¨
            let reportHTML = '';
            
            // ç”±æ–¼ headers ç¾åœ¨æ˜¯ç‰©ä»¶çš„ keyï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ key ä¾†ç•¶ä½œæ¬„ä½åç¨±
            const headerProductName = KEY_PRODUCT_NAME;
            const headerColor = KEY_COLOR;
            const headerSize = KEY_SIZE;


            // 1. åŒå€‹ç”¢å“æ•¸é‡çš„å°è¨ˆ (Product Name)
            const summary1 = aggregateData(filteredDataRows, [KEY_PRODUCT_NAME]);
            reportHTML += createReportTable(
                '1. åŒå€‹ç”¢å“æ•¸é‡çš„å°è¨ˆ (æŒ‰ç”¢å“åç¨±)', 
                summary1, 
                [headerProductName]
            );

            // 2. åŒå€‹ç”¢å“åŒæ¨£é¡è‰²çš„å°è¨ˆ (Product Name + Color)
            const summary2 = aggregateData(filteredDataRows, [KEY_PRODUCT_NAME, KEY_COLOR]);
            reportHTML += createReportTable(
                '2. åŒå€‹ç”¢å“åŒæ¨£é¡è‰²çš„å°è¨ˆ (æŒ‰ç”¢å“åç¨±, é¡è‰²)', 
                summary2, 
                [headerProductName, headerColor]
            );

            // 3. åŒå€‹ç”¢å“åŒæ¨£å°ºå¯¸çš„å°è¨ˆ (Product Name + Size)
            const summary3 = aggregateData(filteredDataRows, [KEY_PRODUCT_NAME, KEY_SIZE]);
            reportHTML += createReportTable(
                '3. åŒå€‹ç”¢å“åŒæ¨£å°ºå¯¸çš„å°è¨ˆ (æŒ‰ç”¢å“åç¨±, å°ºå¯¸)', 
                summary3, 
                [headerProductName, headerSize]
            );

            // 4. åŒå€‹ç”¢å“åŒæ¨£å°ºå¯¸åŠé¡è‰²çš„å°è¨ˆ (Product Name + Size + Color)
            const summary4 = aggregateData(filteredDataRows, [KEY_PRODUCT_NAME, KEY_SIZE, KEY_COLOR]);
            reportHTML += createReportTable(
                '4. åŒå€‹ç”¢å“åŒæ¨£å°ºå¯¸åŠé¡è‰²çš„å°è¨ˆ (æŒ‰ç”¢å“åç¨±, å°ºå¯¸, é¡è‰²)', 
                summary4, 
                [headerProductName, headerSize, headerColor]
            );

            reportContainer.innerHTML = reportHTML;
        }
        
        /** è™•ç†æœå°‹æŒ‰éˆ•é»æ“Šäº‹ä»¶ */
        function handleSearch() {
            const searchTerm = document.getElementById('productSearch').value;
            generateReport(searchTerm);
        }

        /** é¦–æ¬¡è¼‰å…¥è³‡æ–™ä¸¦åˆå§‹åŒ–å ±è¡¨ */
        async function loadDataAndInitReport() {
            const loadingMessage = document.getElementById('loading-message');
            const controls = document.getElementById('controls');
            
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json(); 
                
                // æª¢æŸ¥è³‡æ–™æ˜¯å¦ç‚ºç‰©ä»¶é™£åˆ—ï¼Œä¸”éç©º
                if (!Array.isArray(data) || data.length === 0 || typeof data[0] !== 'object' || data[0] === null) {
                    loadingMessage.innerHTML = '<h1>ç”¢å“æ•¸é‡å°è¨ˆå ±è¡¨</h1><p style="color: red;">éŒ¯èª¤ï¼šApps Script å›å‚³çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢º (éæœ‰æ•ˆçš„ç‰©ä»¶é™£åˆ—)ã€‚</p>';
                    return;
                }

                // å„²å­˜è³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸ (æ•´å€‹é™£åˆ—éƒ½æ˜¯è³‡æ–™åˆ—)
                allDataRows = data; 
                
                // ç§»é™¤è¼‰å…¥ä¸­è¨Šæ¯ï¼Œé¡¯ç¤ºæ§åˆ¶é …
                loadingMessage.style.display = 'none';
                controls.style.display = 'block';

                if (allDataRows.length === 0) {
                     document.getElementById('report-container').innerHTML = '<h1>ç”¢å“æ•¸é‡å°è¨ˆå ±è¡¨</h1><p>è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œä½†æ²’æœ‰å¯è™•ç†çš„è¨˜éŒ„ã€‚</p>';
                    return;
                }

                // åˆå§‹ç”Ÿæˆå ±è¡¨ï¼ˆç„¡é—œéµå­—ç¯©é¸ï¼‰
                generateReport('');

            } catch (error) {
                console.error('Fetch error:', error);
                loadingMessage.innerHTML = `<h1>ç”¢å“æ•¸é‡å°è¨ˆå ±è¡¨</h1><p style="color: red;">éŒ¯èª¤ï¼šè¼‰å…¥è³‡æ–™å¤±æ•—ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ– Apps Script éƒ¨ç½²å’Œå›å‚³æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚</p><p>è©³ç´°éŒ¯èª¤: ${error.message}</p>`;
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        window.onload = loadDataAndInitReport;
    </script>
</body>
</html>