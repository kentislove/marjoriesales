<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“æ•¸é‡å°è¨ˆå ±è¡¨ (å¤šæ¢ä»¶æŸ¥è©¢)</title>
    <style>
        /* åŸºç¤è¨­å®š */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f8f8f8; /* æ·ºç°è‰²èƒŒæ™¯ */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        /* å®¹å™¨é™åˆ¶å¯¬åº¦ä¸¦å±…ä¸­ */
        #main-container {
            width: 100%;
            max-width: 1100px;
            padding: 20px;
            background-color: #ffffff; /* å…§å®¹å€åŸŸç™½è‰²èƒŒæ™¯ */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            margin: 20px 0;
            border-radius: 8px;
        }

        h1 {
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* æŸ¥è©¢æ§åˆ¶å€ */
        #controls {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            background-color: #f0f0f0; 
            border-radius: 6px;
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        #controls label { 
            font-weight: 600; 
            color: #555;
            flex-shrink: 0;
        }

        #controls input { 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            flex-grow: 1;
            min-width: 100px;
        }
        
        /* æŒ‰éˆ•ç¾åŒ– */
        #controls button { 
            padding: 10px 20px; 
            background-color: #4CAF50; /* ç¶ è‰²æˆ–æ‚¨å“ç‰Œçš„å¼·èª¿è‰² */
            color: white; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        #controls button:hover {
            background-color: #45a049;
        }

        #filter-status { 
            margin-top: 15px; 
            font-weight: 600; 
            color: #333;
        }

        /* å ±è¡¨æ ¼é¢¨æ ¼ */
        h2 {
            color: #007bff; /* è—è‰²ä½œç‚ºå ±è¡¨æ¨™é¡Œå¼·èª¿è‰² */
            margin-top: 30px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden; /* ç¢ºä¿åœ“è§’æ•ˆæœ */
        }
        
        th, td { 
            border: 1px solid #dee2e6; 
            padding: 12px 15px; 
            text-align: left; 
        }

        th { 
            background-color: #343a40; /* æ·±è‰²è¡¨é ­ */
            color: white;
            font-weight: 600; 
            position: sticky; /* å›ºå®šè¡¨é ­ */
            top: 0;
            z-index: 10;
        }
        
        /* æ–‘é¦¬ç´‹ */
        tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        tbody tr:hover {
            background-color: #e9ecef; /* æ»‘é¼ ç¶“éé«˜äº® */
        }

        .quantity-total { 
            text-align: right; 
            font-weight: bold; 
            background-color: #fff0f5; /* æ·ºç²‰è‰²å€åˆ†æ•¸é‡ */
        }

        .grand-total { 
            background-color: #ffc107; /* é»ƒè‰²å¼·èª¿ç¸½è¨ˆ */
            color: #333;
            font-weight: 700;
        }
        
        #loading-message {
            color: #dc3545;
            font-weight: bold;
            padding: 15px;
            border: 1px solid #f5c6cb;
            background-color: #f8d7da;
            border-radius: 4px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="main-container">

        <h1>ç”¢å“æ•¸é‡å°è¨ˆå ±è¡¨</h1>

        <div id="controls">
            <div class="filter-group">
                <div>
                    <label for="productSearch">ç”¢å“åç¨±é—œéµå­—:</label>
                    <input type="text" id="productSearch" placeholder="éƒ¨åˆ†åç¨±..." style="width: 200px;">
                </div>
                
                <div>
                    <label for="sizeSearch">å°ºå¯¸:</label>
                    <input type="text" id="sizeSearch" placeholder="ä¾‹å¦‚ï¼šS, M..." style="width: 80px;">
                </div>

                <div>
                    <label for="colorSearch">é¡è‰²:</label>
                    <input type="text" id="colorSearch" placeholder="ä¾‹å¦‚ï¼šé»‘, ç´…..." style="width: 100px;">
                </div>

                <button onclick="handleSearch()">åŸ·è¡Œæœå°‹/è¼‰å…¥è³‡æ–™</button>
            </div>
            
            <p id="filter-status"></p>
        </div>

        <div id="loading-message" style="display: none;">
            <p>æ­£åœ¨è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å€™...</p>
        </div>

        <div id="report-container">
            <p style="text-align: center; color: #6c757d;">è«‹è¼¸å…¥æ¢ä»¶ä¸¦é»æ“Šä¸Šæ–¹æŒ‰éˆ•è¼‰å…¥è³‡æ–™ä¸¦è¨ˆç®—å°è¨ˆã€‚</p>
        </div>
        
    </div> <script>
        // ğŸš¨ Apps Script åŸ·è¡Œç¶²å€ (è«‹ç¢ºèªæ˜¯å¦æ­£ç¢º)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKANC6RockaftLdI114N5_OPkqlTZFcU9x5UHFsX7O0nneICwAW4-G0kR0zgu9Gh0iwA/exec';

        // æ¬„ä½åç¨± (JSON Key) - ä¿æŒèˆ‡ä¸Šä¸€æ¬¡ä¿®æ­£ç‰ˆæœ¬ä¸€è‡´
        const KEY_PRODUCT_NAME = 'ç”¢å“åç¨±';
        const KEY_SIZE = 'å°ºå¯¸';
        const KEY_COLOR = 'é¡è‰²';
        const KEY_QUANTITY = 'æ•¸é‡'; 
        
        let allDataRows = []; 

        /** ä¾æ“šæŒ‡å®šçš„æ¬„ä½åç¨± (KEY) å°è³‡æ–™é€²è¡Œåˆ†çµ„åŠ ç¸½ã€‚ */
        function aggregateData(dataRows, groupingKeys) {
            const summary = {};
            for (const row of dataRows) {
                const quantity = parseInt(row[KEY_QUANTITY]) || 0;
                if (quantity === 0) continue; 

                const keyParts = groupingKeys.map(key => String(row[key] || ''));
                const key = keyParts.join(' | ');

                summary[key] = (summary[key] || 0) + quantity;
            }
            return summary;
        }

        /** ç”¢ç”Ÿå ±è¡¨è¡¨æ ¼çš„ HTML å…§å®¹ã€‚*/
        function createReportTable(title, summaryData, headerLabels) {
            let html = `<h2>${title}</h2>`;
            html += '<table><thead><tr>';
            
            headerLabels.forEach(label => {
                html += `<th>${label}</th>`;
            });
            html += '<th style="text-align: right;">æ•¸é‡å°è¨ˆ</th></tr></thead><tbody>';

            const sortedKeys = Object.keys(summaryData).sort();
            let grandTotal = 0;

            sortedKeys.forEach(key => {
                const keyParts = key.split(' | ');
                const total = summaryData[key];
                grandTotal += total;
                
                html += '<tr>';
                keyParts.forEach(part => {
                     html += `<td>${part}</td>`;
                });
                html += `<td class="quantity-total">${total}</td>`;
                html += '</tr>';
            });
            
            html += '<tr>';
            html += `<td colspan="${headerLabels.length}" style="text-align: right;" class="grand-total">ç¸½è¨ˆ (Grand Total):</td>`;
            html += `<td class="quantity-total grand-total">${grandTotal}</td>`;
            html += '</tr>';

            html += '</tbody></table><br>';
            return html;
        }

        /** è¼‰å…¥è³‡æ–™ (å¦‚æœå°šæœªè¼‰å…¥)ã€‚*/
        async function fetchData() {
            if (allDataRows.length > 0) {
                return true; 
            }
            
            const loadingMsg = document.getElementById('loading-message');
            loadingMsg.style.display = 'block';

            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json(); 
                
                if (!Array.isArray(data) || data.length === 0 || typeof data[0] !== 'object' || data[0] === null) {
                    throw new Error('Apps Script å›å‚³çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢º (éæœ‰æ•ˆçš„ç‰©ä»¶é™£åˆ—)ã€‚');
                }

                allDataRows = data; 
                loadingMsg.style.display = 'none';
                return true;

            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('report-container').innerHTML = `<p style="color: red;">è¼‰å…¥è³‡æ–™å¤±æ•—ã€‚è©³ç´°éŒ¯èª¤: ${error.message}</p>`;
                loadingMsg.style.display = 'none';
                return false;
            }
        }
        
        /** è™•ç†æœå°‹æŒ‰éˆ•é»æ“Šäº‹ä»¶ */
        async function handleSearch() {
            const container = document.getElementById('report-container');
            const status = document.getElementById('filter-status');
            
            // 1. è¼‰å…¥è³‡æ–™ (å¦‚æœå°šæœªè¼‰å…¥)
            status.innerHTML = 'æ­£åœ¨æª¢æŸ¥/è¼‰å…¥è³‡æ–™...';
            const dataLoaded = await fetchData();
            if (!dataLoaded) {
                status.innerHTML = 'è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Apps Script éƒ¨ç½²ã€‚';
                return;
            }
            if (allDataRows.length === 0) {
                 container.innerHTML = '<p>è³‡æ–™åº«ä¸­æ²’æœ‰è¨˜éŒ„ã€‚</p>';
                status.innerHTML = 'è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œä½†ç„¡è¨˜éŒ„ã€‚';
                return;
            }

            // 2. ç²å–æ‰€æœ‰ç¯©é¸æ¢ä»¶
            const searchProduct = document.getElementById('productSearch').value.trim().toLowerCase();
            const searchSize = document.getElementById('sizeSearch').value.trim().toLowerCase();
            const searchColor = document.getElementById('colorSearch').value.trim().toLowerCase();

            // 3. ç¯©é¸è³‡æ–™
            let filteredDataRows = allDataRows.filter(row => {
                const productName = String(row[KEY_PRODUCT_NAME] || '').toLowerCase();
                const size = String(row[KEY_SIZE] || '').toLowerCase();
                const color = String(row[KEY_COLOR] || '').toLowerCase();

                const productMatch = !searchProduct || productName.includes(searchProduct);
                const sizeMatch = !searchSize || size === searchSize; // å°ºå¯¸å’Œé¡è‰²ä½¿ç”¨ç²¾ç¢ºåŒ¹é…
                const colorMatch = !searchColor || color === searchColor;

                return productMatch && sizeMatch && colorMatch;
            });

            // 4. æ›´æ–°ç‹€æ…‹èˆ‡ç”Ÿæˆå ±è¡¨
            const filtersUsed = [
                searchProduct && `ç”¢å“åç¨±(é—œéµå­—): "${searchProduct}"`,
                searchSize && `å°ºå¯¸: "${searchSize}"`,
                searchColor && `é¡è‰²: "${searchColor}"`
            ].filter(Boolean).join('ï¼›') || 'ç„¡ç¯©é¸æ¢ä»¶';
            
            status.innerHTML = `ç¯©é¸æ¢ä»¶: ${filtersUsed} | æ‰¾åˆ° **${filteredDataRows.length}** ç­†è¨˜éŒ„ã€‚`;

            if (filteredDataRows.length === 0) {
                 container.innerHTML = `<h2>ç„¡çµæœ</h2><p style="color: #dc3545;">æ‰¾ä¸åˆ°ç¬¦åˆæ‚¨æ¢ä»¶çš„è¨˜éŒ„ã€‚</p>`;
                 return;
            }

            // 5. ç”Ÿæˆå››ç¨®å°è¨ˆå ±è¡¨
            let reportHTML = '';

            // 1. åŒå€‹ç”¢å“æ•¸é‡çš„å°è¨ˆ
            reportHTML += createReportTable(
                '1. åŒå€‹ç”¢å“æ•¸é‡çš„å°è¨ˆ (æŒ‰ç”¢å“åç¨±)', 
                aggregateData(filteredDataRows, [KEY_PRODUCT_NAME]), 
                [KEY_PRODUCT_NAME]
            );

            // 2. åŒå€‹ç”¢å“åŒæ¨£é¡è‰²çš„å°è¨ˆ
            reportHTML += createReportTable(
                '2. åŒå€‹ç”¢å“åŒæ¨£é¡è‰²çš„å°è¨ˆ (æŒ‰ç”¢å“åç¨±, é¡è‰²)', 
                aggregateData(filteredDataRows, [KEY_PRODUCT_NAME, KEY_COLOR]), 
                [KEY_PRODUCT_NAME, KEY_COLOR]
            );

            // 3. åŒå€‹ç”¢å“åŒæ¨£å°ºå¯¸çš„å°è¨ˆ
            reportHTML += createReportTable(
                '3. åŒå€‹ç”¢å“åŒæ¨£å°ºå¯¸çš„å°è¨ˆ (æŒ‰ç”¢å“åç¨±, å°ºå¯¸)', 
                aggregateData(filteredDataRows, [KEY_PRODUCT_NAME, KEY_SIZE]), 
                [KEY_PRODUCT_NAME, KEY_SIZE]
            );

            // 4. åŒå€‹ç”¢å“åŒæ¨£å°ºå¯¸åŠé¡è‰²çš„å°è¨ˆ
            reportHTML += createReportTable(
                '4. åŒå€‹ç”¢å“åŒæ¨£å°ºå¯¸åŠé¡è‰²çš„å°è¨ˆ (æŒ‰ç”¢å“åç¨±, å°ºå¯¸, é¡è‰²)', 
                aggregateData(filteredDataRows, [KEY_PRODUCT_NAME, KEY_SIZE, KEY_COLOR]), 
                [KEY_PRODUCT_NAME, KEY_SIZE, KEY_COLOR]
            );

            container.innerHTML = reportHTML;
        }
    </script>
</body>
</html>

