<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“æ•¸é‡å°è¨ˆå ±è¡¨</title>
    <style>
        /* åŸºç¤è¨­å®š */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f8f8f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        
        /* å®¹å™¨é™åˆ¶å¯¬åº¦ä¸¦å±…ä¸­ */
        #main-container {
            width: 100%;
            max-width: 1100px;
            padding: 20px;
            background-color: #ffffff; 
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            margin: 20px 0;
            border-radius: 8px;
        }

        h1 {
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* æŸ¥è©¢æ§åˆ¶å€ */
        #controls {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            background-color: #f0f0f0; 
            border-radius: 6px;
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        #controls label { 
            font-weight: 600; 
            color: #555;
            flex-shrink: 0;
        }

        #controls input { 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            flex-grow: 1;
            min-width: 100px;
        }
        
        /* æŒ‰éˆ•é¢¨æ ¼ */
        #controls button { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        
        /* æœå°‹æŒ‰éˆ• */
        #search-button {
            background-color: #4CAF50; /* ç¶ è‰² */
            color: white;
        }
        #search-button:hover {
            background-color: #45a049;
        }

        /* åˆ—å°æŒ‰éˆ• */
        #print-button {
            background-color: #007bff; /* è—è‰² */
            color: white;
            margin-left: 20px; /* å€éš”æœå°‹æŒ‰éˆ• */
        }
        #print-button:hover {
            background-color: #0056b3;
        }


        #filter-status { 
            margin-top: 15px; 
            font-weight: 600; 
            color: #333;
        }

        /* å ±è¡¨æ ¼é¢¨æ ¼ */
        h2 {
            color: #007bff;
            margin-top: 30px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        th, td { 
            border: 1px solid #dee2e6; 
            padding: 12px 15px; 
            text-align: left; 
        }

        th { 
            background-color: #343a40; 
            color: white;
            font-weight: 600; 
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* æ–‘é¦¬ç´‹ */
        tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        tbody tr:hover {
            background-color: #e9ecef;
        }

        .quantity-total { 
            text-align: right; 
            font-weight: bold; 
            background-color: #fff0f5; 
        }

        .grand-total { 
            background-color: #ffc107; 
            color: #333;
            font-weight: 700;
        }
        
        #loading-message {
            color: #dc3545;
            font-weight: bold;
            padding: 15px;
            border: 1px solid #f5c6cb;
            background-color: #f8d7da;
            border-radius: 4px;
            margin-top: 20px;
        }

        /* ****************************************************** */
        /* åˆ—å°å°ˆç”¨ CSS è¦å‰‡ (@media print) */
        /* ****************************************************** */
        @media print {
            body {
                background-color: #fff; /* åˆ—å°æ™‚èƒŒæ™¯è¨­ç‚ºç™½è‰² */
                margin: 0;
                padding: 0;
                /* å–æ¶ˆç½®ä¸­æ•ˆæœï¼Œä½¿ç”¨æ¨™æº–åˆ—å°ä½ˆå±€ */
                display: block; 
                width: 100%;
            }
            
            #main-container {
                box-shadow: none; /* ç§»é™¤é™°å½± */
                margin: 0;
                padding: 0;
                max-width: none;
                border: none;
            }

            /* éš±è—æ‰€æœ‰ä¸éœ€è¦åˆ—å°çš„å…ƒç´  (ä¾‹å¦‚æœå°‹æ¡†å’ŒæŒ‰éˆ•) */
            #controls, #loading-message, hr {
                display: none !important;
            }
            
            /* è®“æ¨™é¡Œå’Œå ±è¡¨æ›´å®¹æ˜“é–±è®€ */
            h1 {
                text-align: center;
                border-bottom: 1px solid #000;
            }

            /* ç¢ºä¿è¡¨æ ¼é¡è‰²å’Œé‚Šæ¡†åœ¨åˆ—å°æ™‚æ¸…æ™°å¯è¦‹ */
            table {
                box-shadow: none;
                border: 1px solid #000;
                page-break-inside: auto; /* å…è¨±è¡¨æ ¼åœ¨ä¸åŒé é¢é–“æ–·é–‹ */
            }
            
            tr {
                page-break-inside: avoid; /* é¿å…å–®è¡Œåœ¨é é¢é–“æ–·é–‹ */
                page-break-after: auto; 
            }
            
            /* ç¢ºä¿è¡¨é ­åœ¨æ¯é éƒ½é¡¯ç¤º */
            thead {
                display: table-header-group;
            }
            
            th, td {
                border-color: #000 !important;
                background-color: transparent !important; /* ç§»é™¤èƒŒæ™¯è‰²ï¼Œç¯€çœå¢¨æ°´ */
                color: #000 !important;
                padding: 8px 10px; /* ç¸®å°é‚Šè· */
            }

            .grand-total {
                border-top: 2px solid #000 !important;
            }
        }
    </style>
</head>
<body>

    <div id="main-container">

        <h1>ç”¢å“æ•¸é‡å°è¨ˆå ±è¡¨</h1>

        <div id="controls">
            <div class="filter-group">
                <div>
                    <label for="productSearch">ç”¢å“åç¨±é—œéµå­—:</label>
                    <input type="text" id="productSearch" placeholder="éƒ¨åˆ†åç¨±..." style="width: 200px;">
                </div>
                
                <div>
                    <label for="sizeSearch">å°ºå¯¸:</label>
                    <input type="text" id="sizeSearch" placeholder="ä¾‹å¦‚ï¼šS, M..." style="width: 80px;">
                </div>

                <div>
                    <label for="colorSearch">é¡è‰²:</label>
                    <input type="text" id="colorSearch" placeholder="ä¾‹å¦‚ï¼šé»‘, ç´…..." style="width: 100px;">
                </div>

                <button id="search-button" onclick="handleSearch()">åŸ·è¡Œæœå°‹/è¼‰å…¥è³‡æ–™</button>
                <button id="print-button" onclick="printReport()">åˆ—å°å ±è¡¨</button>
            </div>
            
            <p id="filter-status"></p>
        </div>

        <div id="loading-message" style="display: none;">
            <p>æ­£åœ¨è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å€™...</p>
        </div>

        <div id="report-container">
            <p style="text-align: center; color: #6c757d;">è«‹è¼¸å…¥æ¢ä»¶ä¸¦é»æ“Šä¸Šæ–¹æŒ‰éˆ•è¼‰å…¥è³‡æ–™ä¸¦è¨ˆç®—å°è¨ˆã€‚</p>
        </div>
        
    </div> <script>
        // ğŸš¨ Apps Script åŸ·è¡Œç¶²å€ (è«‹ç¢ºèªæ˜¯å¦æ­£ç¢º)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKANC6RockaftLdI114N5_OPkqlTZFcU9x5UHFsX7O0nneICwAW4-G0kR0zgu9Gh0iwA/exec';

        // æ¬„ä½åç¨± (JSON Key)
        const KEY_PRODUCT_NAME = 'ç”¢å“åç¨±';
        const KEY_SIZE = 'å°ºå¯¸';
        const KEY_COLOR = 'é¡è‰²';
        const KEY_QUANTITY = 'æ•¸é‡'; 
        
        let allDataRows = []; 

        /** ä¾æ“šæŒ‡å®šçš„æ¬„ä½åç¨± (KEY) å°è³‡æ–™é€²è¡Œåˆ†çµ„åŠ ç¸½ã€‚ */
        function aggregateData(dataRows, groupingKeys) {
            const summary = {};
            for (const row of dataRows) {
                const quantity = parseInt(row[KEY_QUANTITY]) || 0;
                if (quantity === 0) continue; 

                const keyParts = groupingKeys.map(key => String(row[key] || ''));
                const key = keyParts.join(' | ');

                summary[key] = (summary[key] || 0) + quantity;
            }
            return summary;
        }

        /** ç”¢ç”Ÿå ±è¡¨è¡¨æ ¼çš„ HTML å…§å®¹ã€‚*/
        function createReportTable(title, summaryData, headerLabels) {
            let html = `<h2>${title}</h2>`;
            html += '<table><thead><tr>';
            
            headerLabels.forEach(label => {
                html += `<th>${label}</th>`;
            });
            // ä¿®æ­£ï¼šå°‡è¡¨é ­çš„å°é½Šæ–¹å¼è¨­ç‚ºå³å°é½Šï¼Œèˆ‡å…§å®¹å°é½Š
            html += '<th style="text-align: right;">æ•¸é‡å°è¨ˆ</th></tr></thead><tbody>';

            const sortedKeys = Object.keys(summaryData).sort();
            let grandTotal = 0;

            sortedKeys.forEach(key => {
                const keyParts = key.split(' | ');
                const total = summaryData[key];
                grandTotal += total;
                
                html += '<tr>';
                keyParts.forEach(part => {
                     html += `<td>${part}</td>`;
                });
                html += `<td class="quantity-total">${total}</td>`;
                html += '</tr>';
            });
            
            html += '<tr>';
            html += `<td colspan="${headerLabels.length}" style="text-align: right;" class="grand-total">ç¸½è¨ˆ (Grand Total):</td>`;
            html += `<td class="quantity-total grand-total">${grandTotal}</td>`;
            html += '</tr>';

            html += '</tbody></table><br>';
            return html;
        }

        /** è¼‰å…¥è³‡æ–™ (å¦‚æœå°šæœªè¼‰å…¥)ã€‚*/
        async function fetchData() {
            if (allDataRows.length > 0) {
                return true; 
            }
            
            const loadingMsg = document.getElementById('loading-message');
            loadingMsg.style.display = 'block';

            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json(); 
                
                if (!Array.isArray(data) || data.length === 0 || typeof data[0] !== 'object' || data[0] === null) {
                    throw new Error('Apps Script å›å‚³çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢º (éæœ‰æ•ˆçš„ç‰©ä»¶é™£åˆ—)ã€‚');
                }

                allDataRows = data; 
                loadingMsg.style.display = 'none';
                return true;

            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('report-container').innerHTML = `<p style="color: red;">è¼‰å…¥è³‡æ–™å¤±æ•—ã€‚è©³ç´°éŒ¯èª¤: ${error.message}</p>`;
                loadingMsg.style.display = 'none';
                return false;
            }
        }
        
        /** è™•ç†æœå°‹æŒ‰éˆ•é»æ“Šäº‹ä»¶ */
        async function handleSearch() {
            const container = document.getElementById('report-container');
            const status = document.getElementById('filter-status');
            
            // 1. è¼‰å…¥è³‡æ–™ (å¦‚æœå°šæœªè¼‰å…¥)
            status.innerHTML = 'æ­£åœ¨æª¢æŸ¥/è¼‰å…¥è³‡æ–™...';
            const dataLoaded = await fetchData();
            if (!dataLoaded) {
                status.innerHTML = 'è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Apps Script éƒ¨ç½²ã€‚';
                return;
            }
            if (allDataRows.length === 0) {
                 container.innerHTML = '<p>è³‡æ–™åº«ä¸­æ²’æœ‰è¨˜éŒ„ã€‚</p>';
                status.innerHTML = 'è³‡æ–™è¼‰å…¥æˆåŠŸï¼Œä½†ç„¡è¨˜éŒ„ã€‚';
                return;
            }

            // 2. ç²å–æ‰€æœ‰ç¯©é¸æ¢ä»¶
            const searchProduct = document.getElementById('productSearch').value.trim().toLowerCase();
            const searchSize = document.getElementById('sizeSearch').value.trim().toLowerCase();
            const searchColor = document.getElementById('colorSearch').value.trim().toLowerCase();

            // 3. ç¯©é¸è³‡æ–™
            let filteredDataRows = allDataRows.filter(row => {
                const productName = String(row[KEY_PRODUCT_NAME] || '').toLowerCase();
                const size = String(row[KEY_SIZE] || '').toLowerCase();
                const color = String(row[KEY_COLOR] || '').toLowerCase();

                const productMatch = !searchProduct || productName.includes(searchProduct);
                const sizeMatch = !searchSize || size === searchSize;
                const colorMatch = !searchColor || color === searchColor;

                return productMatch && sizeMatch && colorMatch;
            });

            // 4. æ›´æ–°ç‹€æ…‹èˆ‡ç”Ÿæˆå ±è¡¨
            const filtersUsed = [
                searchProduct && `ç”¢å“åç¨±(é—œéµå­—): "${searchProduct}"`,
                searchSize && `å°ºå¯¸: "${searchSize}"`,
                searchColor && `é¡è‰²: "${searchColor}"`
            ].filter(Boolean).join('ï¼›') || 'ç„¡ç¯©é¸æ¢ä»¶';
            
            status.innerHTML = `ç¯©é¸æ¢ä»¶: ${filtersUsed} | æ‰¾åˆ° **${filteredDataRows.length}** ç­†è¨˜éŒ„ã€‚`;

            if (filteredDataRows.length === 0) {
                 container.innerHTML = `<h2>ç„¡çµæœ</h2><p style="color: #dc3545;">æ‰¾ä¸åˆ°ç¬¦åˆæ‚¨æ¢ä»¶çš„è¨˜éŒ„ã€‚</p>`;
                 return;
            }

            // 5. ç”Ÿæˆå››ç¨®å°è¨ˆå ±è¡¨
            let reportHTML = '';

            // 1. åŒå€‹ç”¢å“æ•¸é‡çš„å°è¨ˆ
            reportHTML += createReportTable(
                '1. åŒå€‹ç”¢å“æ•¸é‡çš„å°è¨ˆ (æŒ‰ç”¢å“åç¨±)', 
                aggregateData(filteredDataRows, [KEY_PRODUCT_NAME]), 
                [KEY_PRODUCT_NAME]
            );

            // 2. åŒå€‹ç”¢å“åŒæ¨£é¡è‰²çš„å°è¨ˆ
            reportHTML += createReportTable(
                '2. åŒå€‹ç”¢å“åŒæ¨£é¡è‰²çš„å°è¨ˆ (æŒ‰ç”¢å“åç¨±, é¡è‰²)', 
                aggregateData(filteredDataRows, [KEY_PRODUCT_NAME, KEY_COLOR]), 
                [KEY_PRODUCT_NAME, KEY_COLOR]
            );

            // 3. åŒå€‹ç”¢å“åŒæ¨£å°ºå¯¸çš„å°è¨ˆ
            reportHTML += createReportTable(
                '3. åŒå€‹ç”¢å“åŒæ¨£å°ºå¯¸çš„å°è¨ˆ (æŒ‰ç”¢å“åç¨±, å°ºå¯¸)', 
                aggregateData(filteredDataRows, [KEY_PRODUCT_NAME, KEY_SIZE]), 
                [KEY_PRODUCT_NAME, KEY_SIZE]
            );

            // 4. åŒå€‹ç”¢å“åŒæ¨£å°ºå¯¸åŠé¡è‰²çš„å°è¨ˆ
            reportHTML += createReportTable(
                '4. åŒå€‹ç”¢å“åŒæ¨£å°ºå¯¸åŠé¡è‰²çš„å°è¨ˆ (æŒ‰ç”¢å“åç¨±, å°ºå¯¸, é¡è‰²)', 
                aggregateData(filteredDataRows, [KEY_PRODUCT_NAME, KEY_SIZE, KEY_COLOR]), 
                [KEY_PRODUCT_NAME, KEY_SIZE, KEY_COLOR]
            );

            container.innerHTML = reportHTML;
        }

        /** åˆ—å°åŠŸèƒ½ */
        function printReport() {
            // window.print() å‘¼å«ç³»çµ±åˆ—å°å°è©±æ¡†ï¼Œé©ç”¨æ–¼æ‰€æœ‰ç€è¦½å™¨/è£ç½®
            window.print();
        }
    </script>
</body>
</html>

